---
title: Deploying a PostgreSQL Cluster with TLS on KubeBlocks
description: Learn how to deploy a PostgreSQL cluster with TLS encryption on KubeBlocks for secure communication. This guide covers deployment configuration, secure connections, and resource cleanup.
keywords: [KubeBlocks, PostgreSQL, Kubernetes, TLS, Secure Communication]
sidebar_position: 1
sidebar_label: PostgreSQL Cluster with TLS
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Deploying a PostgreSQL Cluster with TLS on KubeBlocks

This guide demonstrates how to deploy a PostgreSQL cluster with **TLS encryption** using KubeBlocks. TLS ensures secure communication between the PostgreSQL client and server by encrypting data in transit, protecting sensitive information. You will learn how to deploy the cluster, connect securely using TLS, and clean up resources after testing.

## Prerequisites

Before proceeding, ensure the following:
- Environment Setup:
    - A Kubernetes cluster is up and running.
    - The kubectl CLI tool is configured to communicate with your cluster.
    - KubeBlocks CLI and KubeBlocks Operator are installed. Follow the installation instructions here.
- Namespace Preparation: To keep resources isolated, create a dedicated namespace for this tutorial:

```bash
$ kubectl create ns demo
namespace/demo created
```

## Deploying the PostgreSQL Replication Cluster

KubeBlocks uses a declarative approach for managing PostgreSQL clusters. Below is an example configuration for deploying a PostgreSQL cluster with 2 replicas (1 primary, 1 replicas) with TLS enabled.

Apply the following YAML configuration:

```yaml
apiVersion: apps.kubeblocks.io/v1
kind: Cluster
metadata:
  name: pg-cluster
  namespace: demo
spec:
  terminationPolicy: Delete
  clusterDef: postgresql
  topology: replication
  componentSpecs:
    - name: postgresql
      serviceVersion: 16.4.0
      tls: true  # enable tls
      issuer:    # set issuer to kubeblocks
        name: KubeBlocks
      labels:
        apps.kubeblocks.postgres.patroni/scope: pg-cluster-postgresql
      disableExporter: true
      replicas: 2
      resources:
        limits:
          cpu: "0.5"
          memory: "0.5Gi"
        requests:
          cpu: "0.5"
          memory: "0.5Gi"
      volumeClaimTemplates:
        - name: data
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
```

**Explanation of Key Fields**
- `tls: true`: Enables TLS encryption for secure communication.
- `issuer: KubeBlocks`: Uses KubeBlocks' default built-in certificate issuer for TLS. It only allows two enum values: `KubeBlocks` and `UserProvided`.

## Verifying the Deployment
Monitor the cluster status until it transitions to the Running state:
```bash
$ kubectl get cluster pg-cluster -n demo -w
```

Example Output::

```bash
NAME         CLUSTER-DEFINITION   TERMINATION-POLICY   STATUS     AGE
pg-cluster   postgresql           Delete               Creating   50s
pg-cluster   postgresql           Delete               Running    4m2s
```
Once the cluster status becomes Running, your PostgreSQL cluster is ready for use.

Verify SSL configuration on both replicas:

```sql
postgres=# show ssl;
 ssl
-----
 on
(1 row)

postgres=# show ssl_ca_file;
     ssl_ca_file
---------------------
 /etc/pki/tls/ca.pem
(1 row)

postgres=# show ssl_cert_file;
     ssl_cert_file
-----------------------
 /etc/pki/tls/cert.pem
(1 row)

postgres=# show ssl_key_file;
     ssl_key_file
----------------------
 /etc/pki/tls/key.pem
(1 row)
```

Verify tls certs generated by KubeBlocks:
```bash
kubectl get secret -l app.kubernetes.io/instance=pg-cluster -n demo | grep tls
```

Example Output:

```bash
pg-cluster-postgresql-tls-certs                  Opaque   3      24m
```

## Connect to PostgreSQL Cluster

### Step 1: Retrieve the Root Credentials

KubeBlocks creates a Secret named `pg-cluster-postgresql-account-postgres` containing PostgreSQL postgres credentials.

Retrieve credentials:

```bash
NAME=`kubectl get secret -n demo pg-cluster-postgresql-account-postgres -o jsonpath='{.data.username}' | base64 --decode`
PASSWD=`kubectl get secret -n demo pg-cluster-postgresql-account-postgres -o jsonpath='{.data.password}' | base64 --decode`
```

### Step 2: Connect to PostgreSQL Securely Using TLS
Use the PostgreSQL client to connect securely with TLS enabled. The 'sslmode' option enforces the use of TLS for encryption.

Forward PostgreSQL port to localhost:

```bash
$ kubectl port-forward svc/pg-cluster-postgresql-postgresql 5432:5432 -n demo
Forwarding from 127.0.0.1:5432 -> 5432
Forwarding from [::1]:5432 -> 5432
```

<Tabs>
<TabItem value="require" label="sslmode-require" default>
```bash
psql "host=127.0.0.1 dbname=postgres user=${NAME} password=${PASSWD} sslmode=require"
```

Sample Output:
```bash
SSL connection (protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, compression: off, ALPN: none)
Type "help" for help.

postgres=#
```

It shows `SSL connection` in command line.

</TabItem>

<TabItem value="require" label="sslmode=verify-full">

Retrieve root cert from secret and save it to `/tmp/ca.crt`
```bash
kubectl get -n demo secrets pg-cluster-postgresql-tls-certs -oyaml | yq '.data."ca.pem"' | base64 -d > /tmp/ca.crt
```

Connect with `ssl-mode=verify-full`

```bash
psql "host=127.0.0.1 dbname=postgres user=${NAME} password=${PASSWD} sslmode=verify-full sslrootcert=/tmp/ca.crt"
```

Sample Output:
```bash
SSL connection (protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, compression: off, ALPN: none)
Type "help" for help.

postgres=#
```

It shows `SSL connection` in command line.

</TabItem>
</Tabs>

## Cleanup
To remove all resources created in this tutorial, run the following commands:
```bash
kubectl delete cluster pg-cluster -n demo
kubectl delete ns demo
```

## Summary
In this guide, you learned how to:
- Deploy a PostgreSQL cluster using KubeBlocks and enable TLS encryption for secure communication between the PostgreSQL client and server.
- Establish a secure PostgreSQL connection with TLS.
- Verify the secure connection using the PostgreSQL shell.

TLS encryption ensures secure communication by encrypting data in transit and protecting sensitive information. By following these steps, you can deploy a secure PostgreSQL cluster on Kubernetes with ease using KubeBlocks.



