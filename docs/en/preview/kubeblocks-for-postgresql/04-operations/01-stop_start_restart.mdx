---
title: PostgreSQL Cluster Lifecycle Management (Stop, Start, Restart)
description: Learn how to manage PostgreSQL cluster states in KubeBlocks including stopping, starting, and restarting operations to optimize resources.
keywords: [KubeBlocks, PostgreSQL, Cluster Management, Stop, Start, Restart]
sidebar_position: 1
sidebar_label: Lifecycle Management
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# PostgreSQL Cluster Lifecycle Management

This guide demonstrates how to manage a PostgreSQL cluster's operational state in **KubeBlocks**, including:

- Stopping the cluster to conserve resources
- Starting a stopped cluster
- Restarting cluster components

These operations help optimize resource usage and reduce operational costs in Kubernetes environments.

## Prerequisites

Before proceeding, ensure the following:
- Environment Setup:
    - A Kubernetes cluster is up and running.
    - The kubectl CLI tool is configured to communicate with your cluster.
    - KubeBlocks CLI and KubeBlocks Operator are installed.
- Namespace Preparation: To keep resources isolated, create a dedicated namespace for this tutorial:

```bash
$ kubectl create ns demo
namespace/demo created
```

## Deploy a PostgreSQL Replication Cluster

KubeBlocks manages PostgreSQL clusters declaratively. The following YAML deploys a cluster with 2 replicas (1 primary, 1 replica):

```yaml
apiVersion: apps.kubeblocks.io/v1
kind: Cluster
metadata:
  name: pg-cluster
  namespace: demo
spec:
  terminationPolicy: Delete
  clusterDef: postgresql
  topology: replication
  componentSpecs:
    - name: postgresql
      serviceVersion: 16.4.0
      labels:
        apps.kubeblocks.postgres.patroni/scope: pg-cluster-postgresql
      disableExporter: true
      replicas: 2
      resources:
        limits:
          cpu: "0.5"
          memory: "0.5Gi"
        requests:
          cpu: "0.5"
          memory: "0.5Gi"
      volumeClaimTemplates:
        - name: data
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
```

## Verify the Deployment

Check the cluster status until it reaches the Running state:
```bash
$ kubectl get cluster pg-cluster -n demo -w
```

Example output:

```bash
NAME         CLUSTER-DEFINITION   TERMINATION-POLICY   STATUS     AGE
pg-cluster   postgresql           Delete               Creating   50s
pg-cluster   postgresql           Delete               Running    4m2s
```
Once the cluster status becomes Running, your PostgreSQL cluster is ready for use.

:::tip
Initial cluster creation may take longer while pulling container images.
:::

## Cluster Lifecycle Operations

### Stopping the Cluster

Stopping a PostgreSQL cluster in KubeBlocks:

1. Terminates all running pods
2. Retains persistent storage (PVCs)
3. Maintains cluster configuration

This operation is ideal for:
- Temporary cost savings
- Maintenance windows
- Development environment pauses

<Tabs>

  <TabItem value="opsRequest" label="OpsRequest API" default>

  Option 1: OpsRequest API

  Create a Stop operation request:

  ```yaml
  apiVersion: operations.kubeblocks.io/v1alpha1
  kind: OpsRequest
  metadata:
    name: pg-cluster-stop-ops
    namespace: demo
  spec:
    clusterName: pg-cluster
    type: Stop
  ```
  </TabItem>

  <TabItem value="ClusterAPI" label="Cluster API">

  Option 2: Cluster API Patch

  Modify the cluster spec directly by patching the stop field:

  ```bash
  kubectl patch cluster pg-cluster -n demo --type='json' -p='[
    {
      "op": "add",
      "path": "/spec/componentSpecs/0/stop",
      "value": true
    }
  ]'
  ```

  </TabItem>

</Tabs>

### Verifying Cluster Stop

To confirm a successful stop operation:

1. Check cluster status transition:
   ```bash
   $ kubectl get cluster pg-cluster -n demo -w
   ```
   Expected output:
   ```bash
   NAME         CLUSTER-DEFINITION   TERMINATION-POLICY   STATUS     AGE
   pg-cluster   postgresql           Delete               Stopping   6m3s
   pg-cluster   postgresql           Delete               Stopped    6m55s
   ```

2. Verify no running pods:
   ```bash
   $ kubectl get pods -n demo
   ```
   Expected output:
   ```bash
   No resources found in demo namespace.
   ```

3. Confirm persistent volumes remain:
   ```bash
   $ kubectl get pvc -n demo
   ```
   Expected output:
   ```bash
   NAME                           STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
   data-pg-cluster-postgresql-0   Bound    pvc-dcfb1ebc-2773-4edd-9898-e11da76062c4   20Gi       RWO            standard       19m
   data-pg-cluster-postgresql-1   Bound    pvc-36366e01-0178-43fa-b1a0-4168b057dd10   20Gi       RWO            standard       19m
   ```
```bash
$ kubectl get cluster -n demo -w
```
Sample
```bash
NAME         CLUSTER-DEFINITION   TERMINATION-POLICY   STATUS     AGE
pg-cluster   postgresql           Delete               Stopping   6m3s
pg-cluster   postgresql           Delete               Stopped    6m55s
```

There is no Pods running in the cluster, but the persistent storage is retained.
```bash
$ kubectl get pods -n demo
```
Example Output:
```bash
No resources found in demo namespace.
```

```bash
$ kubectl get pvc -n demo
```
```bash
NAME                           STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS               VOLUMEATTRIBUTESCLASS   AGE
data-pg-cluster-postgresql-0   Bound    pvc-dcfb1ebc-2773-4edd-9898-e11da76062c4   20Gi       RWO            <STORAGE_CLASS_NAME>       <unset>                 19m
data-pg-cluster-postgresql-1   Bound    pvc-36366e01-0178-43fa-b1a0-4168b057dd10   20Gi       RWO            <STORAGE_CLASS_NAME>       <unset>                 19m
```

### Starting the Cluster

Starting a stopped PostgreSQL cluster:
1. Recreates all pods
2. Reattaches persistent storage
3. Restores service endpoints

Expected behavior:
- Cluster returns to previous state
- No data loss occurs
- Services resume automatically
<Tabs>

  <TabItem value="opsRequest" label="Use the OpsRequest API" default>

Option 1: OpsRequest API

Initiate a Start operation request:

```yaml
apiVersion: operations.kubeblocks.io/v1alpha1
kind: OpsRequest
metadata:
  name: pg-cluster-start-ops
  namespace: demo
spec:
  # Specifies the name of the Cluster resource that this operation is targeting.
  clusterName: pg-cluster
  type: Start
```

  </TabItem>

  <TabItem value="ClusterAPI" label="Use the Cluster API">

Option 2: Cluster API Patch

Modify the cluster spec to resume operation:
1. Set stop: false, or
2. Remove the stop field entirely

```bash
kubectl patch cluster pg-cluster -n demo --type='json' -p='[
  {
    "op": "remove",
    "path": "/spec/componentSpecs/0/stop"
  }
]'
```
  </TabItem>

</Tabs>

### Verifying Cluster Start

To confirm a successful start operation:

1. Check cluster status transition:
   ```bash
   $ kubectl get cluster pg-cluster -n demo -w
   ```
   Expected output:
   ```bash
   NAME         CLUSTER-DEFINITION   TERMINATION-POLICY   STATUS     AGE
   pg-cluster   postgresql           Delete               Updating   22m
   pg-cluster   postgresql           Delete               Running    22m
   ```

2. Verify pod recreation:
   ```bash
   $ kubectl get pods -n demo -l app.kubernetes.io/instance=pg-cluster
   ```
   Expected output:
   ```bash
   NAME                     READY   STATUS    RESTARTS   AGE
   pg-cluster-postgresql-0   1/1     Running   0          2m
   pg-cluster-postgresql-1   1/1     Running   0          1m
   ```

3. Check service endpoints:
   ```bash
   $ kubectl get endpoints pg-cluster-postgresql -n demo
   ```

```bash
$ kubectl get cluster -n demo -w
```

Example Output:
```bash
NAME         CLUSTER-DEFINITION   TERMINATION-POLICY   STATUS     AGE
pg-cluster   postgresql           Delete               Updating   22m
pg-cluster   postgresql           Delete               Running    22m
```

### Restarting Cluster Components

Restart operations provide:
- Pod recreation without full cluster stop
- Component-level granularity
- Minimal service disruption

Use cases:
- Configuration changes requiring restart
- Resource refresh
- Troubleshooting

**Using OpsRequest API**

Target a specific component for restart:

```yaml
apiVersion: operations.kubeblocks.io/v1alpha1
kind: OpsRequest
metadata:
  name: pg-cluster-restart-ops
  namespace: demo
spec:
  clusterName: pg-cluster
  type: Restart
  restart:
  - componentName: postgresql
```

**Verifying Restart Completion**

To verify a successful component restart:

1. Track OpsRequest progress:
   ```bash
   $ kubectl get opsrequest pg-cluster-restart-ops -n demo -w
   ```
   Expected output:
   ```bash
   NAME                     TYPE      CLUSTER      STATUS    PROGRESS   AGE
   pg-cluster-restart-ops   Restart   pg-cluster   Running   0/2        10s
   pg-cluster-restart-ops   Restart   pg-cluster   Running   1/2        65s
   pg-cluster-restart-ops   Restart   pg-cluster   Running   2/2        2m5s
   pg-cluster-restart-ops   Restart   pg-cluster   Succeed   2/2        2m5s
   ```

2. Check pod status:
   ```bash
   $ kubectl get pods -n demo -l app.kubernetes.io/instance=pg-cluster
   ```
   Note: Pods will show new creation timestamps after restart

3. Verify component health:
   ```bash
   $ kbcli cluster describe pg-cluster -n demo
   ```
```bash
kubectl get opsrequest pg-cluster-restart-ops -n demo -w
```
Example Output:
```bash
NAME                     TYPE      CLUSTER      STATUS    PROGRESS   AGE
pg-cluster-restart-ops   Restart   pg-cluster   Running   0/2        10s
pg-cluster-restart-ops   Restart   pg-cluster   Running   1/2        65s
pg-cluster-restart-ops   Restart   pg-cluster   Running   2/2        2m5s
pg-cluster-restart-ops   Restart   pg-cluster   Running   2/2        2m5s
pg-cluster-restart-ops   Restart   pg-cluster   Succeed   2/2        2m5s
```
Once the operation is complete, the cluster will return to the Running state.

## Key Takeaways

Lifecycle management operations in KubeBlocks:

| Operation | Effect | Use Case |
|-----------|--------|----------|
| Stop | Suspends cluster, retains storage | Cost savings, maintenance |
| Start | Resumes cluster operation | Restore service after pause |
| Restart | Recreates pods for component | Configuration changes, troubleshooting |

Benefits:
- Non-disruptive operations
- Persistent data protection
- Declarative API for automation
- Consistent behavior across environments