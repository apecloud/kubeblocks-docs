---
title: Setting Up a PostgreSQL Cluster with Scheduled Continuous Backup in KubeBlocks
description: Learn how to set up a PostgreSQL cluster with scheduled full backups and continuous incremental backups enabled in KubeBlocks.
keywords: [PostgreSQL, Backup, PITR, KubeBlocks, Kubernetes]
sidebar_position: 4
sidebar_label: Scheduled Continuous Backup
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Setting Up a PostgreSQL Cluster with Scheduled Continuous Backup Enabled in KubeBlocks

This guide demonstrates how to configure a PostgreSQL cluster on KubeBlocks with:

- Scheduled full backups (base backups)
- Continuous WAL (Write-Ahead Log) archiving
- Point-In-Time Recovery (PITR) capabilities

This combination provides comprehensive data protection with minimal recovery point objectives (RPO).

## What is PITR?
Point-In-Time Recovery (PITR) allows you to restore a database to a specific moment in time by combining full backups with continuous binlog/wal/archive log backups.

For details on restoring data from both full backups and continuous binlog backups, refer to the [Restore From PITR](restore-with-pitr.mdx)  guide.

## Prerequisites

Before proceeding, ensure the following:
- Environment Setup:
    - A Kubernetes cluster is up and running.
    - The kubectl CLI tool is configured to communicate with your cluster.
    - [KubeBlocks CLI](../../user_docs/references/install-kbcli) and [KubeBlocks Operator](../../user_docs/overview/install-kubeblocks) are installed. Follow the installation instructions here.
- Namespace Preparation: To keep resources isolated, create a dedicated namespace for this tutorial:

```bash
kubectl create ns demo
namespace/demo created
```

## Prerequisites for Backup

1. Backup Repository Configured:
   - Configured `BackupRepo`
   - Network connectivity between cluster and repo, `BackupRepo` status is `Ready`

2. Cluster is Running:
   - Cluster must be in `Running` state
   - No ongoing operations (scaling, upgrades etc.)


## List of Backup methods

KubeBlocks PostgreSQL supports these backup methods:

| Feature           | Method          | Description |
|-------------------|-----------------|-------------|
| Full Backup       | pg-basebackup   | Uses `pg_basebackup`, a PostgreSQL utility to create a base backup |
| Full Backup       | wal-g  | Uses `wal-g` to create a full backup (Recommended)|
| Continuous Backup | archive-wal   | Uploads PostgreSQL Write-Ahead Logging (WAL) files periodically to the backup repository using `datasafed`|
| Continuous Backup | wal-g-archive | Uploads PostgreSQL Write-Ahead Logging (WAL) files periodically to the backup repository using `wal-g` (Recommended) |


## Deploy a PostgreSQL Cluster with Backup APIs

Deploy a 2-node PostgreSQL replication cluster (1 primary, 1 secondary) and specify backup information.

```yaml
apiVersion: apps.kubeblocks.io/v1
kind: Cluster
metadata:
  name: pg-cluster
  namespace: demo
spec:
  terminationPolicy: Delete
  clusterDef: postgresql
  topology: replication
  componentSpecs:
    - name: postgresql
      serviceVersion: 16.4.0
      disableExporter: true
      replicas: 2
      resources:
        limits:
          cpu: "0.5"
          memory: "0.5Gi"
        requests:
          cpu: "0.5"
          memory: "0.5Gi"
      volumeClaimTemplates:
        - name: data
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
  backup:
    retentionPeriod: 7d
    # for full backup
    method: wal-g # full backup methnod name
    enabled: true
    cronExpression: 0 18 * * * # full backup scheduler
    # for continuous backup
    continuousMethod: wal-g-archive # continuous backup method
    pitrEnabled: true # enable continous method or not
    repoName: s3-repo # specify backuprepo, if not specified, the BackupRepo annotated as `default` will be used.
```

Or you can patch an existing cluster to enable scheduled continuous backup:
```bash
kubectl patch cluster pg-cluster -n demo --type='merge' -p='
{
  "spec": {
    "backup": {
      "retentionPeriod": "7d",
      "method": "wal-g",
      "enabled": true,
      "cronExpression": "0 18 * * *",
      "continuousMethod": "wal-g-archive",
      "pitrEnabled": true,
      "repoName": "s3-repo"
    }
  }
}'
```

**Key Configuration Fields Explained**

| Field | Value | Description |
|-------|-------|-------------|
| `backup.enabled` | `true` | Enables scheduled backups |
| `method` | `wal-g` | Full backup method using `wal-g` |
| `cronExpression` | `0 18 * * *` | Daily full backup at 6PM UTC |
| `retentionPeriod` | `7d` | Retains backups for 7 days |
| `repoName` | `s3-repo` | Backup repository name (S3-compatible storage) |
| `pitrEnabled` | `true` | Enables continuous WAL archiving for PITR |
| `continuousMethod` | `wal-g-archive` | Method for continuous WAL archiving using `wal-g` (Recommended) |


## Verifying the Deployment

Monitor the cluster status until it transitions to the Running state:
```bash
kubectl get cluster pg-cluster -n demo -w
```

Example Output:

```bash
NAME         CLUSTER-DEFINITION   TERMINATION-POLICY   STATUS     AGE
pg-cluster   postgresql           Delete               Creating   50s
pg-cluster   postgresql           Delete               Running    4m2s
```
Once the cluster status becomes Running, your PostgreSQL cluster is ready for use.

## Monitoring Continuous Backups

Verify continuous backup operation with these commands:
```bash
# get continuous backup
kubectl get backup -l app.kubernetes.io/instance=pg-cluster,dataprotection.kubeblocks.io/backup-type=Continuous -n demo
# get stateful set working for continuous backup
kubectl get sts -l app.kubernetes.io/instance=pg-cluster,dataprotection.kubeblocks.io/backup-type=Continuous -n demo
# get pod working for continuous backup
kubectl get pod -l app.kubernetes.io/instance=pg-cluster,dataprotection.kubeblocks.io/backup-type=Continuous -n demo
```

Where labels
- `app.kubernetes.io/instance=pg-cluster` is used to identify resources by cluster name
- `dataprotection.kubeblocks.io/backup-type=Continuous` is used to identify backup by type (Continuous/Full)

## Verifying Backup Configuration

KubeBlocks automatically creates a `BackupSchedule` resource. Inspect the configuration:

```bash
kubectl get backupschedule pg-cluster-postgresql-backup-schedule  -n demo -oyaml
```

Example Output:
```yaml
apiVersion: dataprotection.kubeblocks.io/v1alpha1
kind: BackupSchedule
...
spec:
  backupPolicyName: pg-cluster-postgresql-backup-policy
  schedules:
  - backupMethod: wal-g
    cronExpression: 0 18 * * *
    enabled: true #
    retentionPeriod: 7d
  - backupMethod: wal-g-archive
    cronExpression: '*/5 * * * *'
    enabled: true
    name: wal-g-archive
    retentionPeriod: 7d
```

## Verifying the Progress of Backup

Once configured, the full backup will be performed on the scheduled time, and the continuous backup runs continuously and archives the WAL files to the backup repository periodically.

You can verify the progress of backup with the following command:
```bash
kubectl get backup -l app.kubernetes.io/instance=pg-cluster,dataprotection.kubeblocks.io/backup-type=Continuous -n demo
```


## Summary

This guide covered:
1. Configuring scheduled full backups using `wal-g`
2. Enabling continuous WAL archiving with wal-g-archive (Recommended)
3. Setting up Point-In-Time Recovery (PITR) capabilities
4. Monitoring backup operation