---
title: Restore a PostgreSQL Cluster from Backup with Point-In-Time-Recovery(PITR) on KubeBlocks
description: Learn how to restore a PostgreSQL cluster using a full backup and continuous binlog backup for Point-In-Time Recovery (PITR) on KubeBlocks.
keywords: [PostgreSQL, Full Backup, PITR, KubeBlocks]
sidebar_position: 6
sidebar_label: Restore with PITR
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Restore a PostgreSQL Cluster from Backup with Point-In-Time-Recovery(PITR) on KubeBlocks

This guide provides a step-by-step walk-through for restoring a PostgreSQL cluster from an existing full backup in KubeBlocks, along with continuous WAL  backups for Point-In-Time Recovery (PITR).

## Prerequisites
Before proceeding, ensure the following:
- Environment Setup:
  - A Kubernetes cluster is up and running.
  - The kubectl CLI tool is configured to communicate with your cluster.
  - KubeBlocks CLI and KubeBlocks Operator are installed. Follow the installation instructions here.
- Namespace Preparation: To keep resources isolated, create a dedicated namespace for this tutorial:

```bash
$ kubectl create ns demo
namespace/demo created
```

## Identify Full and Continuous Backup
To perform a PITR restoration, both a full backup and continuous backup are required. Refer to the documentation to configure these backups if they are not already set up.


**Step 1. Check Continuous Backup info**

```bash
# expect EXACTLY ONE continuous backup
kubectl get backup -n demo -l dataprotection.kubeblocks.io/backup-type=Continuous,app.kubernetes.io/instance=pg-cluster  # get the list of Continuous backups
```

**Step 2. Check `timeRange` in continuous backup**

```bash
kubectl -n demo get backup <backup-name> -oyaml | yq '.status.timeRange' # get a valid time range.
```

Example Output:

```text
end: "2025-05-07T09:22:50Z"
start: "2025-05-07T09:12:47Z"
```

** Step 3. Check the list of Full Backups info:

```bash
# expect one or more Full backups
kubectl get backup -n demo -l dataprotection.kubeblocks.io/backup-type=Full,app.kubernetes.io/instance=pg-cluster  # get the list of Full backups
```

:::important

Check if this is a full backup meets the condition: its stopTime/completionTimestamp must **AFTER** Continuous backup's startTime.
KubeBlocks will automatically pick the latest completed Full backup as the base backup.

:::

## Perform Restoration via Cluster Annotation

### Step 1. Retrieve Encrypted System Accounts
Extract encrypted credentials for system accounts from the metadata of the full backup:

```bash
$ kubectl get backup -n demo <CONTINUOUS_BACKUP_NAME> -o -ojson | jq -r '.metadata.annotations | ."kubeblocks.io/encrypted-system-accounts" | fromjson .postgresql | tojson |gsub("\""; "\\\"")'
```

Example Output:

```bash
{\"kbadmin\":\"Surpe3nrr4FFe82M34nCY2bThlztdifAVmrO8qHd3DYG5vRR33Y=\",\"kbdataprotection\":\"0gddL2+mEQ6DBeLYlijk5pd3YwuDWChSmvwlPWTS9QSfbY/kLFE=\",\"kbmonitoring\":\"ajWxjW2xMuysUq/UmP66+zCEltD1zVmO5Ec7sELSPvGEzaPzsHY=\",\"kbprobe\":\"qRoPyT8cUAVEaUjd/HIdmrVV6sJ6nO03G9MExVJryEEcs5LciCI=\",\"kbreplicator\":\"8xLt6zAIU5b2t9KmVy0LOaJsugQ8wNULyS+6LpRjRCfg05VnATk=\",\"postgres\":\"MNlRXK7nctiUyQSmTbbJUGeb6PsxDULm52abMYa2oBhyW+lWSFs=\"}
```

### Step 2. Create Restored Cluster

Create a new cluster with restoration configuration referencing the backup, set `encryptedSystemAccounts` with the encrypted system account credentials got from last step.

Apply the following YAML configuration:
```yaml
apiVersion: apps.kubeblocks.io/v1
kind: Cluster
metadata:
  name: pg-restore-pitr
  namespace: demo
  annotations:
    # NOTE: replace <ENCRYPTED-SYSTEM-ACCOUNTS> with the accounts info from you backup
    # NOTE: replace <CONTINUOUS_BACKUP_NAME> with the continuouse backup name
    # NOTE: replace <RESTORE_POINT_TIME>  with a valid time within the backup timeRange.
    kubeblocks.io/restore-from-backup: '{"postgresql":{"encryptedSystemAccounts":"<ENCRYPTED-SYSTEM-ACCOUNTS>","name":"<CONTINUOUS_BACKUP_NAME>","namespace":"demo","restoreTime":"<RESTORE_POINT_TIME>","volumeRestorePolicy":"Parallel"}}'
spec:
  terminationPolicy: Delete
  clusterDef: postgresql
  topology: replication
  componentSpecs:
    - name: postgresql
      serviceVersion: "14.7.2"
      disableExporter: true
      labels:
        # NOTE: update the label accordingly
        apps.kubeblocks.postgres.patroni/scope: pg-restore-pitr-postgresql
      replicas: 1
      resources:
        limits:
          cpu: "0.5"
          memory: "0.5Gi"
        requests:
          cpu: "0.5"
          memory: "0.5Gi"
      volumeClaimTemplates:
        - name: data
          spec:
            storageClassName: ""
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
```


## Perform Restoration via Ops API

Alternatively, use the Ops API to initiate the restoration process:

```yaml
apiVersion: operations.kubeblocks.io/v1alpha1
kind: OpsRequest
metadata:
  name: pg-cluster-restore
  namespace: demo
spec:
  clusterName: pg-cluster-restore
  force: false
  restore:
    backupName: <CONTINUOUS_BACKUP_NAME>
    backupNamespace: demo
    restorePointInTime: <RESTORE_POINT_TIME>
  type: Restore
```

### Monitor Restoration Progress

```bash
# Watch restore status
kubectl get restore -n demo -w

# Watch custer status
kubectl get cluster -n demo -w
```

## Cleanup
To remove all created resources, delete the PostgreSQL cluster along with its namespace:

```bash
kubectl delete cluster pg-cluster -n demo
kubectl delete cluster pg-cluster-restore -n demo
kubectl delete ns demo
```

## Summary
This guide demonstrated how to restore a PostgreSQL cluster in KubeBlocks using a full backup and continuous backup for Point-In-Time Recovery (PITR). Key steps included:
- Verifying available backups.
- Extracting encrypted system account credentials.
- Creating a new PostgreSQL cluster with restoration configuration.
- Monitoring the restoration process.

With this approach, you can restore a PostgreSQL cluster to a specific point in time, ensuring minimal data loss and operational continuity.

