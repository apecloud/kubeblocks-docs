---
title: Create a Full Backup for a PostgreSQL Cluster on KubeBlocks
description: Step-by-step guide to creating and validating full backups for PostgreSQL clusters using Backup API and Ops API in KubeBlocks.
keywords: [PostgreSQL, Full Backup, KubeBlocks, Kubernetes, Database Backup, XtraBackup]
sidebar_position: 2
sidebar_label: Create Full Backup
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';


# Create a Full Backup for a PostgreSQL Cluster on KubeBlocks

This guide demonstrates how to create and validate full backups for a PostgreSQL cluster deployed on KubeBlocks using `pg-basebackup` through both Backup API and Ops API.
The Ops API is essentially a wrapper around the Backup API, offering enhanced control and progress monitoring capabilities for backup operations.

We will cover how to restore data from a backup in the [Restore From Full Backup](restoring-from-full-backup.md) guide.

## Prerequisites

Before proceeding, ensure the following:
- Environment Setup:
    - A Kubernetes cluster is up and running.
    - The kubectl CLI tool is configured to communicate with your cluster.
    - KubeBlocks CLI and KubeBlocks Operator are installed. Follow the installation instructions here.
- Namespace Preparation: To keep resources isolated, create a dedicated namespace for this tutorial:

```bash
$ kubectl create ns demo
namespace/demo created
```

## Deploy a PostgreSQL Cluster

Deploy a 2-node semi-sync PostgreSQL cluster (1 primary, 1 secondary):

```yaml
apiVersion: apps.kubeblocks.io/v1
kind: Cluster
metadata:
  name: pg-cluster
  namespace: demo
spec:
  terminationPolicy: Delete
  clusterDef: postgresql
  topology: replication
  componentSpecs:
    - name: postgresql
      serviceVersion: 16.4.0
      labels:
        apps.kubeblocks.postgres.patroni/scope: pg-cluster-postgresql
      disableExporter: true
      replicas: 2
      resources:
        limits:
          cpu: "0.5"
          memory: "0.5Gi"
        requests:
          cpu: "0.5"
          memory: "0.5Gi"
      volumeClaimTemplates:
        - name: data
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
```

## Verifying the Deployment

Monitor the cluster status until it transitions to the Running state:
```bash
$ kubectl get cluster pg-cluster -n demo -w
```

Example Output::

```bash
NAME         CLUSTER-DEFINITION   TERMINATION-POLICY   STATUS     AGE
pg-cluster   postgresql           Delete               Creating   50s
pg-cluster   postgresql           Delete               Running    4m2s
```
Once the cluster status becomes Running, your PostgreSQL cluster is ready for use.

:::tip
If you are creating the cluster for the very first time, it may take some time to pull images before running.

:::

## Prerequisites for Backup

1. Backup Repository Configured:
   - Configured `BackupRepo`
   - Network connectivity between cluster and repo, `BackupRepo` status is `Ready`

2. Cluster is Running:
   - Cluster must be in `Running` state
   - No ongoing operations (scaling, upgrades etc.)

## Identify Backup Policies

List available backup policies and schedules for the cluster:

```bash
# List backup policies
$ kubectl get backuppolicy -n demo -l app.kubernetes.io/instance=pg-cluster

# List backup schedules
$ kubectl get backupschedule -n demo -l app.kubernetes.io/instance=pg-cluster
```

Example Output:
```bash
NAME                                            BACKUP-REPO   STATUS      AGE
pg-cluster-postgresql-backup-policy                           Available   58m

NAME                                              STATUS      AGE
pg-cluster-postgresql-backup-schedule             Available   60m
```

View supported backup methods in the BackupPolicy CR 'pg-cluster-postgresql-backup-policy':

```bash
$ kubectl get backuppolicy pg-cluster-postgresql-backup-policy -n demo -oyaml | yq '.spec.backupMethods[].name'
```
KubeBlocks supports multiple backup methods for PostgreSQL cluster, such as `pg-basebackup`, `volume-snapshot`, `wal-g`, etc. The following sections demonstrate how to perform a full backup using the 'pg-basebackup' method.


## Perform a Backup via Backup API

### 1. On-Demand Full Backup

The method `pg-basebackup` uses `pg_basebackup`,  a PostgreSQL utility to create a base backup.

To create a base backup for the cluster, you can apply the following yaml file:

```yaml
apiVersion: dataprotection.kubeblocks.io/v1alpha1
kind: Backup
metadata:
  name: pg-cluster-pg-basebackup
  namespace: demo
spec:
  # Specifies the backup method name that is defined in the backup policy.
  # - pg-basebackup
  # - volume-snapshot
  # - config-wal-g and wal-g
  # - archive-wal
  backupMethod: pg-basebackup
  # Specifies the backup policy to be applied for this backup.
  backupPolicyName: pg-cluster-postgresql-backup-policy
  # Determines whether the backup contents stored in the backup repository should be deleted when the backup custom resource(CR) is deleted. Supported values are `Retain` and `Delete`.
  # - `Retain` means that the backup content and its physical snapshot on backup repository are kept.
  # - `Delete` means that the backup content and its physical snapshot on backup repository are deleted.
  deletionPolicy: Delete
```

### 2. Monitor Backup Progress

Check the backup status until it shows 'Completed':

```bash
$ kubectl get backup pg-cluster-pg-basebackup  -n demo -w
```

Expected Output:

```bash
NAME                       POLICY                                METHOD          REPO            STATUS      TOTAL-SIZE   DURATION   DELETION-POLICY   CREATION-TIME          COMPLETION-TIME        EXPIRATION-TIME
pg-cluster-pg-basebackup   pg-cluster-postgresql-backup-policy   pg-basebackup   <BACKUP_REPO>   Completed   4722262      10s        Delete            2025-05-16T02:53:45Z   2025-05-16T02:53:55Z
```

### 3. Verify Completion

- Check status is `Completed`
- Verify backup size matches expectations
- Validate backup metadata
- Verify the backup files in the configured BackupRepo.

Information, such as `path`, `timeRange` about the backup will be recorded into the `Backup` resource.


## Perform a Backup via Ops API

### 1. On-Demand Full Backup

Execute a full backup using the 'pg-basebackup' method defined in the backup policy:

```yaml
apiVersion: operations.kubeblocks.io/v1alpha1
kind: OpsRequest
metadata:
  name: pg-cluster-backup
  namespace: demo
spec:
  clusterName: pg-cluster
  force: false
  backup:
    backupPolicyName: pg-cluster-postgresql-backup-policy
    backupMethod: pg-basebackup
    deletionPolicy: Delete
    retentionPeriod: 1mo
  type: Backup
```

### 2. Monitor Backup Progress

#### Step 1: Verify Backup Operation Status

Execute the following command to monitor the backup operation status in real-time:
```bash
$ kubectl get ops pg-cluster-backup  -n demo -w
```

Example Output:
```bash
NAME                TYPE     CLUSTER      STATUS    PROGRESS   AGE
pg-cluster-backup   Backup   pg-cluster   Succeed   -/-        35s
```

- A STATUS of 'Succeed' indicates the backup operation completed successfully.

#### Step 2: Confirm Backup Completion

Check the final backup status with:

```bash
$ kubectl get backup -n demo -l operations.kubeblocks.io/ops-name=pg-cluster-backup
```

Expected Output:
```bash
NAME                                    POLICY                                METHOD          REPO           STATUS      TOTAL-SIZE   DURATION   DELETION-POLICY   CREATION-TIME          COMPLETION-TIME        EXPIRATION-TIME
backup-demo-pg-cluster-20250516025810   pg-cluster-postgresql-backup-policy   pg-basebackup   <BACKUP_REPO>  Completed   4725590      10s        Delete            2025-05-16T02:58:10Z   2025-05-16T02:58:20Z   2025-06-15T02:58:20Z
```
- The backup status should show 'Completed'.

### 3. Verify Completion

- Check status is `Completed`
- Verify backup size matches expectations
- Validate backup metadata
- Verify the backup files in the configured BackupRepo.

Information, such as `path`, `timeRange` about the backup will be recorded into the `Backup` resource.

## Summary
This guide demonstrated how to:
- Deploy a semi-synchronous PostgreSQL cluster on KubeBlocks.
- Create a full backup using the 'pg-basebackup' method.
- Monitor and validate backup artifacts.
By following this guide, you can ensure your PostgreSQL cluster data is securely backed up and easily restorable.