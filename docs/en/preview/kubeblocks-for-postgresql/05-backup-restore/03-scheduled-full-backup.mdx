---
title: Setting Up a PostgreSQL Cluster with Scheduled Backups in KubeBlocks
description: Learn how to deploy a PostgreSQL cluster using KubeBlocks and configure automated scheduled backups with retention in an S3 repository.
keywords: [PostgreSQL, Backup, KubeBlocks, Scheduled Backup, Kubernetes]
sidebar_position: 3
sidebar_label: Scheduled Backups
---


# Setting Up a PostgreSQL Cluster with Scheduled Backups in KubeBlocks

This guide demonstrates how to deploy a PostgreSQL cluster using KubeBlocks and configure scheduled backups with retention in an S3 repository.

## Prerequisites

import Prerequisites from '../_tpl/_prerequisites.mdx'

<Prerequisites />

## Deploy a PostgreSQL Cluster

import CreatePGCluster from '../_tpl/_create-pg-replication-cluster.mdx'

<CreatePGCluster />

## Verifying the Deployment

import VerifyPGCluster from '../_tpl/_verify-pg-replication-cluster.mdx'

<VerifyPGCluster />

## Prerequisites for Backup

1. Backup Repository Configured:
   - Configured `BackupRepo`
   - Network connectivity between cluster and repo, `BackupRepo` status is `Ready`

2. Cluster is Running:
   - Cluster must be in `Running` state
   - No ongoing operations (scaling, upgrades etc.)

## Configure Scheduled Backups (using pg-basebackup and archive-wal)

`BackupSchedule` defines a schedule for backups. It references the `BackupPolicy` resource and the `BackupMethod` name.

KubeBlocks automatically creates a `BackupSchedule` resource when the cluster is created. Follow these steps to enable and configure scheduled backups:

### View default backup schedule configuration:

```bash
kubectl get backupschedule pg-cluster-postgresql-backup-schedule  -n demo -oyaml
```

Example Output:
```yaml
apiVersion: dataprotection.kubeblocks.io/v1alpha1
kind: BackupSchedule
spec:
  backupPolicyName: pg-cluster-postgresql-backup-policy
  schedules:
  - backupMethod: pg-basebackup
    # ┌───────────── minute (0-59)
    # │ ┌───────────── hour (0-23)
    # │ │ ┌───────────── day of month (1-31)
    # │ │ │ ┌───────────── month (1-12)
    # │ │ │ │ ┌───────────── day of week (0-6) (Sunday=0)
    # │ │ │ │ │
    # 0 18 * * *
    # schedule this job every day at 6:00 PM (18:00).
    cronExpression: 0 18 * * * # update the cronExpression to your need
    enabled: false # set to `true` to schedule base backup periodically
    retentionPeriod: 7d # set the retention period to your need
```

To check if an backup method is enabled, you can run the following command:

```bash
kubectl get backupschedule pg-cluster-postgresql-backup-schedule -n demo -oyaml | yq '.spec.schedules[] | .backupMethod + "," + .enabled'
```

Example Output:

| Backup Method        | Enabled |
|----------------------|---------|
| pg-basebackup        | false   |
| wal-g                | false   |
| archive-wal          | false   |
| wal-g-archive        | false   |

By default, all backup methods are disabled. You can enable it by setting `enabled` to `true` on demand. As introduced previously, there are two `FULL` backup methods: `pg-basebackup` and `wal-g`. As `wal-g` cannot be enabled alone, we use `pg-basebackup` in this guide.

There are two ways to enable a backup method and we will introduce them in the following sections.

### Option 1. Edit the BackupSchedule resource

Enable and customize the backup schedule:
```bash
kubectl edit backupschedule pg-cluster-postgresql-backup-schedule -n demo
```

Update these key parameters:
- `enabled`: Set to `true` to activate scheduled backups
- `cronExpression`: Configure backup frequency using cron syntax
- `retentionPeriod`: Set how long to keep backups (e.g., `7d`, `1mo`)

Example configuration for daily backups at 6PM UTC with 7-day retention:
```yaml
schedules:
- backupMethod: pg-basebackup
  enabled: true
  cronExpression: "0 18 * * *"
  retentionPeriod: 7d
```

### Option 2. Edit the Cluster resource with backup method

Or you can patch an existing cluster to enable scheduled backup:

```bash
kubectl patch cluster pg-cluster -n demo --type='merge' -p='
{
  "spec": {
    "backup": {
      "retentionPeriod": "7d",
      "method": "pg-basebackup",
      "enabled": true,
      "incrementalBackupEnabled": false,
      "pitrEnabled": false,
      "cronExpression": "0 18 * * *",
      "repoName": "s3-repo"
    }
  }
}'
```

## Verify the configuration

### View schedule configuration
```bash
# Check schedule status
kubectl get backupschedule pg-cluster-postgresql-backup-schedule -n demo -oyaml | yq '.spec.schedules[] | .backupMethod + "," + .enabled'
```

Example Output:

| Backup Method        | Enabled |
|----------------------|---------|
| pg-basebackup        | true    |
| wal-g                | false   |
| archive-wal          | false   |
| wal-g-archive        | false   |

Only `pg-basebackup` is enabled.

### Check CronJob

KubeBlocks create a CronJob to schedule full backups. You can check the CronJob status:

```bash
kubectl get cronjob -n demo -l app.kubernetes.io/instance=pg-cluster,app.kubernetes.io/managed-by=kubeblocks-dataprotection
```

Example Output:

```bash
NAME                                           SCHEDULE     TIMEZONE   SUSPEND   ACTIVE   LAST SCHEDULE   AGE
b387c27b-pg-cluster-postgresql-pg-basebackup   0 18 * * *   UTC        False     0        12h             3d5h
```

If there is no CronJob,  please check the `BackupSchedule` resource the full backup method `pg-basebackup` is enabled.

## Monitoring and Managing Backups

After enabling scheduled backups, monitor their execution and manage backup retention:

1. View all backups:
```bash
kubectl get backup -n demo -l app.kubernetes.io/instance=pg-cluster
```

2. Inspect backup details:

```bash
kubectl describe backup <backup-name> -n demo
```

3. Verify backup artifacts:
- Status should show "Completed"
- Check backup size matches expectations
- Confirm retention period is being applied
- Validate backup files exist in repository

4. Manage backup retention:
- To manually delete old backups:
```bash
kubectl delete backup <backup-name> -n demo
```
- To modify retention period:
```bash
kubectl edit backupschedule pg-cluster-postgresql-backup-schedule -n demo
```

## Cleanup
To remove all created resources, delete the PostgreSQL cluster along with its namespace:

```bash
kubectl delete cluster pg-cluster -n demo
kubectl delete ns demo
```

## Summary

This guide demonstrated:
1. Configuration of automated PostgreSQL backups
2. Schedule customization using cron syntax
3. Retention policy management
4. Backup verification procedures

Your PostgreSQL cluster now has:
- Regular automated backups
- Configurable retention policies
- Complete backup history tracking
