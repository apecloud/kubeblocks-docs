---
title: Upgrade to v0.9.x
description: Upgrade to KubeBlocks v0.9.x, operation, tips and notes
keywords: [upgrade, kubeblocks]
sidebar_position: 1
sidebar_label: Upgrade to v0.9.x
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Upgrade to KubeBlocks v0.9.x

This guide walks you through upgrading KubeBlocks to version 0.9.x. The v0.9.x release series delivers significant improvements in performance, stability, and introduces powerful new features to enhance your database management experience.

## Before You Begin

### Verify Your Current Version

First, check which version of KubeBlocks you're currently running:

```bash
# Using helm
helm -n kb-system list | grep kubeblocks

# Using kbcli
kbcli version
```

### Choose Your Upgrade Path

Select the appropriate upgrade path based on your current version:

| Current Version | Target: v0.9.x | Upgrade Path |
|-----------------|----------------|---------------|
| v0.9.x | ✅ Direct upgrade | Follow [v0.9.x to v0.9.x upgrade](#upgrade-from-kubeblocks-v09x) |
| v0.8.x | ✅ Direct upgrade | Follow [v0.8.x to v0.9.x upgrade](#upgrade-from-kubeblocks-v08x) |
| v0.7.x or earlier | ⚠️ Multi-step upgrade | Upgrade to v0.8.x first, then to v0.9.x |

:::tip
We recommend upgrading to the latest stable version for optimal performance and access to the newest features.
:::


## Upgrade from KubeBlocks v0.9.x

This section covers upgrading between v0.9.x versions (for example, from v0.9.1 to v0.9.5). Since these are patch releases within the same major version, the upgrade process is straightforward.

:::note
**Version Placeholder:**

Throughout this section, replace `{VERSION}` with your target version number (e.g., `v0.9.5`, `v0.9.4`).
:::

<Tabs>

  <TabItem value="Helm" label="Helm" default>

  **Step 1: Update Custom Resource Definitions (CRDs)**

  KubeBlocks separates CRDs from the Helm chart to reduce chart size. Start by updating the CRDs:

  ```bash
  kubectl replace -f https://github.com/apecloud/kubeblocks/releases/download/{VERSION}/kubeblocks_crds.yaml
  ```

  **Step 2: Upgrade KubeBlocks Core**

  First, update your Helm repository to get the latest chart information:
  ```bash
  helm repo add kubeblocks https://apecloud.github.io/helm-charts
  helm repo update kubeblocks
  ```

  Then upgrade KubeBlocks to the target version:
  ```bash
  helm -n kb-system upgrade kubeblocks kubeblocks/kubeblocks --version {VERSION} --set crd.enabled=false
  ```

  :::note
  **Why `crd.enabled=false`?**

  Since we're upgrading within the same v0.9.x series, no API conversion is needed. Setting `crd.enabled=false` skips the CRD upgrade task for faster deployment.
  :::

  **Step 3: (Optional) Upgrade Addons**

  :::warning
  **Addon Upgrade Impact:**

  Upgrading Addons may restart existing database clusters and affect availability. Only proceed during maintenance windows, or upgrade Addons individually as needed.
  :::

  To upgrade Addons to the versions bundled with the new KubeBlocks version:

  ```bash
  helm -n kb-system upgrade kubeblocks kubeblocks/kubeblocks --version {VERSION} \
    --set upgradeAddons=true \
    --set crd.enabled=false
  ```

  </TabItem>

  <TabItem value="kbcli" label="kbcli">

  **Step 1: Update kbcli**

  Download and install the matching version of kbcli:

  ```bash
  curl -fsSL https://kubeblocks.io/installer/install_cli.sh | bash -s {VERSION}
  ```

  **Step 2: Upgrade KubeBlocks Core**

  Perform the core upgrade without updating Addons:

  ```bash
  kbcli kb upgrade --version {VERSION}
  ```

  **Step 3: (Optional) Upgrade Addons**

  :::warning
  **Addon Upgrade Impact:**

  Upgrading Addons may restart existing database clusters and affect availability. Only proceed during maintenance windows, or upgrade Addons individually as needed.
  :::

  To upgrade Addons to the versions bundled with the new KubeBlocks version:

  ```bash
  kbcli kb upgrade --version {VERSION} --set upgradeAddons=true
  ```

  </TabItem>

</Tabs>

## Upgrade from KubeBlocks v0.8.x

This section covers upgrading from v0.8.x to v0.9.x. This is a major version upgrade that requires additional preparation steps due to API changes.

:::note
**Key API Changes in v0.9.x:**

- Storage provider group updated from `storage.kubeblocks.io` to `dataprotection.kubeblocks.io`
- Enhanced ConfigConstraint API with multi-version support
:::

<Tabs>

  <TabItem value="Helm" label="Helm" default>

  **Step 1: Clean Up Incompatible Resources**

  Remove OpsDefinitions that are incompatible with v0.9.x:

  ```bash
  # Delete specific incompatible OpsDefinitions
  kubectl delete opsdefinitions.apps.kubeblocks.io kafka-quota kafka-topic kafka-user-acl switchover

  # Alternative: Delete all OpsDefinitions (they will be recreated during upgrade)
  kubectl delete opsdefinitions.apps.kubeblocks.io --all
  ```

  **Step 2: Update Custom Resource Definitions (CRDs)**

  Install the new Storage Provider CRD required for v0.9.x:

  ```bash
  kubectl create -f https://github.com/apecloud/kubeblocks/releases/download/{VERSION}/dataprotection.kubeblocks.io_storageproviders.yaml
  ```

  Update all KubeBlocks CRDs to the new version:

  ```bash
  kubectl replace -f https://github.com/apecloud/kubeblocks/releases/download/{VERSION}/kubeblocks_crds.yaml
  ```

  :::note
  **Network Optimization:**

  For better network performance, download the CRD YAML files locally first, then apply them using `kubectl create -f <local-file-path>`.
  :::

  **Step 3: Update Helm Repository and Upgrade KubeBlocks**

  Update your Helm repository to get the latest chart information:

  ```bash
  helm repo add kubeblocks https://apecloud.github.io/helm-charts
  helm repo update kubeblocks
  ```

  Enable webhooks for multi-version conversion (it will convert ConfigConstraint API to the new version):

  ```bash
  helm -n kb-system upgrade kubeblocks kubeblocks/kubeblocks --version {VERSION} \
    --set admissionWebhooks.enabled=true \
    --set admissionWebhooks.ignoreReplicasCheck=true
  ```

  :::note
  **Configuration Options Explained:**

  - `admissionWebhooks.enabled=true`: Enables webhook for ConfigConstraint API multi-version conversion
  - `admissionWebhooks.ignoreReplicasCheck=true`: Allows webhook to run with single replica deployments
  :::

  **Step 4: (Optional) Upgrade Addons**

  :::warning
  **Addon Upgrade Impact:**

  Upgrading Addons may restart existing database clusters and affect availability. Only proceed during maintenance windows. Or you can upgrade Addons individually.
  :::

  ```bash
  helm -n kb-system upgrade kubeblocks kubeblocks/kubeblocks --version {VERSION} \
    --set upgradeAddons=true \
    --set admissionWebhooks.enabled=true \
    --set admissionWebhooks.ignoreReplicasCheck=true
  ```

  </TabItem>

  <TabItem value="kbcli" label="kbcli">

  **Step 1: Update kbcli**

  Download and install kbcli for the target version:

  ```bash
  curl -fsSL https://kubeblocks.io/installer/install_cli.sh | bash -s {VERSION}
  ```

  Verify the installation:
  ```bash
  kbcli version
  ```

  **Step 2: Upgrade KubeBlocks with Webhook Support**

  Upgrade KubeBlocks with enhanced API validation and multi-version support:

  ```bash
  kbcli kb upgrade --version {VERSION} \
    --set admissionWebhooks.enabled=true \
    --set admissionWebhooks.ignoreReplicasCheck=true
  ```

  :::note
  **Configuration Options Explained:**

  - `admissionWebhooks.enabled=true`: Enables webhook for ConfigConstraint API multi-version conversion
  - `admissionWebhooks.ignoreReplicasCheck=true`: Allows webhook to run with single replica deployments (useful for development environments)
  :::

  **Step 3: (Optional) Upgrade Addons**

  :::warning
  **Addon Upgrade Impact:**

  Upgrading Addons may restart existing database clusters and affect availability. Only proceed during maintenance windows, or upgrade Addons individually as needed.
  :::

  To upgrade Addons along with KubeBlocks:

  ```bash
  kbcli kb upgrade --version {VERSION} \
    --set upgradeAddons=true \
    --set admissionWebhooks.enabled=true \
    --set admissionWebhooks.ignoreReplicasCheck=true
  ```

  </TabItem>

</Tabs>

Some Addons require special handling when upgrading from v0.8.x to v0.9.x.

- **Required**: The `mysql` Addon must be upgraded when moving from v0.8.x to v0.9.x. Clusters created in v0.8.x will not function properly in v0.9.x without this upgrade.
- **Recommended**: For `clickhouse`, `milvus`, `elasticsearch`, and `llm` Addons, upgrade KubeBlocks first, then upgrade these Addons for optimal functionality.

## Individual Addon Upgrades

If you chose not to upgrade Addons during the KubeBlocks upgrade, or if you need to upgrade specific Addons, follow these steps to upgrade Addons individually.

### Upgrade Methods

<Tabs>

  <TabItem value="Helm" label="Helm" default>

  **Step 1: Configure Addon Repository**

  ```bash
  # Add the primary Addon repository
  helm repo add kubeblocks-addons https://apecloud.github.io/helm-charts

  # Alternative repository for users in regions with limited GitHub access
  # helm repo add kubeblocks-addons https://jihulab.com/api/v4/projects/150246/packages/helm/stable

  # Update repository information
  helm repo update
  ```

  **Step 2: Find Available Versions**

  ```bash
  # Search for available versions of a specific Addon
  helm search repo kubeblocks-addons/{addon-name} --versions --devel
  # Example: helm search repo kubeblocks-addons/mysql --versions --devel
  ```

  **Step 3: Upgrade the Addon**

  Select a version that is compatible (same major version) with your KubeBlocks release and upgrade:

  ```bash
  # Upgrade to a specific version
  helm upgrade -i {addon-release-name} kubeblocks-addons/{addon-name} --version x.y.z -n kb-system
  ```

  :::note
  **Parameter Reference:**
  - `{addon-name}`: Replace with the actual Addon name (e.g., `mysql`, `postgresql`)
  - `{addon-release-name}`: The release name of the installed Addon (e.g., `kb-addon-mysql`, `kb-addon-postgresql`)
  - `x.y.z`: The target version number, compatible with your KubeBlocks release
  :::

  </TabItem>

  <TabItem value="kbcli" label="kbcli">

  **Step 1: Update Addon Index**

  ```bash
  # List available Addon indexes (the default index is `kubeblocks`)
  kbcli addon index list

  # Update the default KubeBlocks index
  kbcli addon index update kubeblocks
  ```

  **Step 2: Search for Available Addon Versions**

  ```bash
  # Search for available versions of a specific Addon
  kbcli addon search {addon-name}

  # View currently installed Addons and their versions
  kbcli addon list | grep {addon-name}
  ```

  **Step 3: Upgrade the Addon**

  Select a version that is compatible (same major version) with your KubeBlocks release and upgrade:

  ```bash
  kbcli addon upgrade {addon-name} --version x.y.z
  ```

  **Force upgrade (use with caution):**
  ```bash
  kbcli addon upgrade {addon-name} --version x.y.z --force
  ```

  **Fresh installation (if not previously installed):**
  ```bash
  kbcli addon install {addon-name} --version x.y.z
  ```

  :::note
  **When to use `--force`:**
  - The standard upgrade fails due to version conflicts
  - You need to downgrade to a previous version
  - Use with caution as it bypasses compatibility checks
  :::

  </TabItem>

</Tabs>

### Handling Addon Compatibility Issues

Starting with v0.9.x, some APIs have been deprecated to improve the system architecture. The `ClusterVersion` CRD is marked as deprecated, and many Addons now use the new APIs: `ComponentDefinition`, `ComponentVersion`, and the updated `ClusterDefinition`.

**Example: Kafka Addon Upgrade**

When upgrading the Kafka Addon from v0.9.0 to v0.9.2, you'll notice that the newer version no longer includes the `ClusterVersion` custom resource. This requires updating existing clusters to use the new API structure.

**Cluster Upgrade Requirements:**

To upgrade clusters to work with the new Addon version, you need to:
1. Remove the deprecated `clusterVersionRef` field from the cluster spec
2. Remove the `componentDefRef` field from each component spec
3. Add the new `componentDef` field
4. Add the `serviceVersion` field where necessary

**Step-by-Step Example: Kafka Cluster Upgrade**

The following example demonstrates upgrading Kafka clusters from the old API structure to the new one:

**Step 1: Identify Current ComponentDefRefs**

First, get the list of ComponentDefRefs used by your current Kafka installation:

```bash
kubectl get clusterdefinition kafka -oyaml | yq '.spec.componentDefs[].name'
```

Expected output:
```bash
kafka-server
kafka-broker
controller
kafka-exporter
```

**Step 2: Upgrade the Addon**

Upgrade the Kafka Addon to the new version:

```bash
kbcli addon upgrade kafka --version 0.9.2
```

**Step 3: Map Old to New ComponentDefinitions**

After upgrading, list the new ComponentDefinitions available:

```bash
kubectl get cmpd -l app.kubernetes.io/name=kafka
```

Expected output:
```bash
NAME               SERVICE            SERVICE-VERSION   STATUS      AGE
kafka-broker-2.8   kafka              2.8.2             Available   37m
kafka-broker-3.2   kafka              3.3.2             Available   37m
kafka-combine      kafka              3.3.2             Available   24h
kafka-controller   kafka-controller   3.3.2             Available   24h
kafka-exporter     kafka-exporter     1.6.0             Available   24h
kafka-zookeeper    kafka-zookeeper    3.7.2             Available   37m
```

We can list the mapping between old componentDefRef and new ComponentDefinition as follows:

| v0.9.0 componentDefRef | v0.9.2 ComponentDefinition | serviceVersion |
|------------------------|----------------------------|----------------|
| kafka-broker | kafka-broker-3.2 | 3.3.2 |
| kafka-server | kafka-combine | 3.3.2 |
| controller | kafka-controller | 3.3.2 |
| kafka-exporter | kafka-exporter | 1.6.0 |

Remember the mapping table is just an example, you may need to modify it based on your actual Addon version.

**Step 4: Identify Clusters to Upgrade**

List all Kafka clusters that need to be updated:

```bash
# List all Kafka clusters
kubectl get cluster --all-namespaces -l clusterdefinition.kubeblocks.io/name=kafka
```

Each cluster needs to be updated to use the new ComponentDefinition format.

**Step 5: Update Cluster Specifications**

Use the following script to update your Kafka clusters to the new API format. Replace `<clustername>` and `<namespace>` with your actual values:

```bash
#!/bin/bash
cluster="<clustername>"
namespace="<namespace>"

echo "Upgrading Kafka cluster: $cluster"

# Get current componentDefRef values to build the patch
arr=($(kubectl get -n $namespace cluster $cluster -o jsonpath="{.spec.componentSpecs[*].componentDefRef}"))

# Build the patch operations array
patch_ops="["

# Remove deprecated cluster-level references
patch_ops+='{
  "op": "remove",
  "path": "/spec/clusterDefinitionRef"
},'

patch_ops+='{
  "op": "remove",
  "path": "/spec/clusterVersionRef"
},'

# Remove deprecated label (optional)
patch_ops+='{
  "op": "remove",
  "path": "/metadata/labels/clusterversion.kubeblocks.io~1name"
},'

# Update each component specification
for i in "${!arr[@]}"; do
    case "${arr[i]}" in
        "kafka-broker")
            patch_ops+="{\"op\": \"remove\", \"path\": \"/spec/componentSpecs/$i/componentDefRef\"},"
            patch_ops+="{\"op\": \"add\", \"path\": \"/spec/componentSpecs/$i/componentDef\", \"value\": \"kafka-broker-3.2\"},"
            patch_ops+="{\"op\": \"add\", \"path\": \"/spec/componentSpecs/$i/serviceVersion\", \"value\": \"3.3.2\"},"
            ;;
        "kafka-server")
            patch_ops+="{\"op\": \"remove\", \"path\": \"/spec/componentSpecs/$i/componentDefRef\"},"
            patch_ops+="{\"op\": \"add\", \"path\": \"/spec/componentSpecs/$i/componentDef\", \"value\": \"kafka-combine\"},"
            patch_ops+="{\"op\": \"add\", \"path\": \"/spec/componentSpecs/$i/serviceVersion\", \"value\": \"3.3.2\"},"
            ;;
        "controller")
            patch_ops+="{\"op\": \"remove\", \"path\": \"/spec/componentSpecs/$i/componentDefRef\"},"
            patch_ops+="{\"op\": \"add\", \"path\": \"/spec/componentSpecs/$i/componentDef\", \"value\": \"kafka-controller\"},"
            patch_ops+="{\"op\": \"add\", \"path\": \"/spec/componentSpecs/$i/serviceVersion\", \"value\": \"3.3.2\"},"
            ;;
        "kafka-exporter")
            patch_ops+="{\"op\": \"remove\", \"path\": \"/spec/componentSpecs/$i/componentDefRef\"},"
            patch_ops+="{\"op\": \"add\", \"path\": \"/spec/componentSpecs/$i/componentDef\", \"value\": \"kafka-exporter\"},"
            patch_ops+="{\"op\": \"add\", \"path\": \"/spec/componentSpecs/$i/serviceVersion\", \"value\": \"1.6.0\"},"
            ;;
    esac
done

# Apply the patch
patch_ops="${patch_ops%,}]"
kubectl patch -n $namespace cluster "$cluster" --type='json' -p="$patch_ops"
```

:::important
**Script Customization Required**

You may need to modify this script based on the specific changes in your Addon version, particularly the `componentDefRef` to `ComponentDefinition` mapping table shown in Step 3.
:::

---

## Getting Help

If you encounter issues during the upgrade process:

- **Check the logs**: Review upgrade logs using `kubectl -n kb-system logs deployment/kubeblocks`
- **Community Support**: Visit the [KubeBlocks GitHub Issues](https://github.com/apecloud/kubeblocks/issues) for known issues and community help
- **Documentation**: Refer to the [KubeBlocks documentation](https://kubeblocks.io/docs/) for additional guidance