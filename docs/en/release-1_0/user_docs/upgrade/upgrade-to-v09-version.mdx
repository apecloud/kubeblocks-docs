---
title: Upgrade to v0.9.x
description: Upgrade to KubeBlocks v0.9.x, operation, tips and notes
keywords: [upgrade, kubeblocks]
sidebar_position: 1
sidebar_label: Upgrade to v0.9.x
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Upgrade to KubeBlocks v0.9.x

This guide provides step-by-step instructions for upgrading KubeBlocks to version 0.9.x. KubeBlocks v0.9.x brings significant improvements in performance, stability, and new features.

## Before You Start

### Check Your Current Version

Before proceeding, verify your current KubeBlocks version:

```bash
# Using helm
helm -n kb-system list | grep kubeblocks

# Using kbcli
kbcli version
```

### Upgrade Path Selection

| From Version | To v0.9.y | Action Required |
|--------------|-----------|-----------------|
| v0.9.x | ✅ Supported | Follow [upgrade from v0.9.x](#upgrade-from-kubeblocks-v09x) |
| v0.8.x | ✅ Supported | Follow [upgrade from v0.8.x](#upgrade-from-kubeblocks-v08x) |
| v0.7.x or earlier | ⚠️ Two-step upgrade | First upgrade to v0.8.x, then to v0.9.x |

:::tip
Installing the latest stable version is recommended for optimal performance and access to the newest features.
:::


## Upgrade from KubeBlocks v0.9.x

This section covers upgrading from one v0.9.x version (e.g., v0.9.1)  to another (e.g., v0.9.5).

:::note
**Version Placeholder:**

Replace `{VERSION}` in the following commands with the target version number (e.g., `v0.9.5`, `v0.9.4`)
:::

<Tabs>

  <TabItem value="Helm" label="Helm" default>

  **Step 1: Update Custom Resource Definitions (CRDs)**

  KubeBlocks separates CRDs from the Helm chart to reduce chart size. Update the CRDs first:

  ```bash
  kubectl replace -f https://github.com/apecloud/kubeblocks/releases/download/{VERSION}/kubeblocks_crds.yaml
  ```

  **Step 2: Upgrade KubeBlocks Core**

  Update helm repository:
  ```bash
  helm repo add kubeblocks https://apecloud.github.io/helm-charts
  helm repo update kubeblocks
  ```

  Upgrade KubeBlocks:
  ```bash
  helm -n kb-system upgrade kubeblocks kubeblocks/kubeblocks --version {VERSION} --set crd.enabled=false
  ```

  :::note
  **Why `crd.enabled=false`?**

  Since we're upgrading within v0.9.x versions (no API conversion needed), we can skip the CRD upgrade task for faster deployment.
  :::

  **Step 3: (Optional) Upgrade Addons**

  :::warning
  **Addon Upgrade Impact:**

  Upgrading Addons may restart existing database clusters and affect availability. Only proceed when necessary. Or you can upgrade Addons individually.
  :::

  To upgrade Addons to the versions bundled with the new KubeBlocks version:

  ```bash
  helm -n kb-system upgrade kubeblocks kubeblocks/kubeblocks --version {VERSION} \
    --set upgradeAddons=true \
    --set crd.enabled=false
  ```

  </TabItem>

  <TabItem value="kbcli" label="kbcli">

  **Step 1: Update kbcli**

  Download and install the matching version of kbcli:

  ```bash
  curl -fsSL https://kubeblocks.io/installer/install_cli.sh | bash -s {VERSION}
  ```

  **Step 2: Upgrade KubeBlocks Core**

  Perform the basic upgrade without Addon updates:

  ```bash
  kbcli kb upgrade --version {VERSION}
  ```

  **Step 3: (Optional) Upgrade Addons**

  :::warning
  **Addon Upgrade Impact:**

  Upgrading Addons may restart existing database clusters and affect availability. Only proceed if necessary and during maintenance windows. Or you can upgrade Addons individually.
  :::

  To upgrade Addons to the versions bundled with the new KubeBlocks version:

  ```bash
  kbcli kb upgrade --version {VERSION} --set upgradeAddons=true
  ```

  </TabItem>

</Tabs>

## Upgrade from KubeBlocks v0.8.x

This section covers upgrading from v0.8.x to v0.9.x, which requires additional preparation steps due to API changes.

:::note
**Key API Changes in v0.9.x:**

- Updated storage provider group from `storage.kubeblocks.io` to `dataprotection.kubeblocks.io`
- Improved ConfigConstraint API with multi-version support

:::

<Tabs>

  <TabItem value="Helm" label="Helm" default>

  **Step 1: Clean Up Incompatible Resources**

  Remove OpsDefinitions that are incompatible with v0.9.x:

  ```bash
  # delete opsdefinition one by one
  kubectl delete opsdefinitions.apps.kubeblocks.io kafka-quota kafka-topic kafka-user-acl switchover

  # Or, delete all opsdefinitions
  kubectl delete opsdefinitions.apps.kubeblocks.io --all
  ```

  **Step 2: Update Custom Resource Definitions (CRDs)**

  - Install Storage Provider CRD

    ```bash
    kubectl create -f https://github.com/apecloud/kubeblocks/releases/download/{VERSION}/dataprotection.kubeblocks.io_storageproviders.yaml
    ```

  - Update KubeBlocks CRDs

    ```bash
    kubectl replace -f https://github.com/apecloud/kubeblocks/releases/download/{VERSION}/kubeblocks_crds.yaml
    ```

  :::note
  **Network Optimization:**

  Or, download the CRD YAML file locally first, then apply it using `kubectl create -f <local-file-path>`.
  :::

  **Step 3: Update Helm Repository and Upgrade KubeBlocks**

  Update helm repository:

  ```bash
  helm repo add kubeblocks https://apecloud.github.io/helm-charts
  helm repo update kubeblocks
  ```

  Enable webhooks for multi-version conversion (it will convert ConfigConstraint API to the new version):

  ```bash
  helm -n kb-system upgrade kubeblocks kubeblocks/kubeblocks --version {VERSION} \
    --set admissionWebhooks.enabled=true \
    --set admissionWebhooks.ignoreReplicasCheck=true
  ```

  :::note
  **Configuration Options Explained:**

  - `admissionWebhooks.enabled=true`: Enables webhook for ConfigConstraint API multi-version conversion
  - `admissionWebhooks.ignoreReplicasCheck=true`: Allows webhook to run with single replica deployments
  :::

  **Step 4: (Optional) Upgrade Addons**

  :::warning
  **Addon Upgrade Impact:**

  Upgrading Addons may restart existing database clusters and affect availability. Only proceed during maintenance windows. Or you can upgrade Addons individually.
  :::

  ```bash
  helm -n kb-system upgrade kubeblocks kubeblocks/kubeblocks --version {VERSION} \
    --set upgradeAddons=true \
    --set admissionWebhooks.enabled=true \
    --set admissionWebhooks.ignoreReplicasCheck=true
  ```

  </TabItem>

  <TabItem value="kbcli" label="kbcli">

  **Step 1: Update kbcli**

  Download and install kbcli {VERSION}:

  ```bash
  curl -fsSL https://kubeblocks.io/installer/install_cli.sh | bash -s {VERSION}
  ```

  **Verify the installation:**
  ```bash
  kbcli version
  ```

  **Step 2: Upgrade KubeBlocks with Webhook Support**

  Enable webhooks for enhanced API validation and multi-version support:

  ```bash
  kbcli kb upgrade --version {VERSION} \
    --set admissionWebhooks.enabled=true \
    --set admissionWebhooks.ignoreReplicasCheck=true
  ```

  :::note
  **Configuration Options Explained:**

  - `admissionWebhooks.enabled=true`: Enables webhook for ConfigConstraint API multi-version conversion
  - `admissionWebhooks.ignoreReplicasCheck=true`: Allows webhook to run with single replica deployments
  :::

  **Step 3: (Optional) Upgrade Addons**

  :::warning
  **Addon Upgrade Impact:**

  Upgrading Addons may restart existing database clusters and affect availability. Only proceed during maintenance windows. Or you can upgrade Addons individually.
  :::

  ```bash
  kbcli kb upgrade --version {VERSION} \
    --set upgradeAddons=true \
    --set admissionWebhooks.enabled=true \
    --set admissionWebhooks.ignoreReplicasCheck=true
  ```

  </TabItem>

</Tabs>

Some Addons require special handling when upgrading from v0.8.x to v0.9.x.

- **Required**: The `mysql` Addon must be upgraded when moving from v0.8.x to v0.9.x. Clusters created in v0.8.x will not function properly in v0.9.x without this upgrade.
- **Recommended**: For `clickhouse`, `milvus`, `elasticsearch`, and `llm` Addons, upgrade KubeBlocks first, then upgrade these Addons for optimal functionality.

## Addon Upgrades

If you chose not to upgrade Addons during the KubeBlocks upgrade, or if you need to upgrade Addons on demand, follow these steps to upgrade Addons individually.

### Upgrade Methods

<Tabs>

  <TabItem value="Helm" label="Helm" default>

  **Step 1: Configure Addon Repository**

  ```bash
  # Add the primary Addon repository
  helm repo add kubeblocks-addons https://apecloud.github.io/helm-charts

  # Alternative repository for users in regions with limited GitHub access
  # helm repo add kubeblocks-addons https://jihulab.com/api/v4/projects/150246/packages/helm/stable

  # Update repository information
  helm repo update
  ```

  **Step 2: Find Available Versions**

  ```bash
  # Search for available versions of a specific Addon
  helm search repo kubeblocks-addons/{addon-name} --versions --devel
  # e.g. helm search repo kubeblocks-addons/mysql --versions --devel
  ```

  **Step 3: Upgrade the Addon**

  Pick the one that is compatible (of the same major versioin) with your KubeBlocks release and upgrade it.

  ```bash
  # Upgrade to a specific version
  helm upgrade -i {addon-release-name} kubeblocks-addons/{addon-name} --version x.y.z -n kb-system
  ```

  :::note
  - `{addon-name}`: Replace with the actual Addon name (e.g., `mysql`, `postgresql`)
  - `{addon-release-name}`: The release name of the installed Addon (e.g. `kb-addon-mysql`, `kb-addon-postgresql`)
  - `x.y.z`: The target version number, compatible with your KubeBlocks release
  :::

  </TabItem>

  <TabItem value="kbcli" label="kbcli">

  **Step 1: Update Addon Index**

  ```bash
  # List available Addon indexes, the default index is `kubeblocks`
  kbcli addon index list

  # Update the default KubeBlocks index
  kbcli addon index update kubeblocks
  ```

  **Step 2: Search for Available Addon Versions**

  ```bash
  # Search for available versions of a specific Addon
  kbcli addon search {addon-name}

  # View currently installed Addons and their versions.
  kbcli addon list | grep {addon-name}
  ```

  **Step 3: Upgrade the Addon**

  Pick the one that is compatible (of the same major versioin) with your KubeBlocks release and upgrade it.

  ```bash
  kbcli addon upgrade {addon-name} --version x.y.z
  ```

  **Force upgrade (use with caution):**
  ```bash
  kbcli addon upgrade {addon-name} --version x.y.z --force
  ```

  **Fresh installation (if not previously installed):**
  ```bash
  kbcli addon install {addon-name} --version x.y.z
  ```

  :::note
  Use `--force` only when necessary:
  - The standard upgrade fails due to version conflicts
  - You need to downgrade to a previous version
  :::

  </TabItem>

</Tabs>

### Addon Compatibility Issues

Some APIs, for example, the `ClusterVersion` CRD is marked as deprecated since v0.9.x.
Many Addons are using new APIs `ComponentDefinition`, `ComponentVersion` and `ClusterDefinition`, instead of `ClusterVersion` and `ClusterDefinition`, in their new version.

For example, the Kafka Addon v0.9.2, by checking its helm chart, you will find it has no `ClusterVersion` CR any more.
If you want to upgrade Kafka Addon from 0.9.0 to v0.9.2, you need to upgrade the Kafka Addons and upgrade clusters to the new version afterward. Otherwise, you will encounter compatibility issues.

To upgrade clusters, the key steps are:
1. Removes the `clusterVersionRef` field from the cluster spec
2. Removes the `componentDefRef` field from each component spec
3. Adds the new `componentDef` field
4. Adds the `serviceVersion` field, if necessary

In the following steps, we will use Kafka as an example.

**Step 1: Get the list of ComponentDefRefs used by Kafka**

```bash
kubectl get clusterdefinition kafka -oyaml  | yq '.spec.componentDefs[].name'
```

Expected output:
```bash
kafka-server
kafka-broker
controller
kafka-exporter
```

**Step 2: Upgrade Addon to the new version**

```bash
kbcli addon upgrade kafka --version 0.9.2
```

**Step 3: List ComponentDefinitions from the new Addon version**

For each `componentDefRef`, find its counter-part `ComponentDefinition` in the new Addon version.
```bash
kubectl get cmpd -l app.kubernetes.io/name=kafka
```

Expected output:
```bash
NAME               SERVICE            SERVICE-VERSION   STATUS      AGE
kafka-broker-2.8   kafka              2.8.2             Available   37m
kafka-broker-3.2   kafka              3.3.2             Available   37m
kafka-combine      kafka              3.3.2             Available   24h
kafka-controller   kafka-controller   3.3.2             Available   24h
kafka-exporter     kafka-exporter     1.6.0             Available   24h
kafka-zookeeper    kafka-zookeeper    3.7.2             Available   37m
```

Comparing with the output of the previous step, here is a mapping table of the `componentDefRef` and `ComponentDefinition`:

| v0.9.0 componentDefRef | v0.9.2 ComponentDefinition | serviceVersion |
|------------------------|---------------------------|
| N/A | kafka-broker-2.8 | 2.8.2 |
| kafka-broker | kafka-broker-3.2 | 3.3.2 |
| kafka-server | kafka-combine | 3.3.2 |
| controller | kafka-controller | 3.3.2 |
| kafka-exporter | kafka-exporter | 1.6.0 |
| N/A | kafka-zookeeper | 3.7.2 |


**Step 4: Identify the list of clusters to be upgraded**

```bash
# List all kafka clusters
kubectl get cluster --all-namespaces -l clusterdefinition.kubeblocks.io/name=kafka
```

For each cluster, you need to upgrade the component to the new version.

**Step 5: Clean Up ClusterVersion References and Update ComponentDefinitions**

```bash
#!/bin/bash
cluster="<clustername>"
namespace="<namespace>"

echo "Upgrading Kafka cluster: $cluster"

# Get current componentDefRef values to build the patch
arr=($(kubectl get -n $namespace cluster $cluster -o jsonpath="{.spec.componentSpecs[*].componentDefRef}"))

# Build the patch operations array
patch_ops="["

# Remove clusterDefinitionRef
patch_ops+='{
  "op": "remove",
  "path": "/spec/clusterDefinitionRef"
},'

# Remove clusterVersionRef
patch_ops+='{
  "op": "remove",
  "path": "/spec/clusterVersionRef"
},'

# Remove clusterVersionRef label, optional
patch_ops+='{
  "op": "remove",
  "path": "/metadata/labels/clusterversion.kubeblocks.io~1name"
},'

# Process each component to remove componentDefRef and add componentDef and serviceVersion
for i in "${!arr[@]}"; do
    case "${arr[i]}" in
        "kafka-broker")
            patch_ops+="{\"op\": \"remove\", \"path\": \"/spec/componentSpecs/$i/componentDefRef\"},"
            patch_ops+="{\"op\": \"add\", \"path\": \"/spec/componentSpecs/$i/componentDef\", \"value\": \"kafka-broker-3.2\"},"
            patch_ops+="{\"op\": \"add\", \"path\": \"/spec/componentSpecs/$i/serviceVersion\", \"value\": \"3.3.2\"},"
            ;;
        "kafka-server")
            patch_ops+="{\"op\": \"remove\", \"path\": \"/spec/componentSpecs/$i/componentDefRef\"},"
            patch_ops+="{\"op\": \"add\", \"path\": \"/spec/componentSpecs/$i/componentDef\", \"value\": \"kafka-combine\"},"
            patch_ops+="{\"op\": \"add\", \"path\": \"/spec/componentSpecs/$i/serviceVersion\", \"value\": \"3.3.2\"},"
            ;;
        "controller")
            patch_ops+="{\"op\": \"remove\", \"path\": \"/spec/componentSpecs/$i/componentDefRef\"},"
            patch_ops+="{\"op\": \"add\", \"path\": \"/spec/componentSpecs/$i/componentDef\", \"value\": \"kafka-controller\"},"
            patch_ops+="{\"op\": \"add\", \"path\": \"/spec/componentSpecs/$i/serviceVersion\", \"value\": \"3.3.2\"},"
            ;;
        "kafka-exporter")
            patch_ops+="{\"op\": \"remove\", \"path\": \"/spec/componentSpecs/$i/componentDefRef\"},"
            patch_ops+="{\"op\": \"add\", \"path\": \"/spec/componentSpecs/$i/componentDef\", \"value\": \"kafka-exporter\"},"
            patch_ops+="{\"op\": \"add\", \"path\": \"/spec/componentSpecs/$i/serviceVersion\", \"value\": \"1.6.0\"},"
            ;;
    esac
done

# Remove trailing comma and close the array
patch_ops="${patch_ops%,}]"
kubectl patch -n $namespace cluster "$cluster" --type='json' -p="$patch_ops"
```

You may need to modify the script w.r.t to the changes in the new Addon version, in particular, the `componentDefRef` and `ComponentDefinition` mapping table.

:::note
**Need Help**

If you encounter issues not covered here:
- Check the [KubeBlocks GitHub Issues](https://github.com/apecloud/kubeblocks/issues)
- Review upgrade logs using `kubectl -n kb-system logs deployment/kubeblocks`
:::