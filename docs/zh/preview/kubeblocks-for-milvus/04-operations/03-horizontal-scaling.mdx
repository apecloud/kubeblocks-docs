---
description: 了解如何通过OpsRequest和直接更新Cluster API，对KubeBlocks管理的Milvus集群执行水平扩缩容（扩容与缩容）。
keywords:
- KubeBlocks
- Milvus
- Horizontal Scaling
- Scale-Out
- Scale-In
- Kubernetes
sidebar_label: 水平扩展
sidebar_position: 3
title: 使用KubeBlocks实现Milvus集群的水平扩展
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';


# 使用KubeBlocks实现Milvus集群的水平扩缩容

本指南介绍如何对KubeBlocks管理的Milvus集群执行水平扩缩容（扩容和缩容）操作。您将学习如何使用**OpsRequest**和直接修改**Cluster API**两种方式实现这一目标。

## 先决条件

import Prerequisites from '../_tpl/_prerequisites.mdx'

<Prerequisites />

## 部署Milvus集群

请参考[使用KubeBlocks部署Milvus集群](../03-topologies/02-cluster)完成集群部署。

## 扩容（增加副本）

**预期工作流程**：
1. 新Pod被创建，状态从`Pending`转为`Running`
2. 集群状态从`Updating`变为`Running`

<Tabs>

  <TabItem value="opsRequest" label="OpsRequest API" default>

  方案一：使用水平扩容OpsRequest

  为milvus组件的querynode增加1个副本：

  ```yaml
  apiVersion: operations.kubeblocks.io/v1alpha1
  kind: OpsRequest
  metadata:
    name: milvus-cluster-scale-out-ops
    namespace: demo
  spec:
    clusterName: milvus-cluster
    type: HorizontalScaling
    horizontalScaling:
    - componentName: querynode
      # 指定组件扩容的副本变化量
      scaleOut:
        # 指定该组件的副本变化数
        # 当前组件增加1个副本
        replicaChanges: 1
  ```

  监控扩容操作进度：

  ```bash
  kubectl get ops milvus-cluster-scale-out-ops -n demo -w
  ```

  预期输出：
  ```bash
  NAME                             TYPE                CLUSTER          STATUS    PROGRESS   AGE
  milvus-cluster-scale-out-ops     HorizontalScaling   milvus-cluster   Running   0/1        9s
  milvus-cluster-scale-out-ops     HorizontalScaling   milvus-cluster   Running   1/1        16s
  milvus-cluster-scale-out-ops     HorizontalScaling   milvus-cluster   Succeed   1/1        16s
  ```
  </TabItem>

  <TabItem value="ClusterAPI" label="Cluster API">

  方案二：直接修改Cluster API

  您也可以直接修改Cluster资源中的`replicas`字段：

  ```yaml
  apiVersion: apps.kubeblocks.io/v1
  kind: Cluster
  spec:
    componentSpecs:
      - name: querynode
        replicas: 3 # 将副本数从2增加到3
  ...
  ```

  或者使用命令直接修改集群CR：

```bash
kubectl patch cluster milvus-cluster -n demo --type='json' -p='[
  {
    "op": "replace",
    "path": "/spec/componentSpecs/4/replicas",
    "value": 3
  }
]'
```
  </TabItem>
</Tabs>

### 验证扩容结果

操作完成后，您将看到新Pod被创建，Milvus集群状态从`Updating`变为`Running`，且新建Pod具有`secondary`角色。

```bash
kubectl get pods -n demo -l app.kubernetes.io/instance=milvus-cluster,apps.kubeblocks.io/component-name=querynode
```

示例输出：
```bash
NAME                         READY   STATUS    RESTARTS   AGE
milvus-cluster-querynode-0   1/1     Running   0          85m
milvus-cluster-querynode-1   1/1     Running   0          87m
milvus-cluster-querynode-2   1/1     Running   0          99m
```

## 缩容（减少副本）

**预期工作流程**：
1. 选择序号最大的副本进行移除
2. Pod被优雅终止
3. 集群状态从`Updating`变为`Running`

<Tabs>

  <TabItem value="opsRequest" label="OpsRequest API" default>

  方案一：使用水平缩容OpsRequest

  为milvus组件的querynode减少1个副本：

  ```yaml
  apiVersion: operations.kubeblocks.io/v1alpha1
  kind: OpsRequest
  metadata:
    name: milvus-cluster-scale-in-ops
    namespace: demo
  spec:
    clusterName: milvus-cluster
    type: HorizontalScaling
    horizontalScaling:
    - componentName: querynode
      # 指定组件缩容的副本变化量
      scaleIn:
        # 指定该组件的副本变化数
        # 当前组件减少1个副本
        replicaChanges: 1
  ```

  监控操作进度：
  ```bash
  kubectl get ops milvus-cluster-scale-in-ops -n demo -w
  ```

  预期输出：
  ```bash
  NAME                          TYPE                CLUSTER          STATUS    PROGRESS   AGE
  milvus-cluster-scale-in-ops   HorizontalScaling   milvus-cluster   Running   0/1        8s
  milvus-cluster-scale-in-ops   HorizontalScaling   milvus-cluster   Running   1/1        24s
  milvus-cluster-scale-in-ops   HorizontalScaling   milvus-cluster   Succeed   1/1        24s
  ```
  </TabItem>

  <TabItem value="ClusterAPI" label="Cluster API">

  方案二：直接修改Cluster API

  您也可以直接修改Cluster资源中的`replicas`字段：

  ```yaml
  apiVersion: apps.kubeblocks.io/v1
  kind: Cluster
  spec:
    componentSpecs:
      - name: milvus
        replicas: 2 # 将副本数从3减少到2
  ```

或使用命令直接修改集群CR：

```bash
kubectl patch cluster milvus-cluster -n demo --type='json' -p='[
{
    "op": "replace",
    "path": "/spec/componentSpecs/4/replicas",
    "value": 2
  }
]'
```

  </TabItem>

</Tabs>

### 验证缩容结果

示例输出（两个Pod）：
```bash
kubectl get pods -n demo -l app.kubernetes.io/instance=milvus-cluster
NAME                         READY   STATUS    RESTARTS   AGE
milvus-cluster-querynode-0   1/1     Running   0          101m
milvus-cluster-querynode-1   1/1     Running   0          102m
```

:::note

Milvus集群包含五个组件。本教程展示了如何对一个组件进行操作。
您可以用相同方式对其他组件执行扩缩容。

:::

## 最佳实践

执行水平扩缩容时：
- 尽可能选择低流量时段操作
- 扩缩容过程中监控集群健康状态
- 扩容前确保有足够的资源
- 考虑新副本的存储需求

## 清理资源
删除Milvus集群及其命名空间以清除所有资源：
```bash
kubectl delete cluster milvus-cluster -n demo
kubectl delete ns demo
```

## 总结
在本指南中您学会了：
- 执行扩容操作为Milvus集群增加副本
- 执行缩容操作减少Milvus集群副本
- 使用OpsRequest和直接修改Cluster API两种方式进行水平扩缩容

KubeBlocks能确保在最小化影响数据库服务的情况下实现无缝扩缩容。