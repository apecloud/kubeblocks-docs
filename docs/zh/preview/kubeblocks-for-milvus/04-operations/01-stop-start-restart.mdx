---
description: 了解如何在KubeBlocks中管理Milvus集群状态，包括停止、启动和重启操作，以优化资源使用。
keywords:
- KubeBlocks
- Milvus
- Cluster Management
- Stop
- Start
- Restart
sidebar_label: 生命周期管理
sidebar_position: 1
title: Milvus 集群生命周期管理（停止、启动、重启）
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Milvus 集群生命周期管理

本指南演示如何在 **KubeBlocks** 中管理 Milvus 集群的运行状态，包括：

- 停止集群以节省资源
- 启动已停止的集群
- 重启集群组件

这些操作有助于优化 Kubernetes 环境中的资源使用并降低运营成本。

KubeBlocks 中的生命周期管理操作：

| 操作       | 效果                     | 使用场景                 |
|------------|--------------------------|--------------------------|
| 停止       | 暂停集群，保留存储       | 成本节约、维护窗口       |
| 启动       | 恢复集群运行             | 暂停后恢复服务           |
| 重启       | 重新创建组件 Pod         | 配置变更、故障排查       |

## 前提条件

import Prerequisites from '../_tpl/_prerequisites.mdx'

<Prerequisites />

## 部署 Milvus 集群

请参考[使用 KubeBlocks 部署 Milvus 集群](../03-topologies/02-cluster)来部署一个 Milvus 集群。

## 集群生命周期操作

### 停止集群

在 KubeBlocks 中停止 Milvus 集群将：

1. 终止所有运行中的 Pod
2. 保留集群配置

此操作适用于：
- 临时节省成本
- 维护窗口期
- 开发环境暂停

<Tabs>

<TabItem value="opsRequest" label="OpsRequest API" default>

选项 1：OpsRequest API

创建停止操作请求：

```yaml
apiVersion: operations.kubeblocks.io/v1alpha1
kind: OpsRequest
metadata:
  name: milvus-cluster-stop-ops
  namespace: demo
spec:
  clusterName: milvus-cluster
  type: Stop
```
</TabItem>

<TabItem value="ClusterAPI" label="Cluster API">

选项 2：Cluster API

创建停止操作请求：

```yaml
apiVersion: operations.kubeblocks.io/v1alpha1
kind: OpsRequest
metadata:
  name: milvus-cluster-stop-ops
  namespace: demo
spec:
  clusterName: milvus-cluster
  type: Stop
```
</TabItem>
</Tabs>

### 验证集群停止

确认停止操作成功：

1. 检查集群状态转换：
    ```bash
    kubectl get cluster milvus-cluster -n demo -w
    ```
    示例输出：
    ```bash
    NAME             CLUSTER-DEFINITION  TERMINATION-POLICY   STATUS     AGE
    milvus-cluster   milvus              Delete               Stopping   6m33s
    milvus-cluster   milvus              Delete               Stopped    6m55s
    ```

2. 验证无运行中的 Pod：
    ```bash
    kubectl get pods -l app.kubernetes.io/instance=milvus-cluster -n demo
    ```
    示例输出：
    ```bash
    No resources found in demo namespace.
    ```

### 启动集群

启动已停止的 Milvus 集群：
1. 重新创建所有 Pod
3. 恢复服务端点

预期行为：
- 集群恢复到之前状态
- 不会发生数据丢失
- 服务自动恢复
<Tabs>

<TabItem value="opsRequest" label="OpsRequest API" default>

发起启动操作请求：

```yaml
apiVersion: operations.kubeblocks.io/v1alpha1
kind: OpsRequest
metadata:
  name: milvus-cluster-start-ops
  namespace: demo
spec:
  # 指定此操作目标集群资源的名称
  clusterName: milvus-cluster
  type: Start
```
</TabItem>
</Tabs>

### 验证集群启动

确认启动操作成功：

1. 检查集群状态转换：
    ```bash
    kubectl get cluster milvus-cluster -n demo -w
    ```
    示例输出：
    ```bash
    NAME             CLUSTER-DEFINITION   TERMINATION-POLICY   STATUS     AGE
    milvus-cluster   milvus               Delete               Updating   30m
    milvus-cluster   milvus               Delete               Updating   32m
    milvus-cluster   milvus               Delete               Updating   32m
    milvus-cluster   milvus               Delete               Running    33m
    milvus-cluster   milvus               Delete               Running    33m
    ```

2. 验证 Pod 重新创建：
    ```bash
    kubectl get pods -n demo -l app.kubernetes.io/instance=milvus-cluster
    ```
    示例输出：
    ```bash
    NAME                         READY   STATUS    RESTARTS   AGE
    milvus-cluster-datanode-0    1/1     Running   0          5m24s
    milvus-cluster-indexnode-0   1/1     Running   0          5m24s
    milvus-cluster-mixcoord-0    1/1     Running   0          5m24s
    milvus-cluster-proxy-0       1/1     Running   0          5m24s
    milvus-cluster-querynode-0   1/1     Running   0          5m24s
    milvus-cluster-querynode-1   1/1     Running   0          3m43s
    ```

### 重启集群

重启操作提供：
- 无需完全停止集群即可重新创建 Pod
- 组件级粒度控制
- 最小化服务中断

使用场景：
- 需要重启的配置变更
- 资源刷新
- 故障排查

**检查组件**

Milvus 集群包含五个组件。获取组件列表：
```bash
kubectl get cluster -n demo milvus-cluster -oyaml | yq '.spec.componentSpecs[].name'
```

预期输出：
```text
proxy
mixcoord
datanode
indexnode
querynode
```

**通过 OpsRequest API 重启 Proxy**

列出要重启的特定组件：

```yaml
apiVersion: operations.kubeblocks.io/v1alpha1
kind: OpsRequest
metadata:
  name: milvus-cluster-restart-ops
  namespace: demo
spec:
  clusterName: milvus-cluster
  type: Restart
  restart:
  - componentName: proxy
```

**验证重启完成**

确认组件重启成功：

1. 跟踪 OpsRequest 进度：
    ```bash
    kubectl get opsrequest milvus-cluster-restart-ops -n demo -w
    ```
    示例输出：
    ```bash
    NAME                         TYPE      CLUSTER          STATUS    PROGRESS   AGE
    milvus-cluster-restart-ops   Restart   milvus-cluster   Running   0/1        4s
    milvus-cluster-restart-ops   Restart   milvus-cluster   Running   1/1        2m12s
    milvus-cluster-restart-ops   Restart   milvus-cluster   Running   1/1        2m12s
    milvus-cluster-restart-ops   Restart   milvus-cluster   Succeed   1/1        2m12s
    ```

2. 检查 Pod 状态：
    ```bash
    kubectl get pods -n demo -l app.kubernetes.io/instance=milvus-cluster
    ```
    注意：重启后 Pod 将显示新的创建时间戳。只有属于 `proxy` 组件的 Pod 会被重启。

操作完成后，集群将返回 Running 状态。

## 总结
在本指南中，您学习了如何：
1. 停止 Milvus 集群以暂停操作，同时保留持久存储
2. 启动已停止的集群使其重新上线
3. 重启特定集群组件以重新创建其 Pod，而无需停止整个集群

通过管理 Milvus 集群的生命周期，您可以优化资源利用率、降低成本并在 Kubernetes 环境中保持灵活性。KubeBlocks 提供了一种无缝执行这些操作的方式，确保高可用性和最小化中断。