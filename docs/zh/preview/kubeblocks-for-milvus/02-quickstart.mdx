---
description: 使用KubeBlocks部署和管理Milvus ReplicaSet集群的完整指南，涵盖安装、配置及运维最佳实践。
keywords:
- Kubernetes
- Milvus
- KubeBlocks
- Helm
- Cluster Management
- QuickStart
sidebar_label: 快速入门
sidebar_position: 2
title: Milvus 快速入门
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Milvus 快速入门

本指南提供了使用 **KubeBlocks Milvus 插件** 部署和管理 Milvus ReplicaSet 集群的完整流程，内容包括：
- 系统前提条件与插件安装
- 集群创建与配置
- 运维管理（包括启动/停止流程）
- 连接方式与集群监控

## 前提条件

### 系统要求

开始前请确保环境满足以下要求：

- 可用的 Kubernetes 集群（推荐 v1.21+ 版本）
- 已安装 `kubectl` v1.21+ 并配置集群访问权限
- 已安装 Helm（[安装指南](https://helm.sh/docs/intro/install/)）
- 已安装 KubeBlocks（[安装指南](../user_docs/overview/install-kubeblocks)）

### 验证 Milvus 插件

Milvus 插件默认随 KubeBlocks 安装。检查其状态：

```bash
helm list -n kb-system | grep milvus
```

<details open>
<summary>示例输出：</summary>

```bash
NAME                  NAMESPACE   REVISION    UPDATED                     STATUS      CHART
kb-addon-milvus       kb-system   1           2025-05-21                  deployed    milvus-1.0.0
```
</details>

若插件未启用，请选择安装方式：

<Tabs>

  <TabItem value="helm" label="helm" default>
  ```bash
  # 添加 Helm 仓库
  helm repo add kubeblocks-addons https://apecloud.github.io/helm-charts
  # 中国大陆用户若 GitHub 访问困难或缓慢，可使用以下镜像仓库：
  #helm repo add kubeblocks-addons https://jihulab.com/api/v4/projects/150246/packages/helm/stable

  # 更新 Helm 仓库
  helm repo update
  # 搜索可用插件版本
  helm search repo kubeblocks/milvus --versions
  # 安装指定版本（将 <VERSION> 替换为所选版本）
  helm upgrade -i kb-addon-milvus kubeblocks-addons/milvus --version <VERSION> -n kb-system
  ```
  </TabItem>

  <TabItem value="kbcli" label="kbcli">

  ```bash
  # 添加索引（kubeblocks 索引默认已添加）
  kbcli addon index add kubeblocks https://github.com/apecloud/block-index.git
  # 更新索引
  kbcli addon index update kubeblocks
  # 更新所有索引
  kbcli addon index update --all
  ```

  搜索并安装插件：

  ```bash
  # 搜索插件
  kbcli addon search milvus
  # 安装指定版本插件（将 <VERSION> 替换为所选版本）
  kbcli addon install milvus --version <VERSION>
  ```
  **示例输出：**
  ```bash
  ADDON   VERSION          INDEX
  milvus   0.9.0           kubeblocks
  milvus   0.9.1           kubeblocks
  milvus   1.0.0           kubeblocks
  ```
  启用或禁用插件：

  ```bash
  # 启用插件
  kbcli addon enable milvus
  # 禁用插件
  kbcli addon disable milvus
  ```

  </TabItem>
</Tabs>

:::note
**版本兼容性**

请始终确保 Milvus 插件版本与 KubeBlocks 主版本匹配，以避免兼容性问题。

:::

### 验证支持的 Milvus 版本

**列出可用 Milvus 版本：**

```bash
kubectl get cmpv milvus
```
<details open>
<summary>示例输出</summary>
```text
NAME     VERSIONS   STATUS      AGE
milvus   v2.3.2     Available   26d
```
</details>

### 存储配置

Milvus 需要持久化存储。验证可用选项：

```bash
kubectl get storageclass
```

推荐存储特性：
- 最小 20Gi 容量
- ReadWriteOnce 访问模式
- 支持存储卷扩容
- 满足工作负载的性能需求

## 部署 Milvus 集群

使用默认设置部署一个基础的 Milvus 集群：

```bash
kubectl apply -f https://raw.githubusercontent.com/apecloud/kubeblocks-addons/refs/heads/main/examples/milvus/cluster-standalone.yaml
```

该操作将创建：
- 一个包含 3 个副本的 Milvus 集群，分别用于 milvus、etcd 和 minio 组件
- 默认资源分配（0.5 CPU，0.5Gi 内存）
- 20Gi 持久化存储

```yaml
apiVersion: apps.kubeblocks.io/v1
kind: Cluster
metadata:
  name: milvus-standalone
  namespace: demo
spec:
  # 指定删除集群时的行为策略
  # 有效选项为：[DoNotTerminate, Delete, WipeOut]（自 KB 0.9 起 `Halt` 已弃用）
  # - `DoNotTerminate`：阻止集群删除。此策略确保所有资源保持完整
  # - `Delete`：在 `Halt` 策略基础上还会移除 PVC，实现包括持久化数据在内的彻底清理
  # - `WipeOut`：激进策略，会删除包括外部存储中的卷快照和备份在内的所有集群资源。这将导致数据完全删除，应谨慎使用，主要适用于非生产环境以避免不可逆的数据丢失
  terminationPolicy: Delete
  # 指定创建集群时使用的 ClusterDefinition 名称
  # 注意：请勿更新此字段
  # 该值必须设为 `milvus` 才能创建 Milvus 集群
  clusterDef: milvus
  # 指定创建集群时使用的 ClusterTopology 名称
  # 有效选项为：[standalone,cluster]
  topology: standalone
  # 指定构成集群的组件规格列表
  # 该字段允许对集群中的每个组件进行详细配置
  componentSpecs:
    - name: etcd
      replicas: 1
      resources:
        limits:
          cpu: "0.5"
          memory: "0.5Gi"
        requests:
          cpu: "0.5"
          memory: "0.5Gi"
      volumeClaimTemplates:
        - name: data
          spec:
            storageClassName: ""
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
    - name: minio
      replicas: 1
      resources:
        limits:
          cpu: "0.5"
          memory: "0.5Gi"
        requests:
          cpu: "0.5"
          memory: "0.5Gi"
      volumeClaimTemplates:
        - name: data
          spec:
            storageClassName: ""
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
    - name: milvus
      replicas: 1
      resources:
        limits:
          cpu: "0.5"
          memory: "0.5Gi"
        requests:
          cpu: "0.5"
          memory: "0.5Gi"
      volumeClaimTemplates:
        - name: data
          spec:
            storageClassName: ""
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
```

更多 API 字段及描述，请参阅 [API 参考](../user_docs/references/api-reference/cluster)。

## 验证集群状态

当部署包含3个副本的Milvus集群时，请通过以下方式确认部署成功：

1. 集群状态为`Running`（运行中）
2. 所有Pod均正常运行

可通过以下任一方式检查状态：

<Tabs>
  <TabItem value='kubectl' label='kubectl' default>
```bash
kubectl get cluster milvus-standalone -n demo -w
NAME                CLUSTER-DEFINITION   TERMINATION-POLICY   STATUS     AGE
milvus-standalone   milvus               Delete               Creating   27s
milvus-standalone   milvus               Delete               Running    64s

kubectl get pods -l app.kubernetes.io/instance=milvus-standalone -n demo
NAME                         READY   STATUS    RESTARTS   AGE
milvus-standalone-etcd-0     2/2     Running   0          25m
milvus-standalone-milvus-0   1/1     Running   0          24m
milvus-standalone-minio-0    1/1     Running   0          25m
```
  </TabItem>

  <TabItem value='kbcli' label='kbcli'>

  安装`kbcli`后，可查看完整的集群信息：

```bash
kbcli cluster describe milvus-standalone -n demo

名称: milvus-standalone	 创建时间: 2025年5月19日 11:03 UTC+0800
命名空间   集群定义        拓扑结构     状态      终止策略
demo      milvus          standalone   Running   Delete

访问端点:
组件        内部地址   外部地址

拓扑结构:
组件      服务版本      实例名称                    角色     状态     可用区    节点     创建时间
etcd      3.5.15       milvus-standalone-etcd-0     leader   Running  zone-x   x.y.z   2025年5月19日 11:03 UTC+0800
milvus    v2.3.2       milvus-standalone-milvus-0   <无>    Running  zone-x   x.y.z   2025年5月19日 11:04 UTC+0800
minio     8.0.17       milvus-standalone-minio-0    <无>    Running  zone-x   x.y.z   2025年5月19日 11:03 UTC+0800

资源分配:
组件      实例模板    CPU(请求/限制)    内存(请求/限制)     存储大小     存储类
etcd                 500m / 500m       512Mi / 512Mi      data:10Gi   <无>
minio                500m / 500m       512Mi / 512Mi      data:10Gi   <无>
milvus               500m / 500m       512Mi / 512Mi      data:10Gi   <无>

镜像信息:
组件      组件定义                  镜像地址
etcd      etcd-3-1.0.0             quay.io/coreos/etcd:v3.5.15
minio     milvus-minio-1.0.0       docker.io/minio/minio:RELEASE.2022-03-17T06-34-49Z
milvus    milvus-standalone-1.0.0  docker.io/milvusdb/milvus:v2.3.2

数据保护:
备份仓库   自动备份   备份计划   备份方法   备份保留期   可恢复时间

查看集群事件: kbcli cluster list-events -n demo milvus-standalone
```

  </TabItem>
</Tabs>

## 访问 Milvus

要访问 Milvus 服务，您可以通过创建服务来暴露该服务：

```bash
kubectl port-forward pod/milvus-standalone-milvus-0 -n demo 19530:19530
```

之后，您可以通过 `localhost:19530` 访问 Milvus 服务。

## 停止 Milvus 集群

停止集群会暂时暂停运行，同时保留所有数据和配置：

**关键影响：**
- 计算资源（Pod）会被释放
- 持久化存储（PVC）保持完整
- 服务定义得以保留
- 集群配置不会丢失
- 降低运行成本

<Tabs>
  <TabItem value="OpsRequest" label="OpsRequest API" default>

  ```yaml
  apiVersion: operations.kubeblocks.io/v1alpha1
  kind: OpsRequest
  metadata:
    name: milvus-stop
    namespace: demo
  spec:
    clusterName: milvus-standalone
    type: Stop
  ```
  </TabItem>

  <TabItem value="ClusterAPI" label="Cluster API">
  也可以通过设置 `spec.componentSpecs.stop` 为 true 来停止集群：

  ```bash
  kubectl patch cluster milvus-standalone -n demo --type='json' -p='[
  {
    "op": "add",
    "path": "/spec/componentSpecs/0/stop",
    "value": true
  },
  {
    "op": "add",
    "path": "/spec/componentSpecs/1/stop",
    "value": true
  },
  {
    "op": "add",
    "path": "/spec/componentSpecs/2/stop",
    "value": true
  }
  ]'
  ```
  </TabItem>
</Tabs>

## 启动 Milvus 集群

重启已停止的集群可恢复运行，所有数据和配置将保持完整。

**关键影响：**
- 计算资源（Pod）会被重新创建
- 服务将再次可用
- 集群恢复到之前的状态

<Tabs>
  <TabItem value="OpsRequest" label="OpsRequest API" default>
  ```yaml
  apiVersion: operations.kubeblocks.io/v1alpha1
  kind: OpsRequest
  metadata:
    name: milvus-start
    namespace: demo
  spec:
    clusterName: milvus-standalone
    type: Start
  ```
  </TabItem>

  <TabItem value="ClusterAPI" label="Cluster API">
  通过将 `spec.componentSpecs.stop` 设置为 false 来重启集群：

  ```bash
  kubectl patch cluster milvus-standalone -n demo --type='json' -p='[
  {
    "op": "remove",
    "path": "/spec/componentSpecs/0/stop"
  },
  {
    "op": "remove",
    "path": "/spec/componentSpecs/1/stop"
  },
  {
    "op": "remove",
    "path": "/spec/componentSpecs/2/stop"
  }
  ]'
  ```
  </TabItem>
</Tabs>

## 删除 Milvus 集群

请根据数据保留需求谨慎选择删除策略：

| 策略            | 删除的资源          | 删除的数据          | 适用场景                  |
|-----------------|-------------------|-------------------|-------------------------|
| DoNotTerminate  | 无                | 无                | 关键生产环境集群          |
| Delete          | 所有资源           | PVC存储卷         | 非关键环境                |
| WipeOut         | 所有资源           | 全部数据*          | 仅限测试环境              |

*包含外部存储中的快照和备份

**删除前检查清单：**
1. 确认没有应用程序正在使用该集群
2. 确保已存在必要的备份
3. 确认terminationPolicy设置正确
4. 检查是否存在依赖资源

对于测试环境，可使用以下命令进行完整清理：

```bash
kubectl patch cluster milvus-standalone -p '{"spec":{"terminationPolicy":"WipeOut"}}' --type="merge" -n demo
kubectl delete cluster milvus-standalone -n demo
```