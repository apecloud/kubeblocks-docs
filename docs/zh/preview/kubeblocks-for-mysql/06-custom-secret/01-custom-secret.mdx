---
description: 了解如何在KubeBlocks上部署MySQL集群，并通过Kubernetes Secrets安全配置自定义root密码。
keywords:
- MySQL
- KubeBlocks
- Custom Password
- Kubernetes
- Secrets
sidebar_label: 自定义密码
sidebar_position: 1
title: 在KubeBlocks上创建带自定义root密码的MySQL集群
---
# 在 KubeBlocks 中使用自定义密码创建 MySQL 集群

本指南演示如何在 KubeBlocks 中部署 MySQL 集群，并将自定义 root 密码存储在 Kubernetes Secret 中。

## 前提条件

在继续之前，请确保满足以下要求：
- 环境准备：
    - 已启动并运行一个 Kubernetes 集群。
    - 已配置 kubectl CLI 工具以与集群通信。
    - 已安装 [KubeBlocks CLI](../../user_docs/references/install-kbcli) 和 [KubeBlocks Operator](../../user_docs/overview/install-kubeblocks)。请按照此处提供的安装说明进行操作。
- 命名空间准备：为保持资源隔离，请为本教程创建一个专用命名空间：

```bash
kubectl create ns demo
```

预期输出：

```bash
namespace/demo created
```




## 部署 MySQL 半同步集群

KubeBlocks 采用声明式方法管理 MySQL 集群。以下是一个配置示例，用于部署包含 2 个节点（1 个主节点，1 个副本节点）的半同步模式 MySQL 集群，并设置自定义 root 密码。

### 步骤 1：为 root 账户创建 Secret

自定义 root 密码存储在 Kubernetes Secret 中。通过应用以下 YAML 创建 Secret：

```yaml
kubectl apply -f - <<EOF
apiVersion: v1
data:
  password: Y3VzdG9tcGFzc3dvcmQ= # custompassword
  username: cm9vdA== #root
immutable: true
kind: Secret
metadata:
  name: custom-mysql-root-secret
  namespace: demo
EOF
```

- password: 将 custompassword 替换为您所需的密码，并使用 Base64 编码（`echo -n "custompassword" | base64`）。
- username: 默认 MySQL root 用户为 'root'，编码为 'cm9vdA=='。


### 步骤 2：部署 MySQL 集群

应用以下清单以部署 MySQL 集群，引用步骤 1 中为 root 账户创建的 Secret：

```yaml
kubectl apply -f - <<EOF
apiVersion: apps.kubeblocks.io/v1
kind: Cluster
metadata:
  name: example-mysql-cluster
  namespace: demo
spec:
  clusterDef: mysql
  topology: semisync
  terminationPolicy: Delete
  componentSpecs:
    - name: mysql
      serviceVersion: 8.0.35
      replicas: 2
      systemAccounts:
        - name: root
          secretRef:
            name: custom-mysql-root-secret
            namespace: demo
      resources:
        limits:
          cpu: '0.5'
          memory: 0.5Gi
        requests:
          cpu: '0.5'
          memory: 0.5Gi
      volumeClaimTemplates:
        - name: data
          spec:
            storageClassName: ""
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
EOF
```




## 验证部署

集群部署完成后，运行以下命令检查其状态：

```bash
kubectl get cluster example-mysql-cluster -n demo -w
```

预期输出：

```bash
NAME                          CLUSTER-DEFINITION   TERMINATION-POLICY   STATUS     AGE
example-mysql-cluster   mysql                Delete               Creating   19s
example-mysql-cluster   mysql                Delete               Running    1m
```

等待直到 STATUS 状态变为 'Running'。

## 连接到 MySQL 集群
KubeBlocks 会自动创建一个包含 MySQL root 凭据的 Secret。通过以下命令获取凭据：

```bash
kubectl get secrets -n demo example-mysql-cluster-mysql-account-root -o jsonpath='{.data.username}' | base64 -d
root

kubectl get secrets -n demo example-mysql-cluster-mysql-account-root -o jsonpath='{.data.password}' | base64 -d
custompassword
```

要连接到集群的主节点，请使用 MySQL 客户端并输入自定义密码：

```bash
kubectl exec -it -n demo example-mysql-cluster-mysql-0 -c mysql -- mysql -h example-mysql-cluster-mysql.demo.svc.cluster.local -uroot -pcustompassword
```




## 清理
要删除所有已创建的资源，请连同其命名空间一起删除 MySQL 集群：

```bash
kubectl delete cluster example-mysql-cluster -n demo
kubectl delete secret custom-mysql-root-secret -n demo
kubectl delete ns demo
```




## 总结
在本指南中，您完成了以下操作：
- 创建了一个 Kubernetes Secret 来安全存储自定义的 MySQL root 密码。
- 在 KubeBlocks 中使用自定义 root 密码部署了一个 MySQL 集群。
- 验证了部署并通过 MySQL 客户端连接到集群的主节点。

使用 Kubernetes Secret 可以确保 MySQL 集群的凭据管理安全，而 KubeBlocks 则简化了部署和管理流程。