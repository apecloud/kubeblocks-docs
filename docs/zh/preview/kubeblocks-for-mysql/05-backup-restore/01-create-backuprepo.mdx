---
description: 了解如何为KubeBlocks创建并配置一个使用S3存储桶存放备份数据的BackupRepo。
keywords:
- KubeBlocks
- Backup
- BackupRepo
- S3
- Kubernetes
sidebar_label: 创建备份仓库
sidebar_position: 1
title: 为KubeBlocks创建备份存储库
---
# 为 KubeBlocks 创建 BackupRepo

本指南将引导您通过使用 S3 存储桶来创建和配置 KubeBlocks 中的 BackupRepo，用于存储备份数据。

## 前提条件
- 已配置具有创建 S3 存储桶权限的 AWS CLI
- 拥有 Kubernetes 集群的 kubectl 访问权限
- 已安装并运行 KubeBlocks（[安装指南](../user_docs/overview/install-kubeblocks)）

## 步骤 1：创建 S3 存储桶

使用 AWS CLI 在目标区域创建 S3 存储桶。将 `<your-region>` 替换为您所需的 AWS 区域（例如 `us-east-1`、`ap-southeast-1`）。

（严格保持原文格式与换行）

```bash
aws s3api create-bucket --bucket kubeblocks-backup-repo --region <your-region> --create-bucket-configuration LocationConstraint=<your-region>
```

示例（适用于 us-west-1 区域）：

```bash
aws s3api create-bucket \
  --bucket kubeblocks-backup-repo \
  --region us-west-1 \
  --create-bucket-configuration LocationConstraint=us-west-1
```

示例输出：

```json
{
"Location": "http://kubeblocks-backup-repo.s3.amazonaws.com/"
}
```

验证：
通过列出存储桶内容确认其已创建（初始状态下应为空）：

```bash
aws s3 ls s3://kubeblocks-backup-repo
```




## 步骤 2：为 AWS 凭证创建 Kubernetes Secret

将您的 AWS 凭证安全地存储在 Kubernetes Secret 中。请将 `<ACCESS_KEY>` 和 `<SECRET_KEY>` 替换为实际的 AWS 凭证：

```bash
# Create a secret to save the access key
kubectl create secret generic s3-credential-for-backuprepo \
  --from-literal=accessKeyId=<ACCESS KEY> \
  --from-literal=secretAccessKey=<SECRET KEY> \
  -n kb-system
```




## 步骤 3：配置备份仓库

BackupRepo 是一种自定义资源，用于定义备份的存储仓库。在此步骤中，您将通过创建 BackupRepo 资源将您的 S3 存储桶与 KubeBlocks 集成。

应用以下 YAML 来创建 BackupRepo。请将字段（例如存储桶名称、区域）替换为您的具体配置。

```yaml
kubectl apply -f - <<EOF
apiVersion: dataprotection.kubeblocks.io/v1alpha1
kind: BackupRepo
metadata:
  name: s3-repo
  annotations:
    dataprotection.kubeblocks.io/is-default-repo: 'true'
spec:
  # Currently, KubeBlocks supports configuring various object storage services as backup repositories
  # - s3 (Amazon Simple Storage Service)
  # - oss (Alibaba Cloud Object Storage Service)
  # - cos (Tencent Cloud Object Storage)
  # - gcs (Google Cloud Storage)
  # - obs (Huawei Cloud Object Storage)
  # - minio, and other S3-compatible services.
  storageProviderRef: s3
  # Specifies the access method of the backup repository.
  # - Tool
  # - Mount
  accessMethod: Tool
  # Specifies reclaim policy of the PV created by this backup repository.
  pvReclaimPolicy: Retain
  # Specifies the capacity of the PVC created by this backup repository.
  volumeCapacity: 100Gi
  # Stores the non-secret configuration parameters for the StorageProvider.
  config:
    bucket: kubeblocks-backup-repo
    endpoint: ''
    mountOptions: --memory-limit 1000 --dir-mode 0777 --file-mode 0666
    region: us-west-1
  # References to the secret that holds the credentials for the StorageProvider.
  credential:
    # name is unique within a namespace to reference a secret resource.
    name: s3-credential-for-backuprepo
    # namespace defines the space within which the secret name must be unique.
    namespace: kb-system
EOF
```




## 步骤4：验证备份仓库状态

检查 BackupRepo 的状态以确保其已正确初始化：

```bash
kubectl get backuprepo s3-repo -w
```

预期状态流转：

```bash
NAME      STATUS        STORAGEPROVIDER   ACCESSMETHOD   DEFAULT   AGE
s3-repo   PreChecking   s3                Tool           true      5s
s3-repo   Ready         s3                Tool           true      35s
```

故障排除：
 - 如果状态变为 Failed（失败）：
   - 验证存储桶名称和区域是否与您的 S3 配置匹配。
   - 确认 Secret 中的 AWS 凭证是否正确。
   - 检查 KubeBlocks 与 AWS S3 之间的网络连接。