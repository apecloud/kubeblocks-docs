---
description: 了解如何通过`parallelPodManagementConcurrency`参数在KubeBlocks中配置MySQL集群，以控制Pod在创建、扩缩容及删除过程中的并行度。
keywords:
- KubeBlocks
- MySQL
- Pod Management
- Parallelism
- Kubernetes
sidebar_label: Pod 管理并行度
sidebar_position: 3
title: 在KubeBlocks中配置MySQL集群并控制Pod创建、扩缩容及删除的并行度
---
# 在 KubeBlocks 中配置 MySQL 集群的 Pod 创建、扩缩容及删除并行度控制

本指南演示如何使用 `parallelPodManagementConcurrency` 参数控制 KubeBlocks 中 MySQL 集群的 Pod 创建、扩缩容及删除并行度。通过定义可并行管理的 Pod 最大数量，用户可以在操作速度与系统稳定性之间取得平衡。与 StatefulSet 中仅提供两种固定选项（`OrderedReady` 或 `Parallel`）的 `podManagementPolicy` 不同，`parallelPodManagementConcurrency` 提供了更高的灵活性，使其同时适用于资源敏感型环境和生产环境。

## 前提条件

在继续之前，请确保满足以下要求：
- 环境设置：
    - 已启动并运行一个 Kubernetes 集群。
    - 已配置 kubectl CLI 工具以与集群通信。
    - 已安装 [KubeBlocks CLI](../../user_docs/references/install-kbcli) 和 [KubeBlocks Operator](../../user_docs/overview/install-kubeblocks)。请按照此处的安装说明进行操作。
- 命名空间准备：为保持资源隔离，请为本教程创建一个专用命名空间：

```bash
kubectl create ns demo
namespace/demo created
```




## 部署 MySQL 半同步集群

部署一个 2 节点的半同步 MySQL 集群（1 个主节点，1 个从节点），并将 `parallelPodManagementConcurrency` 参数设置为 1 以强制顺序创建 Pod。

```yaml
kubectl apply -f - <<EOF
apiVersion: apps.kubeblocks.io/v1
kind: Cluster
metadata:
  name: example-mysql-cluster
  namespace: demo
spec:
  clusterDef: mysql
  topology: semisync
  terminationPolicy: Delete
  componentSpecs:
    - name: mysql
      serviceVersion: 8.0.35
      replicas: 2
      parallelPodManagementConcurrency: 1
      resources:
        limits:
          cpu: '0.5'
          memory: 0.5Gi
        requests:
          cpu: '0.5'
          memory: 0.5Gi
      volumeClaimTemplates:
        - name: data
          spec:
            storageClassName: ""
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
EOF
```

**关键参数：**
- `parallelPodManagementConcurrency` 参数设置为 1，确保 Pod 按顺序创建而非并行创建。

## 监控 Pod 创建
运行以下命令来监控 demo 命名空间中 MySQL Pod 的创建和初始化过程：

```bash
kubectl get pods -n demo -w
```



```bash
NAME                            READY   STATUS    RESTARTS   AGE
example-mysql-cluster-mysql-0   0/4     Pending   0          1s
example-mysql-cluster-mysql-0   0/4     Pending   0          3s
example-mysql-cluster-mysql-0   0/4     Init:0/5   0          3s
example-mysql-cluster-mysql-0   0/4     Init:1/5   0          9s
example-mysql-cluster-mysql-0   0/4     Init:2/5   0          10s
example-mysql-cluster-mysql-0   0/4     Init:3/5   0          11s
example-mysql-cluster-mysql-0   0/4     Init:4/5   0          12s
example-mysql-cluster-mysql-0   0/4     PodInitializing   0          13s
example-mysql-cluster-mysql-0   3/4     Running           0          14s
example-mysql-cluster-mysql-0   3/4     Running           0          15s
example-mysql-cluster-mysql-0   3/4     Running           0          18s
example-mysql-cluster-mysql-0   4/4     Running           0          19s
example-mysql-cluster-mysql-1   0/4     Pending           0          0s
example-mysql-cluster-mysql-1   0/4     Pending           0          3s
example-mysql-cluster-mysql-1   0/4     Init:0/5          0          3s
example-mysql-cluster-mysql-1   0/4     Init:1/5          0          7s
example-mysql-cluster-mysql-1   0/4     Init:2/5          0          8s
example-mysql-cluster-mysql-1   0/4     Init:3/5          0          9s
example-mysql-cluster-mysql-1   0/4     Init:4/5          0          10s
example-mysql-cluster-mysql-1   0/4     PodInitializing   0          11s
example-mysql-cluster-mysql-1   3/4     Running           0          12s
example-mysql-cluster-mysql-1   3/4     Running           0          13s
example-mysql-cluster-mysql-0   4/4     Running           0          35s
example-mysql-cluster-mysql-1   3/4     Running           0          17s
example-mysql-cluster-mysql-1   4/4     Running           0          17s
```

***关键观察结果：***
- 'example-mysql-cluster-mysql-0' 在 'example-mysql-cluster-mysql-1' 开始初始化前完成初始化并进入 Running 状态。
- 这种顺序行为由 `parallelPodManagementConcurrency` 参数控制。



## 集群水平扩展

要将集群扩展至 4 个副本，请使用以下配置：



```yaml
kubectl apply -f - <<EOF
apiVersion: apps.kubeblocks.io/v1
kind: Cluster
metadata:
  name: example-mysql-cluster
  namespace: demo
spec:
  clusterDef: mysql
  topology: semisync
  terminationPolicy: Delete
  componentSpecs:
    - name: mysql
      serviceVersion: 8.0.35
      replicas: 4
      parallelPodManagementConcurrency: 1
      resources:
        limits:
          cpu: '0.5'
          memory: 0.5Gi
        requests:
          cpu: '0.5'
          memory: 0.5Gi
      volumeClaimTemplates:
        - name: data
          spec:
            storageClassName: ""
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
EOF
```

示例输出：

```bash
kubectl get pods -n demo -w
NAME                            READY   STATUS     RESTARTS   AGE
example-mysql-cluster-mysql-0   4/4     Running    0          32m
example-mysql-cluster-mysql-1   4/4     Running    0          29m
example-mysql-cluster-mysql-2   0/4     Init:0/5   0          4s
example-mysql-cluster-mysql-2   0/4     Init:0/5   0          23s
example-mysql-cluster-mysql-2   0/4     Init:1/5   0          24s
example-mysql-cluster-mysql-2   0/4     Init:1/5   0          32s
example-mysql-cluster-mysql-2   0/4     Init:2/5   0          33s
example-mysql-cluster-mysql-2   0/4     Init:2/5   0          42s
example-mysql-cluster-mysql-2   0/4     Init:3/5   0          43s
example-mysql-cluster-mysql-2   0/4     Init:4/5   0          52s
example-mysql-cluster-mysql-2   0/4     Init:4/5   0          60s
example-mysql-cluster-mysql-2   0/4     PodInitializing   0          61s
example-mysql-cluster-mysql-2   3/4     Running           0          93s
example-mysql-cluster-mysql-2   3/4     Running           0          93s
example-mysql-cluster-mysql-2   3/4     Running           0          100s
example-mysql-cluster-mysql-2   4/4     Running           0          101s
example-mysql-cluster-mysql-3   0/4     Pending           0          0s
example-mysql-cluster-mysql-3   0/4     Pending           0          3s
example-mysql-cluster-mysql-3   0/4     Init:0/5          0          3s
example-mysql-cluster-mysql-3   0/4     Init:1/5          0          12s
example-mysql-cluster-mysql-3   0/4     Init:2/5          0          13s
example-mysql-cluster-mysql-3   0/4     Init:3/5          0          14s
example-mysql-cluster-mysql-3   0/4     Init:4/5          0          15s
example-mysql-cluster-mysql-3   0/4     PodInitializing   0          16s
example-mysql-cluster-mysql-3   3/4     Running           0          17s
example-mysql-cluster-mysql-3   3/4     Running           0          18s
example-mysql-cluster-mysql-3   3/4     Running           0          21s
example-mysql-cluster-mysql-3   4/4     Running           0          21s
```

**关键观察：**
- 新 Pod（'example-mysql-cluster-mysql-2' 和 'example-mysql-cluster-mysql-3'）按顺序创建，遵循与初始部署相同的模式。
- 每个 Pod 完成初始化后，下一个 Pod 才会开始创建。



## 集群缩容

要将集群缩减回 2 个副本，请应用以下配置：



```yaml
kubectl apply -f - <<EOF
apiVersion: apps.kubeblocks.io/v1
kind: Cluster
metadata:
  name: example-mysql-cluster
  namespace: demo
spec:
  clusterDef: mysql
  topology: server
  terminationPolicy: Delete
  componentSpecs:
    - name: mysql
      serviceVersion: 8.0.35
      replicas: 2
      parallelPodManagementConcurrency: 1
      resources:
        limits:
          cpu: '0.5'
          memory: 0.5Gi
        requests:
          cpu: '0.5'
          memory: 0.5Gi
      volumeClaimTemplates:
        - name: data
          spec:
            storageClassName: ""
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
EOF
```

示例输出：

```bash
kubectl get pods -n demo -w
NAME                            READY   STATUS    RESTARTS   AGE
example-mysql-cluster-mysql-0   4/4     Running   0          36m
example-mysql-cluster-mysql-1   4/4     Running   0          34m
example-mysql-cluster-mysql-2   4/4     Running   0          48s
example-mysql-cluster-mysql-3   4/4     Running   0          31s
example-mysql-cluster-mysql-3   4/4     Terminating   0          51s
example-mysql-cluster-mysql-3   0/4     Completed     0          53s
example-mysql-cluster-mysql-3   0/4     Completed     0          54s
example-mysql-cluster-mysql-3   0/4     Completed     0          54s
example-mysql-cluster-mysql-2   4/4     Terminating   0          71s
example-mysql-cluster-mysql-2   0/4     Completed     0          73s
example-mysql-cluster-mysql-2   0/4     Completed     0          74s
example-mysql-cluster-mysql-2   0/4     Completed     0          74s
```

**关键观察：**
- Pod 会按顺序终止，其模式与创建和扩展时相同。

## 清理
要删除所有已创建的资源，请连同其命名空间一起删除 MySQL 集群：

```bash
kubectl delete cluster example-mysql-cluster -n demo
kubectl delete ns demo
```





## parallelPodManagementConcurrency 参数说明
`parallelPodManagementConcurrency` 参数定义了可以并行创建或删除的 Pod 的最大数量。

### 行为表现：
- 设置为 1 时：强制按顺序执行 Pod 的创建、扩缩容和删除操作。此行为确保主节点 Pod 必须完全初始化后，从节点 Pod 才会启动。
- 设置为更高值（如 2、3）时：允许多个 Pod 同时创建或删除，但不超过指定的并发限制。
- 未设置时（默认行为）：所有 Pod 将以完全并行的方式创建或删除，无任何并发限制。

该参数与 StatefulSet 的 `podManagementPolicy` 类似。但 StatefulSet 的 `podManagementPolicy` 仅提供两种选项：完全有序（'OrderedReady'）或完全并行（'Parallel'）。相比之下，`parallelPodManagementConcurrency` 提供了更细粒度的控制。

### 为何使用 parallelPodManagementConcurrency？
此参数提供了对 Pod 管理的细粒度控制，允许您根据应用需求在速度与稳定性之间取得平衡。以下是主要优势：

- **避免资源争用**：在资源有限的集群中，并行创建多个 Pod 可能导致资源竞争，使部分 Pod 长期处于 Pending 状态。顺序创建可确保资源均匀分配，避免集群过载。

- **简化调试**：顺序创建更易于问题定位和解决。若某个 Pod 因错误无法启动，可在继续前修复问题，避免同时出现多个故障，简化排障流程。

- **提升稳定性**：对于扩缩容或更新操作，逐个创建 Pod 能确保依赖关系得到遵守，降低有状态应用出现冲突或不稳定的风险。

- **防止服务中断**：顺序创建确保每个 Pod 完全就绪后才启动下一个，维持服务可用性并避免停机，特别适合对就绪状态有严格要求的应用。

## 总结

通过本指南，我们演示了：
- 如何配置 `parallelPodManagementConcurrency` 以实现 Pod 的顺序创建、扩缩容和删除。
- 顺序管理 Pod 的优势，例如避免资源争用、简化调试流程以及提升系统稳定性。
- 如何通过控制 Pod 并行度来实现 MySQL 集群的扩容和缩容。

使用 `parallelPodManagementConcurrency`，您可以根据工作负载的特殊需求优化 Pod 管理，同时确保高可用性和高效的资源利用率。