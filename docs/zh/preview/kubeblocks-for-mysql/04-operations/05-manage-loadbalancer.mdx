---
description: 了解如何在KubeBlocks中通过负载均衡器及其他服务类型配置和管理MySQL服务，实现内外网访问。
keywords:
- KubeBlocks
- MySQL
- LoadBalancer
- External Service
- Expose
- Kubernetes
sidebar_label: 管理 MySQL 服务
sidebar_position: 5
title: 使用KubeBlocks声明式集群API创建与销毁MySQL服务
---
请严格保持所有格式、间距和换行符不变，翻译以下内容：

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';


# 使用 KubeBlocks 声明式集群 API 管理 MySQL 服务

本指南提供逐步说明，介绍如何对外或对内暴露由 KubeBlocks 管理的 MySQL 服务。您将学习如何通过云提供商的 LoadBalancer 服务配置外部访问、管理内部服务，以及在不再需要时正确禁用外部暴露。

## 前提条件

在继续之前，请确保满足以下要求：
- 环境准备：
    - 已启动并运行一个 Kubernetes 集群。
    - 已配置 kubectl CLI 工具以与集群通信。
    - 已安装 [KubeBlocks CLI](../../user_docs/references/install-kbcli) 和 [KubeBlocks Operator](../../user_docs/overview/install-kubeblocks)。
- 命名空间准备：为保持资源隔离，请为本教程创建一个专用命名空间：

```bash
kubectl create ns demo
namespace/demo created
```




## 部署 MySQL 半同步集群

KubeBlocks 采用声明式方法管理 MySQL 集群。以下是一个配置示例，用于部署包含 2 个节点（1 个主节点，1 个副本节点）的半同步模式 MySQL 集群。

集群配置

```yaml
kubectl apply -f - <<EOF
apiVersion: apps.kubeblocks.io/v1
kind: Cluster
metadata:
  name: example-mysql-cluster
  namespace: demo
spec:
  clusterDef: mysql
  topology: semisync
  terminationPolicy: Delete
  componentSpecs:
    - name: mysql
      serviceVersion: 8.0.35
      replicas: 2
      resources:
        limits:
          cpu: '0.5'
          memory: 0.5Gi
        requests:
          cpu: '0.5'
          memory: 0.5Gi
      volumeClaimTemplates:
        - name: data
          spec:
            storageClassName: ""
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
EOF
```




## 验证部署

监控集群状态直到其转为 Running 状态：

```bash
kubectl get cluster example-mysql-cluster -n demo -w
```

示例输出：

```bash
NAME                     CLUSTER-DEFINITION   TERMINATION-POLICY   STATUS    AGE
example-mysql-cluster   mysql                Delete               Creating   9s
example-mysql-cluster   mysql                Delete               Running    34s
```




## 查看网络服务
列出为 MySQL 集群创建的 Service：

```bash
kubectl get service -n demo
```

示例服务：

```bash
NAME                           TYPE           CLUSTER-IP       EXTERNAL-IP                                                                          PORT(S)                                                 AGE
example-mysql-cluster-mysql            ClusterIP      172.20.122.164   <none>                                                                               3306/TCP                                                5m16s
example-mysql-cluster-mysql-headless   ClusterIP      None             <none>                                                                               3306/TCP,3601/TCP,9104/TCP,3501/TCP,3502/TCP,9901/TCP   5m16s
```




## 对外或对内暴露 MySQL 服务

外部地址允许公网访问 MySQL 服务，而内部地址将访问限制在用户的 VPC 内。

### 服务类型对比

| 类型 | 	使用场景	| 云成本 |	安全性 |
|----|---|----|---|
| ClusterIP |	内部服务通信 |	免费 |	最高|
| NodePort |	开发/测试	| 低 |	中等 |
| LoadBalancer	| 生产环境外部访问 |	高	| 通过安全组管理 |


    <Tabs>

    <TabItem value="opsRequest" label="OPSREQUEST API" default>

### 选项 1：使用 OpsRequest

要通过 LoadBalancer 对外暴露 MySQL 服务，创建一个 OpsRequest 资源：

```yaml
kubectl apply -f - <<EOF
apiVersion: operations.kubeblocks.io/v1alpha1
kind: OpsRequest
metadata:
  name: example-mysql-cluster-expose-enable-ops
  namespace: demo
spec:
  type: Expose
  clusterName: example-mysql-cluster
  expose:
  - componentName: mysql
    services:
    - name: internet
      # Determines how the Service is exposed. Defaults to 'ClusterIP'.
      # Valid options are 'ClusterIP', 'NodePort', and 'LoadBalancer'.
      serviceType: LoadBalancer
      # Contains cloud provider related parameters if ServiceType is LoadBalancer.
      # Following is an example for AWS EKS
      annotations:
        service.beta.kubernetes.io/aws-load-balancer-type: nlb
        service.beta.kubernetes.io/aws-load-balancer-internal: "false"  # or "true" for an internal VPC IP
      # Specifies a role to target with the service.
      # If specified, the service will only be exposed to pods with the matching
      # role.
      roleSelector: primary
    switch: Enable
EOF
```

等待 OpsRequest 完成：

```bash
kubectl get ops example-mysql-cluster-expose-enable-ops -n demo
```

示例输出：

```bash
NAME                                      TYPE     CLUSTER                 STATUS    PROGRESS   AGE
example-mysql-cluster-expose-enable-ops   Expose   example-mysql-cluster   Succeed   1/1        31s
```



```yaml
kubectl apply -f - <<EOF
apiVersion: apps.kubeblocks.io/v1
kind: Cluster
metadata:
  name: example-mysql-cluster
  namespace: demo
spec:
  clusterDef: mysql
  topology: semisync
  terminationPolicy: Delete
  # expose a external service
  services:
    - annotations:
        service.beta.kubernetes.io/aws-load-balancer-type: nlb  # Use Network Load Balancer
        service.beta.kubernetes.io/aws-load-balancer-internal: "false"  # or "true" for an internal VPC IP
      componentSelector: mysql
      name: mysql-internet
      serviceName: mysql-internet
      roleSelector: primary
      spec:
        ipFamilyPolicy: PreferDualStack
        ports:
          - name: tcp-mysql
            port: 3306
            protocol: TCP
            targetPort: mysql
        type: LoadBalancer
  componentSpecs:
    - name: mysql
      serviceVersion: 8.0.35
      replicas: 2
      resources:
        limits:
          cpu: '0.5'
          memory: 0.5Gi
        requests:
          cpu: '0.5'
          memory: 0.5Gi
      volumeClaimTemplates:
        - name: data
          spec:
            storageClassName: ""
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
EOF
```

在上述 YAML 配置中，services 部分新增了一个外部服务。该服务类型为 LoadBalancer，并配置了 AWS 网络负载均衡器 (NLB) 的注解。

:::note
云服务提供商注解

使用 LoadBalancer 类型服务时，必须包含适用于您云服务提供商的特定注解。以下是不同云服务提供商的常用注解列表：

- AWS

```yaml
service.beta.kubernetes.io/aws-load-balancer-type: nlb  # Use Network Load Balancer
service.beta.kubernetes.io/aws-load-balancer-internal: "true"  # Use "false" for internet-facing LoadBalancer
```

- Azure

```yaml
service.beta.kubernetes.io/azure-load-balancer-internal: "true" # Use "false" for internet-facing LoadBalancer
```

- GCP

```yaml
networking.gke.io/load-balancer-type: "Internal"  # Restricts the LoadBalancer to internal VPC access only. Defaults to internet-facing if not specified.
cloud.google.com/l4-rbs: "enabled" # Optimization for internet-facing LoadBalancer
```

- 阿里云

```yaml
service.beta.kubernetes.io/alibaba-cloud-loadbalancer-address-type: "internet"  # Use "intranet" for internal-facing LoadBalancer
```

:::

:::注意
注解 `service.beta.kubernetes.io/aws-load-balancer-internal` 决定了负载均衡器是内部访问还是面向互联网的。
但该注解在服务创建后无法动态修改。
:::

```yaml
  service.beta.kubernetes.io/aws-load-balancer-internal: "false"  # Use "true" for internal VPC IPs
```

如果在服务创建后将该注解从"false"更改为"true"，注解可能会在服务对象中更新，但负载均衡器仍将保留其公共IP。

要正确修改此行为：
- 首先删除现有的负载均衡器服务
- 使用更新后的注解（`service.beta.kubernetes.io/aws-load-balancer-internal`: "true"）重新创建服务
- 等待新的负载均衡器配置正确的内部或外部IP
:::


使用以下命令等待集群状态转换为运行中：

```bash
kubectl get cluster example-mysql-cluster -n demo -w
```




```
NAME                    CLUSTER-DEFINITION   TERMINATION-POLICY   STATUS    AGE
example-mysql-cluster   mysql                Delete               Running   18m
```

</TabItem>

    </Tabs>

### 验证暴露的服务
检查服务详情以确认负载均衡器服务已创建：

```bash
kubectl get services -n demo
```

示例输出：

```bash
NAME                                    TYPE           CLUSTER-IP       EXTERNAL-IP                                                                          PORT(S)                                                 AGE
example-mysql-cluster-mysql            ClusterIP      172.20.129.84    <none>                                                                               3306/TCP                                                4h39m
example-mysql-cluster-mysql-headless   ClusterIP      None             <none>                                                                               3306/TCP,3601/TCP,9104/TCP,3501/TCP,3502/TCP,9901/TCP   4h39m
example-mysql-cluster-mysql-internet        LoadBalancer   172.20.60.24    a1d37733683d244e0bebad8559cbf24d-3728431cad3e24b5.elb.ap-southeast-1.amazonaws.com   3306:30985/TCP                                          13s
```

### 等待 DNS 传播

负载均衡器的 DNS 名称可能需要 2-5 分钟才能解析。请通过以下命令验证解析状态：

```bash
nslookup a1d37733683d244e0bebad8559cbf24d-3728431cad3e24b5.elb.ap-southeast-1.amazonaws.com
```

示例输出：

```bash
Server:		192.168.101.1
Address:	192.168.101.1#53

Non-authoritative answer:
Name:	a1d37733683d244e0bebad8559cbf24d-3728431cad3e24b5.elb.ap-southeast-1.amazonaws.com
Address: 54.251.110.4
```





## 外部连接 MySQL

### 获取凭据

KubeBlocks 会自动创建一个包含 MySQL root 凭据的 Secret。获取 MySQL root 凭据：

```bash
kubectl get secrets -n demo example-mysql-cluster-mysql-account-root -o jsonpath='{.data.password}' | base64 -d
KI260UK7E9
```

### 使用 MySQL 客户端连接

您现在可以从外部（例如您的笔记本电脑或 EC2）连接到 MySQL 数据库：

```bash
mysql -h a1d37733683d244e0bebad8559cbf24d-3728431cad3e24b5.elb.ap-southeast-1.amazonaws.com -uroot -pKI260UK7E9
```




## 禁用外部暴露

    <Tabs>

    <TabItem value="opsRequest" label="OPSREQUEST API" default>

### 选项 1.: 使用 OpsRequest
要禁用外部访问，创建一个 OpsRequest：

```yaml
kubectl apply -f - <<EOF
apiVersion: operations.kubeblocks.io/v1alpha1
kind: OpsRequest
metadata:
  name: example-mysql-cluster-expose-disable-ops
  namespace: demo
spec:
  clusterName: example-mysql-cluster
  expose:
  - componentName: mysql
    services:
    - name: internet
      roleSelector: primary
      serviceType: LoadBalancer
    switch: Disable
  preConditionDeadlineSeconds: 0
  type: Expose
EOF
```

等待 OpsRequest 完成：

```bash
kubectl get ops example-mysql-cluster-expose-disable-ops -n demo
```

示例输出：

```bash
NAME                                       TYPE     CLUSTER                 STATUS    PROGRESS   AGE
example-mysql-cluster-expose-disable-ops   Expose   example-mysql-cluster   Succeed   1/1        12s
```

</TabItem>

    <TabItem value="ClusterAPI" label="CLUSTER API">

### 选项 2：使用 Cluster API

或者，从 Cluster 资源中移除 `spec.services` 字段：

```bash
kubectl patch cluster example-mysql-cluster -n demo --type=json -p='[
  {
    "op": "remove",
    "path": "/spec/services"
  }
]'
```

监控集群状态直至其变为 Running：

```bash
kubectl get cluster example-mysql-cluster -n demo -w
```




```
NAME                    CLUSTER-DEFINITION   TERMINATION-POLICY   STATUS    AGE
example-mysql-cluster   mysql                Delete               Running   23m
```

</TabItem>

    </Tabs>

### 验证服务删除

确保 'example-mysql-connect-mysql-internet' 服务已被移除：

```bash
kubectl get service -n demo
```

预期结果：应移除 'example-mysql-cluster-mysql-internet' 服务。

## 概述
本指南演示了如何：
- 使用 KubeBlocks 将 MySQL 服务暴露到外部或内部网络
- 通过云服务商特定注解配置 LoadBalancer 服务
- 通过 OpsRequest 或直接更新 Cluster API 来管理外部访问的启用/禁用

KubeBlocks 为 Kubernetes 环境中的 MySQL 服务管理提供了灵活且简化的解决方案。

