---
description: 了解如何通过OpsRequest和直接Cluster API更新，对KubeBlocks管理的MySQL集群执行水平扩缩容（横向扩展与收缩）。
keywords:
- KubeBlocks
- MySQL
- Horizontal Scaling
- Scale-Out
- Scale-In
- Kubernetes
sidebar_label: 水平扩展
sidebar_position: 3
title: 使用KubeBlocks水平扩展MySQL集群
---
请按照要求翻译以下内容，严格保持所有格式、间距和换行不变：

## 前提条件

在继续之前，请确保满足以下要求：
- 环境准备：
    - 已启动并运行一个 Kubernetes 集群。
    - 已配置 kubectl CLI 工具以与集群通信。
    - 已安装 [KubeBlocks CLI](../../user_docs/references/install-kbcli) 和 [KubeBlocks Operator](../../user_docs/overview/install-kubeblocks)。请按照此处提供的安装说明进行操作。
- 命名空间准备：为保持资源隔离，请为本教程创建一个专用命名空间：

```bash
kubectl create ns demo
namespace/demo created
```




## 部署 MySQL 半同步集群

部署一个 2 节点的 MySQL 集群（1 个主节点，1 个从节点），采用半同步复制：

```yaml
kubectl apply -f - <<EOF
apiVersion: apps.kubeblocks.io/v1
kind: Cluster
metadata:
  name: example-mysql-cluster
  namespace: demo
spec:
  clusterDef: mysql
  topology: semisync
  terminationPolicy: Delete
  componentSpecs:
    - name: mysql
      serviceVersion: 8.0.35
      replicas: 2
      resources:
        limits:
          cpu: '0.5'
          memory: 0.5Gi
        requests:
          cpu: '0.5'
          memory: 0.5Gi
      volumeClaimTemplates:
        - name: data
          spec:
            storageClassName: ""
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
EOF
```




## 验证部署
监控集群状态直到其转变为 Running 状态：

```bash
kubectl get cluster example-mysql-cluster -n demo -w
```

示例输出：

```bash
NAME                     CLUSTER-DEFINITION   TERMINATION-POLICY   STATUS    AGE
example-mysql-cluster   mysql                Delete               Creating   8s
example-mysql-cluster   mysql                Delete               Running    87s
```

当集群状态变为 Running 时，您的 MySQL 集群即可使用。

## 水平扩展（增加副本）

    <Tabs>

    <TabItem value="opsRequest" label="OPSREQUEST API" default>

### 方案一：使用 OpsRequest
通过增加 1 个副本来扩展 MySQL 集群：

```yaml
kubectl apply -f - <<EOF
apiVersion: operations.kubeblocks.io/v1alpha1
kind: OpsRequest
metadata:
  name: example-mysql-cluster-scale-out-ops
  namespace: demo
spec:
  # Specifies the name of the Cluster resource that this operation is targeting.
  clusterName: example-mysql-cluster
  type: HorizontalScaling
  # Lists HorizontalScaling objects, each specifying scaling requirements for a Component, including desired total replica counts, configurations for new instances, modifications for existing instances, and instance downscaling options
  horizontalScaling:
    # Specifies the name of the Component.
  - componentName: mysql
    # Specifies the replica changes for scaling in components
    scaleOut:
      # Specifies the replica changes for the component.
      # add one more replica to current component
      replicaChanges: 1
EOF
```

监控扩缩容操作的进度：

```bash
kubectl describe ops example-mysql-cluster-scale-out-ops -n demo
```

预期结果：

```bash
Status:
  Phase:            Succeed
  Progress:         1/1
  ...
```

</TabItem>

    <TabItem value="ClusterAPI" label="CLUSTER API">

### 选项 2：直接通过 Cluster API 更新

或者，您可以直接更新 Cluster 资源中的 `replicas` 字段：

```yaml
kubectl patch cluster example-mysql-cluster -n demo --type=json -p='[{"op": "replace", "path": "/spec/componentSpecs/0/replicas", "value": 3}]'
```

</TabItem>

    </Tabs>


### 验证扩容操作

应用操作后，您将看到一个新的 Pod 被创建，MySQL 集群状态从 `Updating` 变为 `Running`，且新创建的 Pod 具有新角色 `secondary`。

```bash
kubectl get pods -n demo -l app.kubernetes.io/instance=example-mysql-cluster
```

请翻译以下内容，同时保留所有格式、间距和换行：

```bash
NAME                           READY   STATUS    RESTARTS   AGE
example-mysql-cluster-mysql-0   4/4     Running   0          4m30s
example-mysql-cluster-mysql-1   4/4     Running   0          4m30s
example-mysql-cluster-mysql-2   4/4     Running   0          49s
```

新副本会自动加入作为从节点。

```bash
kubectl get pods -n demo -l app.kubernetes.io/instance=example-mysql-cluster -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.metadata.labels.kubeblocks\.io/role}{"\n"}{end}'
```

示例输出：

```bash
example-mysql-cluster-mysql-0	primary
example-mysql-cluster-mysql-1	secondary
example-mysql-cluster-mysql-2	secondary
```





## 缩容（移除副本）

    <Tabs>

    <TabItem value="opsRequest" label="OPSREQUEST API" default>


选项 1：使用 OpsRequest
通过移除 1 个副本来缩容 MySQL 集群：

```yaml
kubectl apply -f - <<EOF
apiVersion: operations.kubeblocks.io/v1alpha1
kind: OpsRequest
metadata:
  name: example-mysql-cluster-scale-in-ops
  namespace: demo
spec:
  # Specifies the name of the Cluster resource that this operation is targeting.
  clusterName: example-mysql-cluster
  type: HorizontalScaling
  # Lists HorizontalScaling objects, each specifying scaling requirements for a Component, including desired total replica counts, configurations for new instances, modifications for existing instances, and instance downscaling options
  horizontalScaling:
    # Specifies the name of the Component.
  - componentName: mysql
    # Specifies the replica changes for scaling in components
    scaleIn:
      # Specifies the replica changes for the component.
      # remove one replica from current component
      replicaChanges: 1
EOF
```

监控进度：

```bash
kubectl describe ops example-mysql-cluster-scale-in-ops -n demo
```

示例输出：

```bash
Status:
  Phase:            Succeed
  Progress:         1/1
  ...
```

请严格保留所有格式、间距和换行符的情况下翻译以下内容：

```yaml
kubectl patch cluster example-mysql-cluster -n demo --type=json -p='[{"op": "replace", "path": "/spec/componentSpecs/0/replicas", "value": 2}]'
```

请翻译以下内容，同时保留所有格式、间距和换行：

```bash
kubectl get pods -n demo -l app.kubernetes.io/instance=example-mysql-cluster
NAME                           READY   STATUS    RESTARTS   AGE
example-mysql-cluster-mysql-0   4/4     Running   0          10m
example-mysql-cluster-mysql-1   4/4     Running   0          10m
```




## 总结
在本指南中，您学习了如何：
- 执行水平扩展操作，向 MySQL 集群添加副本。
- 执行水平收缩操作，从 MySQL 集群移除副本。
- 使用 OpsRequest 和直接修改 Cluster API 两种方式实现水平扩缩容。

KubeBlocks 确保扩缩容过程无缝进行，对数据库操作的影响降至最低。