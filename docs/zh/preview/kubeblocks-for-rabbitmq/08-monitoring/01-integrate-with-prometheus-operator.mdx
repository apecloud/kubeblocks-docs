---
description: 了解如何在KubeBlocks中通过Prometheus Operator为RabbitMQ集群配置可观测性。设置监控并通过Grafana实现指标可视化。
keywords:
- KubeBlocks
- RabbitMQ
- Prometheus
- Grafana
- Observability
- Metrics
sidebar_label: RabbitMQ 集群可观测性
sidebar_position: 2
title: 使用 Prometheus Operator 实现 RabbitMQ 集群的可观测性
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# 使用 Prometheus Operator 监控 RabbitMQ

本指南演示如何在 KubeBlocks 中为 RabbitMQ 集群配置全面的监控方案：

1. 使用 Prometheus Operator 进行指标采集
2. 通过内置 RabbitMQ exporter 暴露指标
3. 使用 Grafana 实现可视化监控

## 前提条件

import Prerequisites from '../_tpl/_prerequisites.mdx'

<Prerequisites />

## 安装监控组件栈

### 1. 安装 Prometheus Operator
使用 Helm 部署 kube-prometheus-stack：

```bash
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm install prometheus prometheus-community/kube-prometheus-stack \
  -n monitoring \
  --create-namespace
```

### 2. 验证安装
检查所有组件是否正常运行：
```bash
kubectl get pods -n monitoring
```

预期输出：
```bash
NAME                                                     READY   STATUS    RESTARTS   AGE
alertmanager-prometheus-kube-prometheus-alertmanager-0   2/2     Running   0          114s
prometheus-grafana-75bb7d6986-9zfkx                      3/3     Running   0          2m
prometheus-kube-prometheus-operator-7986c9475-wkvlk      1/1     Running   0          2m
prometheus-kube-state-metrics-645c667b6-2s4qx            1/1     Running   0          2m
prometheus-prometheus-kube-prometheus-prometheus-0       2/2     Running   0          114s
prometheus-prometheus-node-exporter-47kf6                1/1     Running   0          2m1s
prometheus-prometheus-node-exporter-6ntsl                1/1     Running   0          2m1s
prometheus-prometheus-node-exporter-gvtxs                1/1     Running   0          2m1s
prometheus-prometheus-node-exporter-jmxg8                1/1     Running   0          2m1s
```

## 部署 RabbitMQ 集群

import CreateCluster from '../_tpl/_create-cluster.mdx'

<CreateCluster />

## 验证部署状态

import VerifyCluster from '../_tpl/_verify-cluster.mdx'

<VerifyCluster />

## 配置指标采集

### 1. 验证 Exporter 端点

```bash
# 端口转发
kubectl -n demo port-forward pods/rabbitmq-cluster-rabbitmq-0  15692:15692
# 检查指标
curl -s http://127.0.0.1:15692/metrics | head -n 50
```

### 2. 创建 PodMonitor
```yaml
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: rabbitmq-cluster-pod-monitor
  namespace: demo
  labels:               # 必须与 'prometheus.spec.podMonitorSelector' 中的设置匹配
    release: prometheus
spec:
  jobLabel: app.kubernetes.io/managed-by
  # 定义从关联的 Kubernetes Pod 对象传输到采集指标的标签
  # 根据实际需求设置标签
  podTargetLabels:
  - app.kubernetes.io/instance
  - app.kubernetes.io/managed-by
  - apps.kubeblocks.io/component-name
  - apps.kubeblocks.io/pod-name
  podMetricsEndpoints:
    - path: /metrics
      port: prometheus   # 必须与 exporter 端口名称匹配
      scheme: http
  namespaceSelector:
    matchNames:
      - demo               # 目标命名空间
  selector:
    matchLabels:
      app.kubernetes.io/instance: rabbitmq-cluster
```
**PodMonitor 配置指南**

| 参数 | 必填 | 说明 |
|-----------|----------|-------------|
| `port` | 是 | 必须与 exporter 端口名称 ('http-metrics') 匹配 |
| `namespaceSelector` | 是 | 指定 RabbitMQ 运行的命名空间 |
| `labels` | 是 | 必须与 Prometheus 的 podMonitorSelector 匹配 |
| `path` | 否 | 指标端点路径 (默认: /metrics) |
| `interval` | 否 | 采集间隔 (默认: 30s) |

## 验证监控配置

### 1. 检查 Prometheus 采集目标
端口转发并访问 Prometheus UI：

```bash
kubectl port-forward svc/prometheus-kube-prometheus-prometheus -n monitoring 9090:9090
```
浏览器访问：
http://localhost:9090/targets

检查是否存在与 PodMonitor 对应的采集任务（任务名应为 'demo/rabbitmq-cluster-pod-monitor'）。

预期状态：
- 目标状态应为 UP
- 目标标签应包含 podTargetLabels 中定义的标签（如 'app_kubernetes_io_instance'）

### 2. 测试指标采集
验证指标是否被正确采集：
```bash
curl -sG "http://localhost:9090/api/v1/query" --data-urlencode 'query=up{app_kubernetes_io_instance="rabbitmq-cluster"}' | jq
```

示例输出：
```json
{
  "status": "success",
  "data": {
    "resultType": "vector",
    "result": [
      {
        "metric": {
          "__name__": "up",
          "app_kubernetes_io_instance": "rabbitmq-cluster",
          "app_kubernetes_io_managed_by": "kubeblocks",
          "apps_kubeblocks_io_component_name": "rabbitmq",
          "apps_kubeblocks_io_pod_name": "rabbitmq-cluster-rabbitmq-0",
          "container": "rabbitmq",
          "endpoint": "prometheus",
          "instance": "10.244.0.78:15692",
          "job": "kubeblocks",
          "namespace": "demo",
          "pod": "rabbitmq-cluster-rabbitmq-0"
        },
        "value": [
          1747622160.396,
          "1"
        ]
      },
      {
        "metric": {
          "__name__": "up",
          "app_kubernetes_io_instance": "rabbitmq-cluster",
          "app_kubernetes_io_managed_by": "kubeblocks",
          "apps_kubeblocks_io_component_name": "rabbitmq",
          "apps_kubeblocks_io_pod_name": "rabbitmq-cluster-rabbitmq-1",
          "container": "rabbitmq",
          "endpoint": "prometheus",
          "instance": "10.244.0.80:15692",
          "job": "kubeblocks",
          "namespace": "demo",
          "pod": "rabbitmq-cluster-rabbitmq-1"
        },
        "value": [
          1747622160.396,
          "1"
        ]
      }
    ]
  }
}
```
## Grafana 可视化

### 1. 访问 Grafana
端口转发并登录：

```bash
kubectl port-forward svc/prometheus-grafana -n monitoring 3000:80
```
浏览器访问 http://localhost:3000，使用默认凭据登录：
- 用户名: 'admin'
- 密码: 'prom-operator' (默认)

### 2. 导入仪表板
导入 KubeBlocks RabbitMQ 仪表板：

1. 在 Grafana 中导航至 "+" → "Import"
2. 从 [Grafana RabbitMQ-Overview](https://grafana.com/grafana/dashboards/10991-rabbitmq-overview/) 导入仪表板

![rabbitmq-monitoring-grafana-dashboard.png](/img/docs/en/rabbitmq-monitoring-grafana-dashboard.png)

## 清理资源
执行以下命令删除所有创建的资源：
```bash
kubectl delete cluster rabbitmq-cluster -n demo
kubectl delete ns demo
kubectl delete podmonitor rabbitmq-cluster-pod-monitor -n demo
```

## 总结
本教程演示了如何在 KubeBlocks 中使用 Prometheus Operator 为 RabbitMQ 集群建立可观测性方案。通过配置 `PodMonitor`，我们实现了 Prometheus 对 RabbitMQ exporter 指标的采集，最终在 Grafana 中实现了指标可视化。该方案为监控 RabbitMQ 数据库的健康状态和性能表现提供了重要洞察。