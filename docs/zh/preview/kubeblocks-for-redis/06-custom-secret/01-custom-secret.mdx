---
description: 了解如何在KubeBlocks上部署Redis集群，并通过Kubernetes Secrets安全配置自定义root密码。
keywords:
- Redis
- KubeBlocks
- Custom Password
- Kubernetes
- Secrets
sidebar_label: 自定义密码
sidebar_position: 1
title: 在KubeBlocks上创建带自定义根密码的Redis集群
---
# 在 KubeBlocks 上创建带自定义密码的 Redis 集群

本指南演示如何在 KubeBlocks 中部署 Redis 集群，并将自定义 root 密码存储在 Kubernetes Secret 中。

## 先决条件

import Prerequisites from '../_tpl/_prerequisites.mdx'

<Prerequisites />

## 部署 Redis 复制集群

KubeBlocks 采用声明式方法管理 Redis 集群。以下是一个配置示例，用于部署包含 2 个节点（1 主 1 从）且带有自定义 root 密码的 Redis 集群。

### 步骤 1：为默认账户创建 Secret

自定义 root 密码存储在 Kubernetes Secret 中。通过应用以下 YAML 创建 Secret：

```yaml
apiVersion: v1
data:
  password: Y3VzdG9tcGFzc3dvcmQ= # custompassword
  username: cm9vdA== #root
immutable: true
kind: Secret
metadata:
  name: custom-secret
  namespace: demo
```
- password: 将 custompassword 替换为您想要的密码，并使用 Base64 编码（`echo -n "custompassword" | base64`）。
- username: Redis 默认用户是 'default'，编码为 'cm9vdA=='。

### 步骤 2：部署 Redis 集群

应用以下清单部署 Redis 集群，并引用步骤 1 中创建的 Secret 作为 root 账户凭据：
```yaml
apiVersion: apps.kubeblocks.io/v1
kind: Cluster
metadata:
  name: redis-replication
  namespace: demo
spec:
  terminationPolicy: Delete
  clusterDef: redis
  topology: replication
  componentSpecs:
    - name: redis
      serviceVersion: "7.2.4"
      disableExporter: false
      replicas: 2
      systemAccounts:  # 覆盖系统账户密码
        - name: default
          secretRef:
            name: custom-secret
            namespace: demo
      resources:
        limits:
          cpu: '0.5'
          memory: 0.5Gi
        requests:
          cpu: '0.5'
          memory: 0.5Gi
      volumeClaimTemplates:
        - name: data
          spec:
            storageClassName: ""
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
    - name: redis-sentinel
      replicas: 3
      resources:
        limits:
          cpu: '0.5'
          memory: 0.5Gi
        requests:
          cpu: '0.5'
          memory: 0.5Gi
      volumeClaimTemplates:
        - name: data
          spec:
            storageClassName: ""
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
```
**关键字段说明**
- `systemAccounts`: 覆盖引用 `ComponentDefinition` 中定义的系统账户。

:::tip

在 KubeBlocks Redis 插件中，预定义了一组系统账户。只有这些账户可以通过新 Secret 进行自定义。

:::

获取账户列表：
```bash
kubectl get cmpd redis-7-1.0.0         -oyaml | yq '.spec.systemAccounts[].name'
```

预期输出：
```bash
default
```

## 验证部署

import VerifyCluster from '../_tpl/_verify-redis-replication-cluster.mdx'

<VerifyCluster />

## 连接 Redis 集群

KubeBlocks 会自动创建包含 Redis root 凭据的 Secret。使用以下命令获取凭据：

```bash
kubectl get secrets -n demo redis-replication-redis-account-default -o jsonpath='{.data.password}' | base64 -d
custompassword
```

使用 Redis 客户端和自定义密码连接到集群主节点：
```bash
kubectl exec -it -n demo redis-replication-redis-0 -c redis -- reids-cli -a ${PASSWD}
```

## 清理资源
删除 Redis 集群及其命名空间以移除所有创建的资源：

```bash
kubectl delete cluster redis-replication -n demo
kubectl delete secret custom-secret -n demo
kubectl delete ns demo
```

## 总结
在本指南中，您完成了以下操作：
- 创建 Kubernetes Secret 安全存储自定义 Redis 默认密码
- 在 KubeBlocks 中部署带有自定义 root 密码的 Redis 集群
- 验证部署并使用 Redis 客户端连接到集群主节点

使用 Kubernetes Secret 可以确保 Redis 集群凭据的安全管理，而 KubeBlocks 简化了部署和管理流程。