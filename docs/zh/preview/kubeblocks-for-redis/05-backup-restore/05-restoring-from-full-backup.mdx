---
description: 了解如何通过集群注解（Cluster Annotation）或运维请求API（OpsRequest API）在KubeBlocks中从现有备份恢复一个新的Redis集群。
keywords:
- Redis
- Restore
- Backup
- KubeBlocks
- Kubernetes
sidebar_label: 恢复 Redis 集群
sidebar_position: 5
title: 从备份恢复 Redis 集群
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# 从备份恢复Redis集群

本指南演示了在KubeBlocks中从备份恢复Redis集群的两种方法：

1. **集群注解法** - 使用YAML注解的简单声明式方法
2. **OpsRequest API法** - 支持进度监控的增强型操作控制

## 前提条件

import Prerequisites from '../_tpl/_prerequisites.mdx'

<Prerequisites />

## 恢复准备：定位完整备份
在开始恢复前，请确保存在可用的完整备份。恢复过程将使用此备份创建新的Redis集群。

- 新集群可访问的备份仓库
- 状态为`Completed`的有效完整备份
- 充足的CPU/内存资源
- 足够的存储容量

查找可用的完整备份：

```bash
kubectl get backup -n demo -l dataprotection.kubeblocks.io/backup-type=Full,app.kubernetes.io/instance=redis-replication # 获取完整备份列表
```

选择状态为`Completed`的任意一个备份。

## 方案一：集群注解恢复法

### 步骤1：创建恢复集群
创建包含恢复配置的新集群：

关键参数：
- `kubeblocks.io/restore-from-backup`注解
- 从上一步骤获取的备份名称和命名空间


```yaml
apiVersion: apps.kubeblocks.io/v1
kind: Cluster
metadata:
  name: redis-replication-restore
  namespace: demo
  annotations:
    kubeblocks.io/restore-from-backup: '{"redis":{"name":"<FULL_BACKUP_NAME>","namespace":"demo","volumeRestorePolicy":"Parallel"}}'
spec:
  terminationPolicy: Delete
  clusterDef: redis
  topology: replication
  componentSpecs:
    - name: redis
      serviceVersion: "7.2.4"
      disableExporter: false
      replicas: 2
      resources:
        limits:
          cpu: '0.5'
          memory: 0.5Gi
        requests:
          cpu: '0.5'
          memory: 0.5Gi
      volumeClaimTemplates:
        - name: data
          spec:
            storageClassName: ""
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
    - name: redis-sentinel
      replicas: 3
      resources:
        limits:
          cpu: '0.5'
          memory: 0.5Gi
        requests:
          cpu: '0.5'
          memory: 0.5Gi
      volumeClaimTemplates:
        - name: data
          spec:
            storageClassName: ""
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
```

### 步骤2：监控恢复进度
通过以下命令跟踪恢复进度：

```bash
# 查看恢复状态
kubectl get restore -n demo -w

# 查看集群状态
kubectl get cluster -n demo -w
```

## 方案二：OpsRequest API恢复法

### 步骤1：发起恢复操作
通过OpsRequest API创建恢复请求：

```yaml
apiVersion: operations.kubeblocks.io/v1alpha1
kind: OpsRequest
metadata:
  name: redis-replication-restore
  namespace: demo
spec:
  clusterName: pg-restored
  force: false
  restore:
    backupName: <FULL_BACKUP_NAME>
    backupNamespace: demo
  type: Restore
```

### 步骤2：跟踪操作进度
监控恢复状态：

```bash
# 查看恢复状态
kubectl get restore -n demo -w

# 查看集群状态
kubectl get cluster -n demo -w
```

### 步骤3：验证恢复集群
确认恢复成功：
```bash
kubectl get cluster redis-replication-restored -n demo
```
示例输出：
```bash
NAME                    CLUSTER-DEFINITION   TERMINATION-POLICY   STATUS    AGE
redis-replication-restored     redis           Delete               Running   3m2s
```


## 清理资源
删除Redis集群及其命名空间以移除所有创建的资源：

```bash
kubectl delete cluster redis-replication -n demo
kubectl delete cluster redis-replication-restored -n demo
kubectl delete ns demo
```

## 总结

本指南涵盖两种恢复方法：

1. **集群注解法** - 基于YAML的简单方法
   - 获取系统凭证
   - 创建带恢复注解的集群
   - 监控进度

2. **OpsRequest API法** - 增强的操作控制
   - 创建恢复请求
   - 跟踪操作状态
   - 验证完成情况