---
description: 了解如何在KubeBlocks管理的Redis集群中无停机扩展持久卷声明（PVC）。
keywords:
- KubeBlocks
- Redis
- Volume Expansion
- Kubernetes
- PVC
sidebar_label: 存储卷扩容
sidebar_position: 4
title: Redis 集群中扩展存储卷
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';


# Redis集群存储卷扩容指南

本文档详细说明如何在**KubeBlocks**管理的Redis集群中扩展持久卷声明(PVC)。存储卷扩容功能允许动态增加存储容量，使您的数据库能够随着数据增长无缝扩展。当底层存储类支持此功能时，该操作可在不中断服务的情况下执行。

存储卷扩容允许您在创建持久卷声明(PVC)后增加其容量大小。该功能在Kubernetes v1.11中引入，并于Kubernetes v1.24版本正式发布(GA)。

## 前提条件

import Prerequisites from '../_tpl/_prerequisites.mdx'

<Prerequisites />

### 检查存储类是否支持扩容

列出所有可用存储类，通过检查`ALLOWVOLUMEEXPANSION`字段确认是否支持卷扩容：
```bash
kubectl get storageclass
```

示例输出：
```bash
NAME                PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
gp2                 kubernetes.io/aws-ebs   Delete          WaitForFirstConsumer   false                  4d10h
kb-default-sc       ebs.csi.aws.com         Delete          WaitForFirstConsumer   true                   3d7h
sc-s3-repo-2qsxfh   ru.yandex.s3.csi        Retain          Immediate              false                  3d7h
```
请确保您使用的存储类将`ALLOWVOLUMEEXPANSION`设置为true。若为false，则表示该存储类不支持卷扩容。

## 使用支持扩容的StorageClass部署Redis复制集群

KubeBlocks采用声明式方式管理Redis集群。以下是部署包含2个副本（1主1从）的Redis集群配置示例。

应用以下YAML配置部署集群：

```yaml
apiVersion: apps.kubeblocks.io/v1
kind: Cluster
metadata:
  name: redis-replication
  namespace: demo
spec:
  terminationPolicy: Delete
  clusterDef: redis
  topology: replication
  componentSpecs:
    - name: redis
      serviceVersion: "7.2.4"
      disableExporter: false
      replicas: 2
      resources:
        limits:
          cpu: '0.5'
          memory: 0.5Gi
        requests:
          cpu: '0.5'
          memory: 0.5Gi
      volumeClaimTemplates:
        - name: data
          spec:
            # 指定支持卷扩容的存储类名称
            storageClassName: <STORAGE_CLASS_NAME>
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
    - name: redis-sentinel
      replicas: 3
      resources:
        limits:
          cpu: '0.5'
          memory: 0.5Gi
        requests:
          cpu: '0.5'
          memory: 0.5Gi
      volumeClaimTemplates:
        - name: data
          spec:
            # 指定支持卷扩容的存储类名称
            storageClassName: <STORAGE_CLASS_NAME>
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
```
**关键字段说明**
- `storageClassName`: 指定支持卷扩容的`StorageClass`名称。若未设置，将使用标注为`default`的StorageClass。

:::note
**ALLOWVOLUMEEXPANSION**

创建集群时请确保存储类支持卷扩容（检查`ALLOWVOLUMEEXPANSION`字段）。

:::


## 验证部署

import VerifyCluster from '../_tpl/_verify-redis-replication-cluster.mdx'

<VerifyCluster />

## 执行存储卷扩容

:::note
1. 确保存储类支持卷扩容（检查`ALLOWVOLUMEEXPANSION`）
2. 新容量必须大于当前容量
3. 根据存储提供商不同，卷扩容可能需要额外配置
:::

可通过以下两种方式执行扩容：
<Tabs>

  <TabItem value="opsRequest" label="OpsRequest API" default>

  方式一：使用VolumeExpansion运维请求

  应用以下YAML为redis组件扩容：

  ```yaml
  apiVersion: operations.kubeblocks.io/v1alpha1
  kind: OpsRequest
  metadata:
    name: redis-replication-expand-volume-ops
    namespace: demo
  spec:
    clusterName: redis-replication
    type: VolumeExpansion
    volumeExpansion:
    - componentName: redis
      volumeClaimTemplates:
      - name: data
        storage: 30Gi
  ```

  通过以下命令监控扩容进度：

  ```bash
  kubectl describe ops redis-replication-expand-volume-ops -n demo
  ```

  预期结果：
  ```bash
  Status:
    Phase:            Succeed
  ```
  操作完成后，PVC容量将更新。

  :::note
  若使用的存储类不支持扩容，此OpsRequest将快速失败并提示类似信息：
  `storageClass: [STORAGE_CLASS_NAME] of volumeClaimTemplate: [VOLUME_NAME]] not support volume expansion in component [COMPONENT_NAME]`
  :::

  </TabItem>

  <TabItem value="ClusterAPI" label="Cluster API">

  方式二：直接更新Cluster API

  您也可以直接修改`spec.componentSpecs.volumeClaimTemplates.spec.resources.requests.storage`字段为期望容量。

  ```yaml
  componentSpecs:
    - name: redis
      volumeClaimTemplates:
        - name: data
          spec:
            storageClassName: <STORAGE_CLASS_NAME>
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                # 指定新容量，确保大于当前容量
                storage: 30Gi
  ```
  KubeBlocks将根据新配置自动更新PVC容量。
  </TabItem>
</Tabs>

## 验证扩容结果

检查更新后的集群配置：
```bash
kbcli cluster describe redis-replication -n demo
```
预期输出：
```bash
Resources Allocation:
COMPONENT   INSTANCE-TEMPLATE   CPU(REQUEST/LIMIT)   MEMORY(REQUEST/LIMIT)   STORAGE-SIZE   STORAGE-CLASS
redis                           500m / 500m          512Mi / 512Mi           data:30Gi      <STORAGE_CLASS_NAME>
```
数据PVC的容量已更新为指定值（本例中为30Gi）。

确认PVC扩容完成：
```bash
kubectl get pvc -l app.kubernetes.io/instance=redis-replication -n demo
```
预期输出：
```bash
NAME                                     STATUS   VOLUME        CAPACITY   ACCESS MODES   STORAGECLASS          AGE
redis-replication-redis-data-0           Bound    pvc-xxxxxxxx  30Gi       RWO            <STORAGE_CLASS_NAME>  33m
redis-replication-redis-data-1           Bound    pvc-xxxxxxxx  30Gi       RWO            <STORAGE_CLASS_NAME>  33m
```

## 清理资源
删除Redis集群及其命名空间以释放所有资源：
```bash
kubectl delete cluster redis-replication -n demo
kubectl delete ns demo
```

## 总结

本指南中您已学习：
1. 验证存储类对卷扩容的支持情况
2. 通过两种方式执行扩容：
   - 使用OpsRequest进行动态更新
   - 通过Cluster API手动更新
3. 验证更新后的PVC容量并确认扩容操作完成

通过存储卷扩容功能，您可以高效扩展Redis集群的存储容量而无需服务中断，确保数据库能够随着应用需求同步增长。