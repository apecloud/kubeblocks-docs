---
description: 了解如何在KubeBlocks管理的Redis集群中下线（停用）特定Pod。
keywords:
- KubeBlocks
- Redis
- Decommission Pod
- Horizontal Scaling
- Kubernetes
sidebar_label: 下线 Redis 副本
sidebar_position: 9
title: 在KubeBlocks管理的Redis集群中下线特定Pod
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# 下线 KubeBlocks 托管的 Redis 集群中特定 Pod

本文档介绍如何在 KubeBlocks 托管的 Redis 集群中下线（停用）特定 Pod。通过精确控制集群资源的下线操作，可以在保持服务可用性的同时实现工作负载重平衡、节点维护或故障处理。

## 为什么选择 KubeBlocks 下线 Pod？

在传统的基于 StatefulSet 的部署中，Kubernetes 无法直接下线特定 Pod。StatefulSet 会严格保证 Pod 的顺序和身份标识，缩容操作总是优先移除序号最大的 Pod（例如从 3 个副本缩容时，会先移除 `Pod-2`）。这种限制使得运维人员无法精确控制需要下线的目标 Pod，给维护工作、负载均衡或故障处理带来不便。

KubeBlocks 突破了这一限制，允许管理员直接指定需要下线的 Pod。这种细粒度控制能力既能保障集群高可用性，又能实现更精细的资源管理。

## 前提条件

import Prerequisites from '../_tpl/_prerequisites.mdx'

<Prerequisites />

## 部署 Redis 集群

import CreateCluster from '../_tpl/_create-redis-replication-cluster.mdx'

<CreateCluster />

## 验证部署状态

import VerifyCluster from '../_tpl/_verify-redis-replication-cluster.mdx'

<VerifyCluster />

## 下线指定 Pod

**预期工作流程**：
1. `onlineInstancesToOffline` 中指定的副本被移除
2. Pod 优雅终止
3. 集群状态从 `Updating` 转变为 `Running`

以下两种方法均可用于下线特定 Pod（例如 'redis-replication-redis-1'）：

<Tabs>

  <TabItem value="opsRequest" label="OpsRequest API" default>

  方法一：使用 OpsRequest

  创建运维请求标记需要下线的 Pod：

  ```yaml
  apiVersion: operations.kubeblocks.io/v1alpha1
  kind: OpsRequest
  metadata:
    name: redis-replication-decommission-ops
    namespace: demo
  spec:
    clusterName: redis-replication
    type: HorizontalScaling
    horizontalScaling:
    - componentName: redis
      scaleIn:
        onlineInstancesToOffline:
          - 'redis-replication-redis-1'  # 指定需要下线的实例名称
  ```

  #### 监控下线进度
  查看下线操作执行状态：

  ```bash
  kubectl get ops redis-replication-decommission-ops -n demo -w
  ```
  示例输出：

  ```bash
  NAME                                 TYPE                CLUSTER             STATUS    PROGRESS   AGE
  redis-replication-decommission-ops   HorizontalScaling   redis-replication   Succeed   1/1        71s
  ```

  </TabItem>

  <TabItem value="ClusterAPI" label="Cluster API">

  方法二：使用 Cluster API

  也可以直接修改 Cluster 资源来下线 Pod：

  ```yaml
  apiVersion: apps.kubeblocks.io/v1
  kind: Cluster
  spec:
    componentSpecs:
      - name: redis
        replicas: 1       # 下线后期望的副本数
        offlineInstances:
          - redis-replication-redis-1   # <----- 指定需要下线的 Pod
   ...
  ```
  </TabItem>

</Tabs>

### 验证下线结果

应用更新配置后，检查集群中剩余的 Pod：
```bash
kubectl get pods -n demo -l app.kubernetes.io/instance=redis-replication
```

示例输出：
```bash
NAME                      READY   STATUS    RESTARTS   AGE
redis-replication-redis-0 3/3     Running   0          33m33s
```

## 总结
核心要点：
- 传统 StatefulSet 缺乏精确的 Pod 移除控制能力
- KubeBlocks 支持定向下线特定 Pod
- 两种实现方式：OpsRequest 或 Cluster API

该功能在保障服务可用性的同时，为集群管理提供了更精细的控制维度。