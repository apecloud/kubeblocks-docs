---
description: 了解如何通过负载均衡器及其他服务类型，在KubeBlocks中配置和管理Redis服务以实现内外网访问。
keywords:
- KubeBlocks
- Redis
- LoadBalancer
- External Service
- Expose
- Kubernetes
sidebar_label: 管理Redis服务
sidebar_position: 5
title: 使用KubeBlocks声明式集群API创建和销毁Redis服务
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';


# 使用KubeBlocks声明式集群API管理Redis服务

本指南将逐步指导您如何通过KubeBlocks暴露Redis服务（包括外部和内部访问）。您将学习如何配置云服务商负载均衡器实现外部访问、管理内部服务，以及在不需要时正确关闭外部暴露。

## 先决条件

import Prerequisites from '../_tpl/_prerequisites.mdx'

<Prerequisites />


## 部署Redis复制集群

import CreateCluster from '../_tpl/_create-redis-replication-cluster.mdx'

<CreateCluster />


## 验证部署状态

import VerifyCluster from '../_tpl/_verify-redis-replication-cluster.mdx'

<VerifyCluster />


## 查看网络服务
列出为Redis集群创建的服务：
```bash
kubectl get service -l app.kubernetes.io/instance=redis-replication -n demo
```

示例服务输出：
```bash
NAME                                              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)     AGE
redis-replication-redis-redis                     ClusterIP   10.96.102.140   <none>        6379/TCP    31s
redis-replication-redis-sentinel-redis-sentinel   ClusterIP   10.96.157.4     <none>        26379/TCP   51s
```


## 暴露Redis服务

外部服务地址允许公网访问Redis，而内部服务地址仅限用户VPC内访问。

### 服务类型对比

| 类型 | 使用场景 | 云成本 | 安全性 |
|------|----------|------------|----------|
| ClusterIP | 内部服务通信 | 免费 | 最高 |
| NodePort | 开发测试 | 低 | 中等 |
| LoadBalancer | 生产环境外部访问 | 高 | 通过安全组管理 |


<Tabs>

  <TabItem value="opsRequest" label="OpsRequest API" default>

  方案一：使用OpsRequest

  通过创建OpsRequest资源使用负载均衡器暴露Redis服务：

  ```yaml
  apiVersion: operations.kubeblocks.io/v1alpha1
  kind: OpsRequest
  metadata:
    name: redis-replication-expose-enable-ops
    namespace: demo
  spec:
    type: Expose
    clusterName: redis-replication
    expose:
    - componentName: redis
      services:
      - name: internet
        # 决定服务暴露方式，默认为'ClusterIP'
        # 可选值：'ClusterIP'、'NodePort'和'LoadBalancer'
        serviceType: LoadBalancer
        # 当ServiceType为LoadBalancer时，包含云服务商相关参数
        # 以下是AWS EKS的配置示例
        annotations:
          service.beta.kubernetes.io/aws-load-balancer-type: nlb
          service.beta.kubernetes.io/aws-load-balancer-internal: "false"  # 设为"true"表示使用内部VPC IP
        # 指定服务目标角色
        # 若指定，则服务仅暴露给具有匹配角色的Pod
        roleSelector: primary
      switch: Enable
  ```

  等待OpsRequest完成：
  ```bash
  kubectl get ops redis-replication-expose-enable-ops -n demo
  ```

  示例输出：
  ```bash
  NAME                                  TYPE     CLUSTER             STATUS    PROGRESS   AGE
  redis-replication-expose-enable-ops   Expose   redis-replication   Succeed   1/1        31s
  ```

  </TabItem>

  <TabItem value="ClusterAPI" label="Cluster API">

  方案二：使用Cluster API

  另一种方式是在Cluster资源的`spec.services`部分添加负载均衡器服务：
  ```yaml
  apiVersion: apps.kubeblocks.io/v1
  kind: Cluster
  metadata:
    name: redis-replication
    namespace: demo
  spec:
    terminationPolicy: Delete
    clusterDef: redis
    topology: replication
    # 暴露外部服务
    services:
      - annotations:
          service.beta.kubernetes.io/aws-load-balancer-type: nlb  # 使用网络负载均衡器
          service.beta.kubernetes.io/aws-load-balancer-internal: "false"  # 设为"true"表示使用内部VPC IP
        componentSelector: redis
        name: redis-internet
        serviceName: redis-internet
        roleSelector: primary
        spec:
          ipFamilyPolicy: PreferDualStack
          ports:
            - name: redis
              port: 6379
              protocol: TCP
              targetPort: redis
          type: LoadBalancer
    componentSpecs:
    ...
  ```
  上述YAML配置在services部分新增了一个外部服务。该负载均衡器服务包含了AWS网络负载均衡器(NLB)的注解。

  :::note
  云服务商注解说明

  使用负载均衡器服务时，必须包含对应云服务商的特定注解。以下是常用云服务商的注解示例：

  - AWS
  ```yaml
  service.beta.kubernetes.io/aws-load-balancer-type: nlb  # 使用网络负载均衡器
  service.beta.kubernetes.io/aws-load-balancer-internal: "true"  # 设为"false"表示面向互联网的负载均衡器
  ```

  - Azure
  ```yaml
  service.beta.kubernetes.io/azure-load-balancer-internal: "true" # 设为"false"表示面向互联网的负载均衡器
  ```

  - GCP
  ```yaml
  networking.gke.io/load-balancer-type: "Internal"  # 限制负载均衡器仅限内部VPC访问。默认不指定时为面向互联网。
  cloud.google.com/l4-rbs: "enabled" # 面向互联网负载均衡器的优化配置
  ```

  - 阿里云
  ```yaml
  service.beta.kubernetes.io/alibaba-cloud-loadbalancer-address-type: "internet"  # 设为"intranet"表示内部负载均衡器
  ```
  :::


  :::note
  `service.beta.kubernetes.io/aws-load-balancer-internal`注解控制负载均衡器是内部还是面向互联网。注意该注解在服务创建后不能动态修改。
  ```yaml
    service.beta.kubernetes.io/aws-load-balancer-internal: "false"  # 设为"true"表示使用内部VPC IP
  ```
  如果在服务创建后将该注解从"false"改为"true"，虽然Service对象中的注解会更新，但负载均衡器仍会保留其公网IP。

  正确修改方式：
  - 首先删除现有的负载均衡器服务
  - 使用更新后的注解重新创建服务（`service.beta.kubernetes.io/aws-load-balancer-internal`: "true"）
  - 等待新负载均衡器分配正确的内部/外部IP
  :::


  使用以下命令等待集群状态变为Running：
  ```bash
  kubectl get cluster redis-replication -n demo -w
  ```
  ```
  NAME         CLUSTER-DEFINITION   TERMINATION-POLICY   STATUS    AGE
  redis-replication   redis           Delete               Running   18m
  ```
  </TabItem>

</Tabs>

### 验证暴露的服务
检查服务详情确认负载均衡器服务已创建：

```bash
kubectl get service -l app.kubernetes.io/instance=redis-replication -n demo
```

示例输出：
```bash
NAME                               TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)             AGE
redis-replication-redis-internet   LoadBalancer   172.20.60.24   <EXTERNAL-IP> 6379:31243/TCP      1m
```

### 等待DNS解析

负载均衡器DNS名称可能需要2-5分钟才能解析。验证解析状态：

```bash
nslookup <EXTERNAL-IP>  # 将<EXTERNAL-IP>替换为实际输出的IP地址
```

## 外部连接 Redis

### 获取凭据

KubeBlocks 会自动创建一个包含 Redis 默认凭据的 Secret。获取 Redis 默认凭据：
```bash
NAME=`kubectl get secrets -n demo redis-replication-redis-account-default -o jsonpath='{.data.username}' | base64 -d`
PASSWD=`kubectl get secrets -n demo redis-replication-redis-account-default -o jsonpath='{.data.password}' | base64 -d`
```

### 使用 Redis 客户端连接

现在可以从外部（例如您的笔记本电脑或 EC2）连接到 Redis 数据库：
```bash
redis-cli -h <EXTERNAL_IP> -a ${PASSWD}
```


## 禁用外部暴露

<Tabs>

  <TabItem value="opsRequest" label="OpsRequest API" default>

  方法一：使用 OpsRequest

  要禁用外部访问，创建一个 OpsRequest：
  ```yaml
  apiVersion: operations.kubeblocks.io/v1alpha1
  kind: OpsRequest
  metadata:
    name: redis-replication-expose-disable-ops
    namespace: demo
  spec:
    clusterName: redis-replication
    expose:
    - componentName: redis
      services:
      - name: internet
        roleSelector: primary
        serviceType: LoadBalancer
      switch: Disable
    preConditionDeadlineSeconds: 0
    type: Expose
  ```

  等待 OpsRequest 完成：
  ```bash
  kubectl get ops redis-replication-expose-disable-ops -n demo
  ```
  示例输出：
  ```bash
  NAME                                   TYPE     CLUSTER      STATUS    PROGRESS   AGE
  redis-replication-expose-disable-ops   Expose   redis-replication   Succeed   1/1        12s
  ```

  </TabItem>

  <TabItem value="ClusterAPI" label="Cluster API">

  方法二：使用 Cluster API

  或者，从 Cluster 资源中移除 `spec.services` 字段：
  ```bash
  kubectl patch cluster redis-replication -n demo --type=json -p='[
    {
      "op": "remove",
      "path": "/spec/services"
    }
  ]'
  ```

  监控集群状态直到变为 Running：
  ```bash
  kubectl get cluster redis-replication -n demo -w
  ```

  ```
  NAME                CLUSTER-DEFINITION   TERMINATION-POLICY   STATUS    AGE
  redis-replication   redis           Delete               Running   23m
  ```
  </TabItem>
</Tabs>

### 验证服务移除

确保 'redis-replication-redis-internet' 服务已被移除：

```bash
kubectl get service -l app.kubernetes.io/instance=redis-replication -n demo
```

预期结果：'redis-replication-redis-internet' 服务应被移除。


## 清理
要删除所有创建的资源，删除 Redis 集群及其命名空间：
```bash
kubectl delete cluster redis-replication -n demo
kubectl delete ns demo
```


## 总结
本指南演示了如何：
- 使用 KubeBlocks 将 Redis 服务暴露到外部或内部。
- 使用云提供商特定的注解配置 LoadBalancer 服务。
- 通过 OpsRequest 或直接更新 Cluster API 来管理外部访问的启用或禁用。

KubeBlocks 为在 Kubernetes 环境中管理 Redis 服务提供了灵活性和简便性。