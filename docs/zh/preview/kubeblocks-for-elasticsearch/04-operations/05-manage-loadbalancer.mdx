---
description: 了解如何通过负载均衡器及其他服务类型，在KubeBlocks中配置和管理Elasticsearch服务，实现内外部访问。
keywords:
- KubeBlocks
- Elasticsearch
- LoadBalancer
- External Service
- Expose
- Kubernetes
sidebar_label: 管理Elasticsearch服务
sidebar_position: 5
title: 使用KubeBlocks中的声明式集群API创建和销毁Elasticsearch服务
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';


# 使用 KubeBlocks 声明式集群 API 管理 Elasticsearch 服务

本指南提供了逐步操作说明，指导如何对外部和内部暴露由 KubeBlocks 管理的 Elasticsearch 服务。您将学习如何通过云服务提供商的负载均衡器服务配置外部访问、管理内部服务，以及在不再需要时正确关闭外部暴露功能。

## 前提条件

import Prerequisites from '../_tpl/_prerequisites.mdx'

<Prerequisites />



## 部署 Elasticsearch 集群

import CreateCluster from '../_tpl/_create-cluster.mdx'

<CreateCluster />



## 验证部署

import VerifyCluster from '../_tpl/_verify-cluster.mdx'

<VerifyCluster />



## 查看网络服务
列出为 Elasticsearch 集群创建的服务：
```bash
kubectl get service -l app.kubernetes.io/instance=es-multinode -n demo
```

示例服务列表：
```bash
NAME                       TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE
es-multinode-dit-http      ClusterIP   10.96.224.72   <none>        9200/TCP   56m
es-multinode-master-http   ClusterIP   10.96.153.35   <none>        9200/TCP   56m
```

## 对外暴露 Elasticsearch 服务

外部服务地址允许公网访问 Elasticsearch，而内部服务地址将访问限制在用户的 VPC 内。

### 服务类型对比

| 类型          | 使用场景           | 云服务成本 | 安全性     |
|---------------|--------------------|------------|------------|
| ClusterIP     | 内部服务通信       | 免费       | 最高       |
| NodePort      | 开发测试环境       | 低         | 中等       |
| LoadBalancer  | 生产环境外部访问   | 高         | 通过安全组管理 |

<Tabs>

  <TabItem value="opsRequest" label="OpsRequest API" default>

  选项一：使用 OpsRequest

  要通过 LoadBalancer 对外暴露 Elasticsearch 服务，创建 OpsRequest 资源：

  ```yaml
  apiVersion: operations.kubeblocks.io/v1alpha1
  kind: OpsRequest
  metadata:
    name: es-multinode-expose-enable-ops
    namespace: demo
  spec:
    type: Expose
    clusterName: es-multinode
    expose:
    - componentName: master
      services:
      - name: internet
        # 决定服务暴露方式，默认为 'ClusterIP'
        # 可选值：'ClusterIP'、'NodePort' 和 'LoadBalancer'
        serviceType: LoadBalancer
        ports:
        - name: es-http
          port: 9200
          protocol: TCP
          targetPort: es-http
        # 当 ServiceType 为 LoadBalancer 时，包含云服务商相关参数
        # 以下是 AWS EKS 的配置示例
        annotations:
          service.beta.kubernetes.io/aws-load-balancer-type: nlb
          service.beta.kubernetes.io/aws-load-balancer-internal: "false"  # 设为 "true" 则使用内部 VPC IP
      switch: Enable
  ```

  等待 OpsRequest 完成：
  ```bash
  kubectl get ops es-multinode-expose-enable-ops -n demo
  ```

  示例输出：
  ```bash
  NAME                             TYPE     CLUSTER        STATUS    PROGRESS   AGE
  es-multinode-expose-enable-ops   Expose   es-multinode   Succeed   1/1        31s
  ```

  </TabItem>

  <TabItem value="ClusterAPI" label="Cluster API">

  选项二：使用 Cluster API

  或者，在 Cluster 资源的 `spec.services` 部分添加 LoadBalancer 服务配置：
  ```yaml
  apiVersion: apps.kubeblocks.io/v1
  kind: Cluster
  metadata:
    name: es-multinode
    namespace: demo
  spec:
    terminationPolicy: Delete
    clusterDef: elasticsearch
    # 暴露外部服务
    services:
      - annotations:
          service.beta.kubernetes.io/aws-load-balancer-type: nlb  # 使用网络负载均衡器
          service.beta.kubernetes.io/aws-load-balancer-internal: "false"  # 设为 "true" 则使用内部 VPC IP
        componentSelector: master
        name: master-internet
        serviceName: master-internet
        spec:
          ports:
          - name: es-http
            nodePort: 32751
            port: 9200
            protocol: TCP
            targetPort: es-http
          type: LoadBalancer
    componentSpecs:
    ...
  ```
  上述 YAML 配置在 services 部分新增了一个外部服务。该 LoadBalancer 服务包含了 AWS 网络负载均衡器（NLB）的注解。

  :::note
  云服务商注解说明

  使用 LoadBalancer 服务时，必须添加对应云服务商的特定注解。以下是不同云服务商的常用注解：

  - AWS
  ```yaml
  service.beta.kubernetes.io/aws-load-balancer-type: nlb  # 使用网络负载均衡器
  service.beta.kubernetes.io/aws-load-balancer-internal: "true"  # 设为 "false" 则创建面向互联网的负载均衡器
  ```

  - Azure
  ```yaml
  service.beta.kubernetes.io/azure-load-balancer-internal: "true" # 设为 "false" 则创建面向互联网的负载均衡器
  ```

  - GCP
  ```yaml
  networking.gke.io/load-balancer-type: "Internal"  # 限制负载均衡器仅限内部 VPC 访问。默认不指定时为面向互联网。
  cloud.google.com/l4-rbs: "enabled" # 面向互联网负载均衡器的优化配置
  ```

  - 阿里云
  ```yaml
  service.beta.kubernetes.io/alibaba-cloud-loadbalancer-address-type: "internet"  # 设为 "intranet" 则创建内部负载均衡器
  ```
  :::


  :::note
  `service.beta.kubernetes.io/aws-load-balancer-internal` 注解控制负载均衡器是内部还是面向互联网。注意该注解在服务创建后不能动态修改。
  ```yaml
    service.beta.kubernetes.io/aws-load-balancer-internal: "false"  # 设为 "true" 则使用内部 VPC IP
  ```
  如果在服务创建后将该注解从 "false" 改为 "true"，虽然 Service 对象中的注解会更新，但负载均衡器仍会保留其公网 IP。

  正确修改该行为的步骤：
  - 首先删除现有的 LoadBalancer 服务
  - 使用更新后的注解重新创建服务（`service.beta.kubernetes.io/aws-load-balancer-internal`: "true"）
  - 等待新的负载均衡器分配正确的内部或外部 IP
  :::


  使用以下命令等待集群状态变为 Running：
  ```bash
  kubectl get cluster es-multinode -n demo -w
  ```

  ```text
  NAME           CLUSTER-DEFINITION   TERMINATION-POLICY   STATUS    AGE
  es-multinode                        Delete               Running   18m
  ```
  </TabItem>

</Tabs>

### 验证暴露的服务
检查服务详情以确认 LoadBalancer 服务已创建：

```bash
kubectl get service -l app.kubernetes.io/instance=es-multinode -n demo
```

示例输出：
```bash
NAME                           TYPE            CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE
es-multinode-dit-http          ClusterIP       10.96.224.72   <none>        9200/TCP         59m
es-multinode-master-http       ClusterIP       10.96.153.35   <none>        9200/TCP         59m
es-multinode-master-internet   LoadBalancer    10.96.38.72    <EXTERNAL_IP> 9200:30998/TCP   19s
```

## 禁用外部暴露

<Tabs>

  <TabItem value="opsRequest" label="OpsRequest API" default>

  方法一：使用 OpsRequest

  要禁用外部访问，创建一个 OpsRequest：
  ```yaml
  apiVersion: operations.kubeblocks.io/v1alpha1
  kind: OpsRequest
  metadata:
    name: es-multinode-expose-disable-ops
    namespace: demo
  spec:
    clusterName: es-multinode
    expose:
    - componentName: master
      services:
      - name: internet
        serviceType: LoadBalancer
      switch: Disable
    preConditionDeadlineSeconds: 0
    type: Expose
  ```

  等待 OpsRequest 完成：
  ```bash
  kubectl get ops es-multinode-expose-disable-ops -n demo
  ```
  示例输出：
  ```bash
  NAME                              TYPE     CLUSTER        STATUS    PROGRESS   AGE
  es-multinode-expose-disable-ops   Expose   es-multinode   Succeed   1/1        16s
  ```

  </TabItem>

  <TabItem value="ClusterAPI" label="Cluster API">

  方法二：使用 Cluster API

  或者，从 Cluster 资源中移除 `spec.services` 字段：
  ```bash
  kubectl patch cluster es-multinode -n demo --type=json -p='[
    {
      "op": "remove",
      "path": "/spec/services"
    }
  ]'
  ```

  监控集群状态直到变为 Running：
  ```bash
  kubectl get cluster es-multinode -n demo -w
  ```

  ```bash
  NAME           CLUSTER-DEFINITION   TERMINATION-POLICY   STATUS    AGE
  es-multinode                        Delete               Running   26m
  ```
  </TabItem>
</Tabs>

### 验证服务移除

确保 'es-multinode-elasticsearch-internet' 服务已被移除：

```bash
kubectl get service -l app.kubernetes.io/instance=es-multinode -n demo
```

预期结果：'es-multinode-elasticsearch-internet' 服务应被移除。

## 清理资源
要删除所有已创建的资源，请执行以下命令删除Elasticsearch集群及其所在的命名空间：
```bash
kubectl delete cluster es-multinode -n demo
kubectl delete ns demo
```

## 概述  
本指南演示了如何通过KubeBlocks实现以下操作：  
- 对外或对内暴露Elasticsearch服务  
- 使用云服务商特定注解配置LoadBalancer类型的服务  
- 通过OpsRequest或直接更新Cluster API来管理外部访问，实现服务的启用或禁用  

KubeBlocks为Kubernetes环境中的Elasticsearch服务管理提供了灵活且简化的解决方案。  

