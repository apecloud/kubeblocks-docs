---
description: 了解如何在KubeBlocks中管理Elasticsearch集群状态，包括停止、启动和重启操作，以优化资源使用。
keywords:
- KubeBlocks
- Elasticsearch
- Cluster Management
- Stop
- Start
- Restart
sidebar_label: 生命周期管理
sidebar_position: 1
title: Elasticsearch 集群生命周期管理（停止、启动、重启）
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Elasticsearch 集群生命周期管理

本指南演示如何在 **KubeBlocks** 中管理 Elasticsearch 集群的运行状态，包括：

- 停止集群以节省资源
- 启动已停止的集群
- 重启集群组件

这些操作有助于优化 Kubernetes 环境中的资源使用并降低运营成本。

KubeBlocks 中的生命周期管理操作：

| 操作 | 效果 | 使用场景 |
|-----------|--------|----------|
| 停止 | 暂停集群运行，保留存储 | 节约成本、维护场景 |
| 启动 | 恢复集群运行 | 暂停后恢复服务 |
| 重启 | 重建组件 Pod | 配置变更、故障排查 |



## 前提条件

import Prerequisites from '../_tpl/_prerequisites.mdx'

<Prerequisites />



## 部署 Elasticsearch 集群

import CreateCluster from '../_tpl/_create-cluster.mdx'

<CreateCluster />



## 验证部署

import VerifyCluster from '../_tpl/_verify-cluster.mdx'

<VerifyCluster />



## 集群生命周期操作

### 停止集群

在 KubeBlocks 中停止 Elasticsearch 集群将执行以下操作：

1. 终止所有运行中的 Pod
2. 保留持久化存储（PVC）
3. 维持集群配置

此操作适用于以下场景：
- 临时节省成本
- 维护窗口期
- 开发环境暂停

<Tabs>

  <TabItem value="opsRequest" label="OpsRequest API" default>

  选项1：使用 OpsRequest API

  创建停止操作请求：

  ```yaml
  apiVersion: operations.kubeblocks.io/v1alpha1
  kind: OpsRequest
  metadata:
    name: es-multinode-stop-ops
    namespace: demo
  spec:
    clusterName: es-multinode
    type: Stop
  ```
  </TabItem>

  <TabItem value="ClusterAPI" label="Cluster API">

  选项2：使用 使用 Cluster API Patch

  通过修改 stop 字段直接调整集群规格：

  ```bash
  kubectl patch cluster es-multinode -n demo --type='json' -p='[
  {
    "op": "add",
    "path": "/spec/componentSpecs/0/stop",
    "value": true
  },
  {
    "op": "add",
    "path": "/spec/componentSpecs/1/stop",
    "value": true
  }
  ]'
  ```

  </TabItem>

</Tabs>

### 验证集群停止

确认停止操作成功：

1. 检查集群状态转换：
    ```bash
    kubectl get cluster es-multinode -n demo -w
    ```
    示例输出：
    ```bash
    NAME           CLUSTER-DEFINITION   TERMINATION-POLICY   STATUS     AGE
    es-multinode                        Delete               Stopping   8m6s
    es-multinode                        Delete               Stopped    9m41s
    ```

2. 确认无运行中的 Pod：
    ```bash
    kubectl get pods -l app.kubernetes.io/instance=es-multinode -n demo
    ```
    示例输出：
    ```bash
    No resources found in demo namespace.
    ```

3. 验证持久卷仍然存在：
    ```bash
    kubectl get pvc -l app.kubernetes.io/instance=es-multinode -n demo
    ```
    示例输出：
    ```bash
    NAME                         STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
    data-es-multinode-dit-0      Bound    pvc-aa8136e5-a69a-4117-bb4c-8978978bb77f   20Gi       RWO            standard       <unset>                 8m25s
    data-es-multinode-dit-1      Bound    pvc-408fe4d5-b3a9-4984-b6e5-48ec133307eb   20Gi       RWO            standard       <unset>                 8m25s
    data-es-multinode-dit-2      Bound    pvc-cf6c3c7c-bb5f-4fa6-8dff-33e0862f8ef9   20Gi       RWO            standard       <unset>                 8m25s
    data-es-multinode-master-0   Bound    pvc-5793e794-8c91-4bba-b6e8-52c414ec0ade   20Gi       RWO            standard       <unset>                 8m25s
    data-es-multinode-master-1   Bound    pvc-044dae8d-82ee-41f3-867d-c8f27ec08fbe   20Gi       RWO            standard       <unset>                 8m25s
    data-es-multinode-master-2   Bound    pvc-2af7cedb-2f5f-4846-be43-ff6da8109880   20Gi       RWO            standard       <unset>                 8m25s
    ```

### 启动集群

启动已停止的 Elasticsearch 集群将：
1. 重新创建所有 Pod
2. 重新挂载持久化存储
3. 恢复服务端点

预期行为：
- 集群恢复到之前状态
- 不会发生数据丢失
- 服务自动恢复
<Tabs>

  <TabItem value="opsRequest" label="OpsRequest API" default>

  发起启动操作请求：

  ```yaml
  apiVersion: operations.kubeblocks.io/v1alpha1
  kind: OpsRequest
  metadata:
    name: es-multinode-start-ops
    namespace: demo
  spec:
    # 指定此操作目标集群资源的名称
    clusterName: es-multinode
    type: Start
  ```

  </TabItem>

  <TabItem value="ClusterAPI" label="Cluster API">

  修改集群规格以恢复运行：
  1. 设置 stop: false，或
  2. 完全移除 stop 字段

    ```bash
    kubectl patch cluster es-multinode -n demo --type='json' -p='[
    {
      "op": "remove",
      "path": "/spec/componentSpecs/0/stop"
    },
    {
      "op": "remove",
      "path": "/spec/componentSpecs/1/stop"
    }
    ]'
    ```

  </TabItem>

</Tabs>

### 验证集群启动

确认启动操作成功：

1. 检查集群状态转换：
    ```bash
    kubectl get cluster es-multinode -n demo -w
    ```
    示例输出：
    ```bash
    NAME           CLUSTER-DEFINITION     TERMINATION-POLICY   STATUS     AGE
    es-multinode                          Delete               Updating   24m
    es-multinode                          Delete               Running    24m
    es-multinode                          Delete               Running    24m
    ```

2. 验证 Pod 重建：
    ```bash
    kubectl get pods -n demo -l app.kubernetes.io/instance=es-multinode
    ```
    示例输出：
    ```bash
    NAME                    READY   STATUS    RESTARTS   AGE
    es-multinode-dit-0      3/3     Running   0          24m
    es-multinode-dit-1      3/3     Running   0          24m
    es-multinode-dit-2      3/3     Running   0          24m
    es-multinode-master-0   3/3     Running   0          24m
    es-multinode-master-1   3/3     Running   0          24m
    es-multinode-master-2   3/3     Running   0          24m
    ```

### 重启集群

重启操作提供以下特性：
- 无需完全停止集群即可重建 Pod
- 组件级粒度控制
- 最小化服务中断

适用场景：
- 需要重启的配置变更
- 资源刷新
- 故障排查

**检查组件**

Milvus 集群包含五个组件。获取组件列表：
```bash
kubectl get cluster -n demo es-multinode -oyaml | yq '.spec.componentSpecs[].name'
```

预期输出：
```text
dit
master
```

**通过 OpsRequest API 重启 Proxy**

列出需要重启的特定组件：

```yaml
apiVersion: operations.kubeblocks.io/v1alpha1
kind: OpsRequest
metadata:
  name: es-multinode-restart-ops
  namespace: demo
spec:
  clusterName: es-multinode
  type: Restart
  restart:
  - componentName: dit
```

**验证重启完成**

确认组件重启成功：

1. 跟踪 OpsRequest 进度：
    ```bash
    kubectl get opsrequest es-multinode-restart-ops -n demo -w
    ```
    示例输出：
    ```bash
    NAME                       TYPE      CLUSTER        STATUS    PROGRESS   AGE
    es-multinode-restart-ops   Restart   es-multinode   Running   0/3        8s
    es-multinode-restart-ops   Restart   es-multinode   Running   1/3        59s
    es-multinode-restart-ops   Restart   es-multinode   Running   2/3        117s
    es-multinode-restart-ops   Restart   es-multinode   Running   3/3        2m55s
    es-multinode-restart-ops   Restart   es-multinode   Running   3/3        2m55s
    es-multinode-restart-ops   Restart   es-multinode   Succeed   3/3        2m55s
    ```

2. 检查 Pod 状态：
    ```bash
    kubectl get pods -n demo -l app.kubernetes.io/instance=es-multinode
    ```
    注意：重启后 Pod 将显示新的创建时间戳。只有属于组件 `dit` 的 Pod 会被重启。

操作完成后，集群将返回 Running 状态。

## 概述
在本指南中，您学习了如何：
1. **停止 Elasticsearch 集群**：暂停服务运行同时保留持久化存储。
2. **启动已停止的集群**：将集群重新上线恢复服务。
3. **重启特定集群组件**：在不停止整个集群的情况下，通过重建对应Pod实现组件更新。

通过管理 Elasticsearch 集群的生命周期，您可以优化资源利用率、降低成本，并在 Kubernetes 环境中保持运维灵活性。KubeBlocks 提供了无缝执行这些操作的能力，在确保高可用性的同时将服务中断降至最低。