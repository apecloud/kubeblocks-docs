---
description: 了解如何在KubeBlocks上部署PostgreSQL集群，并通过Kubernetes Secret安全配置自定义root密码。
keywords:
- PostgreSQL
- KubeBlocks
- Custom Password
- Kubernetes
- Secrets
sidebar_label: 自定义密码
sidebar_position: 1
title: 在KubeBlocks上创建带自定义根密码的PostgreSQL集群
---
# 在 KubeBlocks 上创建带自定义密码的 PostgreSQL 集群

本指南演示如何在 KubeBlocks 中部署 PostgreSQL 集群，并将自定义的 root 密码存储在 Kubernetes Secret 中。

## 先决条件

import Prerequisites from '../_tpl/_prerequisites.mdx'

<Prerequisites />

## 部署 PostgreSQL 复制集群

KubeBlocks 采用声明式方法管理 PostgreSQL 集群。以下是一个部署包含 2 个节点（1 个主节点，1 个副本节点）且使用自定义 root 密码的 PostgreSQL 集群配置示例。

### 步骤 1：为 root 账户创建 Secret

自定义 root 密码存储在 Kubernetes Secret 中。通过应用以下 YAML 创建 Secret：

```yaml
apiVersion: v1
data:
  password: Y3VzdG9tcGFzc3dvcmQ= # custompassword
  username: cm9vdA== #root
immutable: true
kind: Secret
metadata:
  name: custom-pg-secret
  namespace: demo
```
- password: 将 custompassword 替换为您想要的密码，并使用 Base64 编码（`echo -n "custompassword" | base64`）。
- username: 默认的 PostgreSQL postgres 用户是 'root'，编码为 'cm9vdA=='。

### 步骤 2：部署 PostgreSQL 集群

应用以下清单文件部署 PostgreSQL 集群，并引用步骤 1 中创建的 Secret 作为 root 账户凭据：
```yaml
apiVersion: apps.kubeblocks.io/v1
kind: Cluster
metadata:
  name: pg-cluster
  namespace: demo
spec:
  terminationPolicy: Delete
  clusterDef: postgresql
  topology: replication
  componentSpecs:
    - name: postgresql
      serviceVersion: 16.4.0
      labels:
        apps.kubeblocks.postgres.patroni/scope: pg-cluster-postgresql
      disableExporter: true
      replicas: 2
      systemAccounts:
        - name: postgres
          secretRef:
            name: custom-pg-secret
            namespace: demo
      resources:
        limits:
          cpu: "0.5"
          memory: "0.5Gi"
        requests:
          cpu: "0.5"
          memory: "0.5Gi"
      volumeClaimTemplates:
        - name: data
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
```
**关键字段说明**
- `systemAccounts`: 覆盖引用的 `ComponentDefinition` 中定义的系统账户。

:::tip

在 KubeBlocks PostgreSQL 插件中，预定义了一系列系统账户。只有这些账户才能通过新 Secret 进行自定义配置。

:::

获取账户列表：
```bash
kubectl get cmpd postgresql-16-1.0.0         -oyaml | yq '.spec.systemAccounts[].name'
```

预期输出：
```bash
postgres
kbadmin
...
```

## 验证部署

import VerifyPGCluster from '../_tpl/_verify-pg-replication-cluster.mdx'

<VerifyPGCluster />

## 连接 PostgreSQL 集群

KubeBlocks 会自动创建包含 PostgreSQL postgres 凭据的 Secret。通过以下命令获取凭据：

```bash
kubectl get secrets -n demo pg-cluster-postgresql-account-postgres -o jsonpath='{.data.password}' | base64 -d
custompassword
```

使用自定义密码连接集群的主节点：
```bash
kubectl exec -it -n demo pg-cluster-postgresql-0 -c postgresql -- env PGUSER=postgres PGPASSWORD=custompassword psql
```

## 清理资源
删除 PostgreSQL 集群及其命名空间以移除所有创建的资源：

```bash
kubectl delete cluster pg-cluster -n demo
kubectl delete secret custom-pg-secret -n demo
kubectl delete ns demo
```

## 总结
在本指南中，您完成了以下操作：
- 创建 Kubernetes Secret 安全存储自定义的 PostgreSQL postgres 密码
- 在 KubeBlocks 中部署了使用自定义 root 密码的 PostgreSQL 集群
- 验证了部署并使用 PostgreSQL 客户端连接到集群主节点

使用 Kubernetes Secret 可以确保 PostgreSQL 集群凭据的安全管理，而 KubeBlocks 则简化了部署和管理流程。