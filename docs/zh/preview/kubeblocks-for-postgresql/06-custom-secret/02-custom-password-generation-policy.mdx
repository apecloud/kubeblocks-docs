---
description: 了解如何在KubeBlocks中部署PostgreSQL集群，并通过为root用户配置自定义密码生成策略以增强安全性。
keywords:
- PostgreSQL
- KubeBlocks
- Password Policy
- Kubernetes
- Security
sidebar_label: 自定义密码策略
sidebar_position: 2
title: 在KubeBlocks上部署采用自定义密码生成策略的PostgreSQL集群
---
# 在 KubeBlocks 上创建采用自定义密码生成策略的 PostgreSQL 集群

本指南将介绍如何在 KubeBlocks 中部署一个 PostgreSQL 集群，并为 root 用户设置自定义密码生成策略。通过定义特定的密码规则，您可以确保集群使用强密码凭证。

## 先决条件

import Prerequisites from '../_tpl/_prerequisites.mdx'

<Prerequisites />

## 部署 PostgreSQL 复制集群

KubeBlocks 采用声明式方法管理 PostgreSQL 集群。以下是一个部署包含 2 个节点（1 主节点，1 副本节点）且采用自定义密码生成策略的 PostgreSQL 集群配置示例。

```yaml
apiVersion: apps.kubeblocks.io/v1
kind: Cluster
metadata:
  name: pg-cluster
  namespace: demo
spec:
  terminationPolicy: Delete
  clusterDef: postgresql
  topology: replication
  componentSpecs:
    - name: postgresql
      serviceVersion: 16.4.0
      labels:
        apps.kubeblocks.postgres.patroni/scope: pg-cluster-postgresql
      disableExporter: true
      replicas: 2
      systemAccounts:
        - name: postgres
          passwordConfig:
            length: 20           # 密码长度：20个字符
            numDigits: 4         # 至少包含4位数字
            numSymbols: 2        # 至少包含2个符号
            letterCase: MixedCases # 包含大小写字母
            symbolCharacters: '!' # 设置密码生成时允许使用的符号
      resources:
        limits:
          cpu: "0.5"
          memory: "0.5Gi"
        requests:
          cpu: "0.5"
          memory: "0.5Gi"
      volumeClaimTemplates:
        - name: data
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
```

**关键字段说明**
- `systemAccounts`: 覆盖所引用 `ComponentDefinition` 中定义的系统账户
- `passwordConfig`: 为 `postgres` 用户自定义密码生成策略
- `symbolCharacters`: 设置密码生成时允许使用的符号

:::tip

在 KubeBlocks PostgreSQL 插件中，预定义了一系列系统账户。只有这些账户才能通过新密钥进行自定义配置。

:::

获取账户列表：
```bash
kubectl get cmpd postgresql-16-1.0.0         -oyaml | yq '.spec.systemAccounts[].name'
```

预期输出：
```bash
postgres
kbadmin
...
```

## 验证部署

import VerifyPGCluster from '../_tpl/_verify-pg-replication-cluster.mdx'

<VerifyPGCluster />

## 连接 PostgreSQL 集群

KubeBlocks 会自动创建一个包含 PostgreSQL postgres 凭证的 Secret。通过以下命令获取凭证：

```bash
PASSWORD=$(kubectl get secrets -n demo pg-cluster-postgresql-account-postgres -o jsonpath='{.data.password}' | base64 -d)
```

使用自定义密码连接到集群主节点：
```bash
kubectl exec -it -n demo pg-cluster-postgresql-0 -c postgresql -- env PGUSER=postgres PGPASSWORD=$PASSWORD psql
```

## 清理资源
删除 PostgreSQL 集群及其命名空间以移除所有创建的资源：

```bash
kubectl delete cluster pg-cluster -n demo
kubectl delete ns demo
```

## 总结
在本指南中，您完成了以下操作：
- 在 KubeBlocks 中部署了采用自定义密码生成策略的 PostgreSQL 集群
- 验证了部署并通过 PostgreSQL 客户端连接到集群主节点