---
description: 了解如何创建并配置一个使用S3存储桶保存备份数据的KubeBlocks BackupRepo。
keywords:
- KubeBlocks
- Backup
- BackupRepo
- S3
- Kubernetes
sidebar_label: 创建备份仓库
sidebar_position: 1
title: 为KubeBlocks创建备份仓库
---
# 为 KubeBlocks 创建备份仓库

本指南将引导您通过使用 S3 存储桶来创建和配置 KubeBlocks 中的备份仓库（BackupRepo），用于存储备份数据。

## 前提条件
- 已配置具有创建 S3 存储桶权限的 AWS CLI
- 拥有 Kubernetes 集群的 kubectl 访问权限
- 已安装 KubeBlocks（[安装指南](../user_docs/overview/install-kubeblocks）并在 kb-system 命名空间中运行

## 步骤 1：创建 S3 存储桶

使用 AWS CLI 在目标区域创建 S3 存储桶。将 `<your-region>` 替换为您所需的 AWS 区域（例如 `us-east-1`、`ap-southeast-1`）。

```bash
 aws s3api create-bucket --bucket kubeblocks-backup-repo --region <your-region> --create-bucket-configuration LocationConstraint=<your-region>
```

示例（us-west-1 区域）：
```bash
aws s3api create-bucket \
  --bucket kubeblocks-backup-repo \
  --region us-west-1 \
  --create-bucket-configuration LocationConstraint=us-west-1
```

示例输出：

```json
{
"Location": "http://kubeblocks-backup-repo.s3.amazonaws.com/"
}
```

验证：
通过列出存储桶内容确认创建成功（初始应为空）：

```bash
aws s3 ls s3://kubeblocks-backup-repo
```

## 步骤 2：创建 Kubernetes Secret 存储 AWS 凭证

将您的 AWS 凭证安全地存储在 Kubernetes Secret 中。将 `<ACCESS_KEY>` 和 `<SECRET_KEY>` 替换为实际的 AWS 凭证：

```bash
# 创建 secret 保存访问密钥
kubectl create secret generic s3-credential-for-backuprepo \
  --from-literal=accessKeyId=<ACCESS KEY> \
  --from-literal=secretAccessKey=<SECRET KEY> \
  -n kb-system
```

## 步骤 3：配置备份仓库

备份仓库（BackupRepo）是用于定义备份存储位置的自定义资源。本步骤将通过创建 BackupRepo 资源将您的 S3 存储桶与 KubeBlocks 集成。

应用以下 YAML 创建备份仓库。请根据实际情况替换字段（如存储桶名称、区域等）。

```yaml
apiVersion: dataprotection.kubeblocks.io/v1alpha1
kind: BackupRepo
metadata:
  name: s3-repo
  annotations:
    # 将此备份仓库标记为默认仓库
    dataprotection.kubeblocks.io/is-default-repo: 'true'
spec:
  # 当前 KubeBlocks 支持配置多种对象存储服务作为备份仓库
  # - s3 (Amazon Simple Storage Service)
  # - oss (阿里云对象存储服务)
  # - cos (腾讯云对象存储)
  # - gcs (Google 云存储)
  # - obs (华为云对象存储)
  # - minio 及其他 S3 兼容服务
  storageProviderRef: s3
  # 指定备份仓库的访问方式
  # - Tool
  # - Mount
  accessMethod: Tool
  # 指定此备份仓库创建的 PV 回收策略
  pvReclaimPolicy: Retain
  # 指定此备份仓库创建的 PVC 容量
  volumeCapacity: 100Gi
  # 存储 StorageProvider 的非敏感配置参数
  config:
    bucket: kubeblocks-backup-repo
    endpoint: ''
    mountOptions: --memory-limit 1000 --dir-mode 0777 --file-mode 0666
    region: us-west-1
  # 引用存储 StorageProvider 凭证的 secret
  credential:
    # name 是在命名空间内引用 secret 资源的唯一标识
    name: s3-credential-for-backuprepo
    # namespace 定义了 secret 名称必须唯一的空间范围
    namespace: kb-system
```

## 步骤 4：验证备份仓库状态

检查 BackupRepo 状态以确保其正确初始化：

```bash
kubectl get backuprepo s3-repo -w
```

预期状态变化：
```bash
NAME      STATUS        STORAGEPROVIDER   ACCESSMETHOD   DEFAULT   AGE
s3-repo   PreChecking   s3                Tool           true      5s
s3-repo   Ready         s3                Tool           true      35s
```

故障排除：
 - 如果状态变为 Failed：
   - 确认存储桶名称和区域与 S3 配置匹配
   - 检查 Secret 中的 AWS 凭证是否正确
   - 验证 KubeBlocks 与 AWS S3 之间的网络连接