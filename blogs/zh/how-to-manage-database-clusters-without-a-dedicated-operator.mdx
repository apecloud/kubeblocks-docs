---
authors:
  name: Shanshan Ying & Shun Ding
date: 2024-09-03
description: 这是由ApeCloud与中国移动云在KubeCon China 2024上联合呈现的演讲。本次演讲将介绍KubeBlocks的诞生背景与实现原理，并分享中国移动云如何在不依赖专用Operator的情况下运行其云数据库服务。
image: /img/blogs/thumbnails/blog-kubecon-china-mobile-cloud.png
slug: how-to-manage-database-clusters-without-a-dedicated-operator
tags:
- database management
- operator
- K8s
title: 如何在没有专用Operator的情况下管理数据库集群？
---
# 如何在没有专用Operator的情况下管理数据库集群？

随着云计算和数据库技术的发展，寻找一种高效且经济的方式来管理数据库集群变得至关重要。我希望本次演讲能为您提供有价值的见解和实用解决方案。

在深入细节之前，请允许我介绍一下自己和共同演讲者。我是来自KubeBlocks的Shanshan，ApeCloud是KubeBlocks背后的初创公司。在加入ApeCloud之前，我曾在阿里云数据库团队工作多年，担任SQL优化和SQL执行的数据库开发人员，更专注于数据库而非云原生技术。我的共同演讲者Shun Ding来自中国移动云的系统架构师，同时也是KubeBlocks的贡献者。他在今年早些时候提交了第一个commit，几个月后便将他们的内部数据库作为插件集成到了KubeBlocks中。

今天，我将介绍KubeBlocks及其设计理念，而Shun将分享他们选择KubeBlocks的原因、KubeBlocks如何帮助他们减少工作量以及他们与KubeBlocks的下一步计划。本次演讲中我们不会深入探讨具体的API或特定的数据库技术。

## KubeBlocks 的设计初衷与实现方式

### 如何在 K8s 上管理多种数据库？

我们启动 KubeBlocks 项目的动机非常简单：如何更高效地管理数据库。
我们的团队由兼具数据库和 K8s 背景的成员组成，包括数据库开发者、数据库管理员和 SRE。我们每天处理数百个云数据库问题，从数据库崩溃、慢查询、高可用性到数据迁移、资源调度等。

我们团队的有趣之处在于，我们处理不同类型的数据库，例如广泛使用的开源数据库 MySQL、PostgreSQL、Redis、MongoDB。当我们交流如何管理特定数据库时，发现这些数据库实际上有许多共同点。如果我们能改进一个数据库的管理方式，其他数据库是否也能受益？此外，数据库正处于快速发展的时代，新的数据产品不断涌现。这些新数据库在某种程度上仍然继承了那些共同特性。

因此我们面临的挑战是：能否设计一个统一平台，不仅能管理一种，还能管理一批广泛使用的数据库，甚至进一步管理那些新兴数据库？更重要的是，如果有这样的平台，我们希望它既能部署在云端也能部署在本地基础设施上。

于是，Kubernetes 成为自然选择，因为它已成为容器编排的事实标准，并且可以将平台带到任何有 Kubernetes 的地方，如公有云、私有云、边缘云等。因此挑战在于如何在 Kubernetes 上管理多种数据库。

"在 Kubernetes 上"的答案很直接，即开发一个 Operator。但"多种数据库"呢？

首先让我们看看"管理"指的是什么。当我们谈论"管理数据库"时，通常包括：
部署、扩缩容（水平或垂直）、备份与恢复、配置（特别是参数和性能调优）、次版本升级、存储卷扩容和监控。

要开发一个涵盖所有这些功能的专用 Operator，需要一个由数据库专家和云原生专家组成的团队，数月的投入，最重要的是要有大量用户基础。用户越多，Operator 就越好。但这可能相当具有挑战性，并非每个数据库团队都能承担这样的工作。而且 Operator 的成熟度可能参差不齐。

与蓬勃发展的 Kubernetes 相比，数据库领域似乎相对小众。我们能否找到一种方法，将数据库专家的知识快速转化为生产力，即转化为代码？这样越来越多的数据库就能轻松运行在 Kubernetes 上。

这里我们以备份和恢复为例。备份和恢复对灾难恢复至关重要。让我们回顾经典的备份和恢复流程。

1. 备份方法：该流程通常有一种或多种备份方法，例如定期全量备份和持续归档日志。要进行定期全量备份，可以采用一些广泛使用的数据库专用备份工具，或者简单地拍摄存储卷快照。
2. 备份调度器：然后有一个备份调度器定期触发备份，比如每小时、每天、每周或在用户指定的时间。
3. 备份仓库：之后，必须配置一个备份仓库，以存储每个备份及其元数据一段时间。备份仓库可以是本地 PV，也可以是对象存储，如 S3、OSS 或测试环境中的 MinIO。
4. 恢复：当从备份恢复数据库集群时，必须设置数据恢复流程，并决定是在 Pod 运行之前还是之后恢复数据。

![回顾备份与恢复](/img/blogs/dedicated-operator-1.png)

在整个流程中，我们发现数据库专家的工作非常专注且有限，主要包括：

- 如何使用数据库专用备份工具；
- 如何设置归档日志；
- 以及如何配置恢复命令（如有）。

其他列出的任务可以交给云原生专家处理。云原生专家只需开发支持该流程的框架，该框架可被不同数据库专家复用，或用于同一数据库的不同版本。

### KubeBlocks 架构

基于这些理念，KubeBlocks 应运而生。KubeBlocks 是一个开源且云中立的项目，去年六月开源，目前已有 2k star。KubeBlocks 是一个数据库类型无关的 Operator，设计上具备可扩展性、灵活性和可插拔性。

其可扩展性源于统一的 API。KubeBlocks 提供了集成数据库引擎的插件机制，这也是中国移动云能在两个月内将其自研和开源数据库集成到 KubeBlocks 的关键。目前我们已有约 30 个插件，大部分由社区根据自身需求贡献。

它具有灵活性，意味着支持非常灵活的集群拓扑。用户可以自定义集群拓扑，每个组件都来自插件市场。

通过模块化设计实现可插拔性。备份恢复、监控、配置等模块均可插拔，可根据具体需求选择使用哪些模块。

若对 KubeBlocks 感兴趣，可访问我们的 GitHub 仓库，获取更多技术细节、文档以及完整的数据库插件列表。

所有这些特性都得益于我们对数据库的精准简洁建模，这是从数据库视角的关键所在。我们通过以下三个步骤完成建模。

**第一步：构建分层模型**

我们首先将每个独立数据库系统或服务建模为组件，例如提供 MySQL 服务的 MySQL 组件，以及负责 MySQL 高可用和复制管理的编排器组件。这种建模非常直观。

而数据库集群本质上是协同处理特定数据库任务的组件集合。例如，由 MySQL 组件和编排器组件组成的集群可构成高可用的 MySQL 复制集群。此外，您还可以使用任意偏好的代理组件（如 HAProxy 和 ProxySQL）自定义该集群。

这两个层级——独立的数据库组件和整体集群——提供了清晰易懂的结构。但数据库的特殊性何在？它不仅是有状态的，更重要的是：它具有角色。

我们专门为数据库设计了一种工作负载类型 InstanceSet，提供基于角色的管理能力。

KubeBlocks InstanceSet 是改进版的 StatefulSet，它按特定角色顺序管理数据库以提升可用性，而非采用 StatefulSet 的升序或降序数字编号。InstanceSet 支持资源与配置各异的异构副本，并能将单个数据库实例主动下线进行维护（例如当副本异常或节点需要升级时）。

后天将有 KubeBlocks 与快手的另一场分享，我的同事薛强将详细介绍 instanceset。

![第一步：构建分层模型](/img/blogs/dedicated-operator-2.png)

**第二步：分离集群模板 API 与集群 API**

我们注意到对于仅想创建集群的数据库用户而言，这仍然过于复杂。
除了四层建模外，我们进一步将每层分为两部分：一部分面向数据库专家，另一部分面向数据库用户。

数据库专家负责处理集群拓扑定义、描述引擎特定行为的组件定义，以及描述引擎镜像并确保兼容性的组件版本。
数据库用户只需了解所需的集群和组件，对于每个组件，他们只需关注资源配置，例如 CPU、内存、存储卷大小和副本数量。

![Step 2. Separate the cluster template API and the cluster API](/img/blogs/dedicated-operator-3.png)

步骤 3. 引入数据库接口。

随着越来越多的数据库集成到 KubeBlocks 中，我们发现初始化脚本远不足以描述引擎的特定行为。

为此，我们提出了一套数据库接口来管理副本或组件生命周期，在 KubeBlocks 中称为生命周期操作（Lifecycle Actions）。没有这些操作，就无法良好地管理数据库。每个操作的具体细节因数据库而异。我将这些操作分为三类：

- 用于角色管理的角色探测（role probe）和切换（switchover）；
- 用于水平扩缩容的成员加入（memberJoin）、成员退出（memberLeave）、数据转储（dataDump）和数据加载（dataLoad）；
- 用于组件级管理的后置部署（post-provision）和前置终止（pre-termination）操作。

目前最广泛使用的操作是角色探测（roleProbe）。它会定期触发，检查每个副本的角色，并通过事件或 API 调用将结果报告给 Pod。这样数据库服务就能按预期路由到正确的副本。

随着更多插件的加入，我们将持续完善这些操作，目前仍有未覆盖的操作，例如重新配置（reconfiguring）和账户供应（account provisioning）。

![Lifecycle actions](/img/blogs/dedicated-operator-4.png)

总结来说，KubeBlocks 是一个与数据库类型无关的 Operator。它提供了统一的 API，数据库专家可以通过我们的插件机制集成特定引擎，专注于数据库专业知识。而数据库用户或管理员可以使用相同的 API 与不同数据库交互。这显著降低了数据库管理的复杂性和学习曲线。

![Summary](/img/blogs/dedicated-operator-5.png)

KubeBlocks 1.0 版本将于两个月内正式发布，欢迎加入我们的社区。

## 中国移动云如何运用KubeBlocks

大家下午好，我是来自中国移动云的Shun，担任高级系统架构师。今天很高兴能与各位分享我们如何在不编写专用Operator的情况下，通过KubeBlocks管理云数据库。

### 中国移动云DBaaS系统面临的挑战

在进入正题前，请允许我先介绍中国移动云DBaaS系统的概况。这个系统管理着我们所有的云数据库，产品线涵盖事务型数据库、分析搜索型数据库、NoSQL数据库等。我们不仅为热门开源数据库和第三方数据库提供服务，还在自主研发数据库引擎并基于其构建服务。目前我们为超过3.5万家企业客户提供服务，覆盖政务、通信、金融、医疗、教育等9大行业。

在我们的15个一级节点和31个二级节点上，运行着超过13万个数据库集群实例。除数据库供给外，我们还构建了完善的管理生态，包括数据迁移工具、数据库管理控制台以及具备AIOps能力的工具集。中国移动云DBaaS平台采用云原生架构，这意味着大多数数据库实例都运行在Kubernetes集群中。

管理如此大规模的数据库实例充满挑战。虽然现有DBaaS系统能有效管理各类数据库，但在系统维护方面我们正面临难题。当前DBaaS系统主要分为API层和Operator层，其中Operator层是核心组件。

我们遇到的第一个挑战是：针对不同数据库引擎需要开发不同的Operator。这些Operator差异显著，导致开发人员难以在引擎A和引擎B的Operator开发间灵活切换，造成人力资源分配僵化。

其次，这对开发者的能力要求极高，他们需要同时精通数据库引擎原理和Operator框架。尽管有现成框架可用，但开发门槛仍然很高，难以快速扩充高效团队。更重要的是，我们正在自研数据库引擎，希望能快速为其构建DBaaS系统。

但由于前述挑战，我们无法快速为新引擎开发DBaaS系统。要实现这个目标，必须组建同时掌握数据库引擎和Operator框架的高水平团队。接着开发者需要从零构建新Operator，因为是自研引擎，没有现成Operator可用。这种从零开发模式会产生大量重复工作，即便某些逻辑与其他数据库Operator相似也无法复用。

于是我们开始寻找解决方案：如何统一Operator接口？如何降低DBaaS系统开发门槛？如何实现新数据库引擎的快速集成？

![挑战](/img/blogs/dedicated-operator-6.png)

### 为什么选择KubeBlocks？

正是在这个阶段，我们发现了能有效解决这些痛点的KubeBlocks项目。KubeBlocks是专为数据库工作负载设计的通用Operator框架，开发者可以通过编写不同数据库引擎的插件将其集成到KubeBlocks体系中。这个项目在以下几个方面尤为突出：

首先，KubeBlocks 是一个通用的 Operator 框架，这意味着单个 Operator 可以支持所有类型的数据库引擎。开发者只需维护一个 Operator 和一套 CRD，从而更容易在团队内部共享 Operator 层面的知识。这也使得开发者可以灵活分配到不同的引擎团队。

此外，该框架采用低代码开发模式，通过创建插件（addon）来集成不同的数据库引擎，而非从零开发专用的 Operator。

这些插件本质上是包含 KubeBlocks 框架 CR 对象的 Helm Chart。开发插件时，我们只需编写所需 CR 对象的 YAML 文件和少量功能脚本。后续我们会深入探讨这些细节。插件中的 CR 对象采用声明式定义，开发者可以像描述其他 Kubernetes 对象一样描述运行中数据库集群的期望状态，而由 KubeBlocks 框架负责协调（reconciliation）。这种低代码开发模式大幅降低了为新数据库引擎构建 DBaaS 系统的门槛——开发者只需了解引擎的工作原理即可快速上手。

同时，更少的代码意味着更少的潜在错误，以及更快的新数据库引擎集成速度，这完全符合我们的需求。

更重要的是，KubeBlocks 是专为数据库工作负载设计的通用框架。它完整覆盖了 Kubernetes 上数据库的所有基础管理操作，例如生命周期管理、备份恢复、配置管理、高可用性等。

此外，KubeBlocks 还包含可扩展机制，允许特定数据库引擎的管理操作无缝集成到整体框架中。

![Why KubeBlocks](/img/blogs/dedicated-operator-7.png)

### 基于 KubeBlocks 构建 H-DB 插件

经过深入研究后，我们决定尝试 KubeBlocks。当时我们需要将一个内部研发的数据库引擎（代号 H-DB）集成到 DBaaS 系统中，这成为测试 KubeBlocks 集成能力的理想场景。

首先简要介绍我们的 H-DB：这是一个完全自研的云原生分布式数据库引擎，采用计算存储分离架构。通常为如此复杂的数据库系统编写 DB Operator 具有挑战性，更不用说快速实现。但得益于 KubeBlocks 项目，我们可以通过低代码方式实现。以下是构建完整 KubeBlocks 插件的过程：

以下是严格遵循您要求的翻译结果，保持所有格式、间距和换行不变：

- 第一步是设计集群拓扑结构，并搭建一个插件脚手架。通常，初始插件仅包含一个粗略的ClusterDefinition脚手架和一个非常基础的ClusterVersion，用于指定所有组件容器的镜像。回到我们的案例，H-DB集群包含两个组件：计算节点和数据节点。因此我们定义了一个包含这两个组件的集群定义对象，在ClusterVersion中为每个组件配置了镜像，并暂时在ClusterDefinitions中设置了一个虚拟启动命令。然后我们编写了一个简单的Cluster CR对象进行测试，以确保所有插件可以无问题安装且Pod能够成功启动。
- 下一步是完善ClusterDefinition，在ConfigMap中设置正确的配置参数，同时编写引导集群的脚本。我们调整配置和脚本使集群正常运行。这是关键步骤，因为它意味着第一个可工作的插件已完成。
- 接下来的部分是支持备份和恢复能力。我们需要编写关于备份和恢复的功能脚本，并将其集成到KubeBlocks的ActionSet CR对象中。我们可以创建备份OpsRequest和恢复OpsRequest来测试功能。
- 然后，我们在插件上编写ConfigConstraint，以控制哪些参数可以修改、是否可以动态重新加载以及重新加载命令。这使得插件能够修改数据库引擎中的某些配置参数。
- 之后，我们对该插件进行了进一步调整。下一步是启用高可用性和角色检测，向数据库集群添加可观测性边车以从实例收集指标和日志，最后添加更多集群版本以映射不同的内核版本。

现在，一个完整的KubeBlocks插件为我们的H-DB就完成了。通过使用KubeBlocks，我们仅用两个月时间、仅由一人就构建了首个H-DB的DBaaS系统。这甚至可以更快，因为构建插件的后续步骤可以并行化。这是我们在中国移动云中首个成功的KubeBlocks集成案例。

以下是开发KubeBlocks插件与开发专用Operator的总结对比。我们将KubeBlocks插件开发过程与为类似数据库引擎编写专用Operator的过程进行比较。

在开发资源方面，KubeBlocks插件仅需2人月，而具有Operator的类似产品需要约6人月。

![Comparison](/img/blogs/dedicated-operator-8.png)

H-DB案例是一个很好的起点，展示了我们如何利用KubeBlocks解决当前DBaaS系统面临的问题。

### 关于特性合作

我们的下一步是通过KubeBlocks进一步集成更多引擎以进行评估，并升级到新版本的KubeBlocks，评估我们感兴趣的新特性。

在中国移动云中，我们的理想目标是构建统一的云原生DBaaS平台。在这个平台上，我们旨在实现统一的多云架构、API和Operator层的统一接口，支持不同架构的数据库集群，并且数据库实例可以按需部署在无服务器Kubernetes集群上。这将形成一个支持公有云、私有云、专有云、边缘云等不同基础设施的统一数据库编排和通用管理平台。

![Cooperation](/img/blogs/dedicated-operator-9.png)

随着KubeBlocks的持续发展和完善，一旦达到足够的成熟度，我们将考虑基于KubeBlocks框架重构现有的DBaaS引擎。尽管可能涉及初始的重构工作，但从长远来看，我们预计可以节省约50%在不同DB引擎上的开发资源。