---
authors:
  image_url: https://avatars.githubusercontent.com/u/81566017?v=4
  name: Keyu Liang
  url: https://github.com/koriyyy
date: 2024-07-15
description: 本博客介绍如何在5分钟内通过KubeBlocks在Kubernetes上部署高可用Harbor集群。
image: /img/blogs/thumbnails/blog-harbor.png
slug: deploy-harbor-on-kubeblocks
tags:
- Kubernetes
- operator
- PostgreSQL
- Redis
- KubeBlocks
title: 5分钟内在Kubernetes上通过KubeBlocks（PostgreSQL与Redis的Operator）部署高可用Harbor集群
---
# 5分钟内在Kubernetes上通过KubeBlocks（PostgreSQL和Redis的Operator）部署高可用Harbor集群

当需要构建自托管的Docker镜像仓库时，Harbor通常是一个备受推荐的解决方案。然而，**Harbor本身并不内置HA（高可用性）集成**，这使得其服务可靠性相对较低。**要创建HA Harbor集群，开发者通常需要自行搭建HA Redis和PostgreSQL集群**，这一过程相当繁琐。

![Harbor架构图](/img/blogs/blog-harbor-1.png)

图1. [Harbor架构](https://goharbor.io/docs/2.1.0/install-config/harbor-ha-helm/#architecture)

幸运的是，现在您只需几个步骤就能使用KubeBlocks搭建一个高可用的Harbor集群。

## 为什么选择 KubeBlocks

KubeBlocks 是一款开源的管控平面软件，用于在 Kubernetes 上运行和管理数据库、消息队列等数据基础设施，它能够管理多种类型的引擎，包括关系型数据库（MySQL、PostgreSQL）、缓存（Redis）、NoSQL（MongoDB）、消息队列（Kafka、Pulsar）等。

在本篇博客中，我们将介绍如何通过 KubeBlocks 在短短 5 分钟内构建一个高可用的 Harbor 集群。

## 环境准备

在开始之前，请确保您的环境满足 [KubeBlocks](https://kubeblocks.io/docs/preview/user_docs/installation/install-with-kbcli/install-kubeblocks-with-kbcli#environment-preparation) 和 [Harbor](https://goharbor.io/docs/2.11.0/install-config/installation-prereqs/) 的要求。

## 安装 kbcli 和 KubeBlocks

1. 安装 kbcli。

```bash
   curl -fsSL https://kubeblocks.io/installer/install_cli.sh | bash
   ```

2. 安装 KubeBlocks。

```bash
   kbcli kubeblocks install
   ```

3. 检查 KubeBlocks 是否安装成功。

```bash
   kbcli kubeblocks status
   ```

4. 启用 `postgresql` 和 `redis` 插件。默认情况下，这两个插件已启用。您可以通过运行以下命令检查插件状态。如果未启用，请按照[此处指南](https://kubeblocks.io/docs/preview/user_docs/overview/supported-addons#use-addons)进行启用。

```bash
   kbcli addon list
   ```

## 创建 PostgreSQL 和 Redis 集群

1. 为保持环境隔离，创建一个名为 `demo` 的独立命名空间。

```bash
   kubectl create namespace demo
   ```

2. 创建 PostgreSQL 集群。此处我们使用复制模式，该模式会创建一个支持自动故障转移的复制集群。更多详细信息，请参阅[创建 PostgreSQL 集群](https://kubeblocks.io/docs/preview/user_docs/kubeblocks-for-postgresql/cluster-management/create-and-connect-a-postgresql-cluster)。

```bash
   kbcli cluster create postgresql mypg --mode replication --namespace demo
   ```

3. 创建 Redis 集群。此处我们创建一个 Redis 复制集群并指定版本为 `redis-7.0.6`，KubeBlocks 将创建一个带哨兵的主从 Redis 集群。更多详细信息，请参考[创建 Redis 集群](https://kubeblocks.io/docs/preview/user_docs/kubeblocks-for-redis/cluster-management/create-and-connect-a-redis-cluster)。

```bash
   kbcli cluster create redis myredis --mode replication --version redis-7.0.6 --namespace demo
   ```

4. 查看集群状态。等待两个集群的状态都变为 `Running`。

```bash
   kbcli cluster list --namespace demo
   ```




## 连接集群

您也可以根据不同的场景，按照[这里的详细指南](https://kubeblocks.io/docs/preview/api_docs/connect_database/overview-of-database-connection)连接集群。为了方便演示，我们将使用测试环境进行说明。

### 连接 PostgreSQL 集群

1. 连接到 PostgreSQL 集群。

```bash
   kbcli cluster connect mypg --namespace demo
   ```

2. 在 PostgreSQL CLI 中，创建新用户。

```bash
   create user test with password 'password';
   ```

3. 为 Harbor 创建新的数据库注册表。

```bash
   CREATE DATABASE registry OWNER test;
   ```

在此创建的用户和数据库将在后续安装Harbor时使用。

### 连接Redis集群

1. 连接到Redis集群。

```bash
   kbcli cluster connect myredis --namespace demo
   ```

2. 创建用户。

```bash
   ACL SETUSER test on >password ~* +@all
   ```




## 安装 Harbor

1. 下载 Harbor Helm Chart。

```bash
   helm repo add harbor https://helm.goharbor.io

   helm fetch harbor/harbor --untar
   ```

2. 获取集群中服务的信息。`mypg-postgresql` 和 `myredis-redis-redis` 的 ClusterIP 是 Harbor 连接到的地址。

（严格保留原始格式与换行）

```bash
   kubectl get service -n demo
   >
   NAME                                    TYPE           CLUSTER-IP       EXTERNAL-IP    PORT(S)                                                  AGE
   mypg-postgresql                         ClusterIP      172.16.155.121   <none>         5432/TCP,6432/TCP                                        74m
   myredis-redis-redis                     ClusterIP      172.16.190.126   <none>         6379/TCP                                                 66m

3. Configure the PostgreSQL database in `values.yaml`. Use the external database KubeBlocks provides and fill in the necessary database information. For other configurations (e.g. `expose.type`), refer to [the official documentation](https://goharbor.io/docs/2.11.0/install-config/configure-yml-file/).

   ```

bash
   database:
     type: external
     ...
     external:
       host: "172.16.155.121" # PostgreSQL的clusterIP
       port: "5432"
       username: "test"       # 用户名
       password: "password".  # 密码
       coreDatabase: "registry" # 数据库名称
       existingSecret: ""
       sslmode: "disable"

```

4. Configure the Redis database in `values.yaml`.

   ```

bash
   redis:
     type: external
     ...
     external:
       addr: "172.16.190.126:6379" # redis的clusterIp:端口
       sentinelMasterSet: ""
       coreDatabaseIndex: "0"
       jobserviceDatabaseIndex: "1"
       registryDatabaseIndex: "2"
       trivyAdapterIndex: "5"
       username: "test"        # 用户名
       password: "password"    # 密码
       existingSecret: ""

```

5. Install Harbor.

   ```

bash
   helm install myharbor. -n demo

```

6. Check the status of pods. Make sure all services are running.

   ```

bash
   kubectl get pods -n demo
   >
   NAME                                   READY   STATUS    RESTARTS   AGE
   myharbor-core-66d95c9f45-vpcnn         1/1     Running   0          44m
   myharbor-jobservice-85b5676456-kl5r9   1/1     Running   0          44m
   myharbor-nginx-55dd86f5d8-s78gn        1/1     Running   0          44m
   myharbor-portal-869c6656c5-5dtsc       1/1     Running   0          44m
   myharbor-registry-c66cd79b-77k5j       2/2     Running   0          44m
   myharbor-trivy-0                       1/1     Running   0          44m
   mypg-postgresql-0                      4/4     Running   0          65m
   mypg-postgresql-1                      4/4     Running   0          82s
   myredis-redis-0                        3/3     Running   0          57m
   myredis-redis-1                        3/3     Running   0          57m
   myredis-redis-sentinel-0               1/1     Running   0          58m
   myredis-redis-sentinel-1               1/1     Running   0          58m
   myredis-redis-sentinel-2               1/1     Running   0          58m
   ```

现在您可以像往常一样访问 Harbor UI。

## 高可用性

为了展示通过 KubeBlocks 构建的 Harbor 集群的高可用性，我们将模拟 PostgreSQL 集群主 Pod 发生故障的场景。

1. 查看 PostgreSQL 集群及 Pod 的初始状态。当前 `mypg-postgresql-0` 为主 Pod，`mypg-postgresql-1` 为从 Pod。

```bash
   kubectl -n demo get pod -L kubeblocks.io/role
   >
   NAME                                   READY   STATUS    RESTARTS   AGE     ROLE
   ...
   mypg-postgresql-0                      4/4     Running   0          66m     primary
   mypg-postgresql-1                      4/4     Running   0          66m     secondary
   ...
   ```

2. 将测试镜像 `busybox` 推送至 Harbor 镜像仓库。

```bash
   docker docker tag busybox harbor.domain.com/library/busybox
   docker push harbor.domain.com/library/busybox
   ```

3. 您可以看到镜像已成功推送至 Harbor 镜像仓库。

   ![Figure 2](/img/blogs/blog-harbor-2.png)

4. 现在，模拟 PostgreSQL 集群主节点 Pod 的故障。

```bash
   # Enter the primary pod
   kubectl exec -it mypg-postgresql-0 -n demo -- bash

   # Delete the data directory of PostgreSQL to simulate an exception
   root@mycluster-postgresql-0:/home/postgres# rm -fr /home/postgres/pgdata/pgroot/data
   ```

5. 查看日志以观察异常发生时 Pod 角色的切换情况。

```bash
   # View the primary pod logs
   kubectl logs mypg-postgresql-0 -n demo
   ```

在日志中，主节点 Pod 的领导者锁被释放，并发生了高可用切换。已使用备份数据创建了一个新副本。服务在几秒内恢复。

（严格保留原文格式与换行，技术术语按规范翻译）

```bash
   2024-06-26 08:00:51,759 INFO: no action. I am (mypg-postgresql-0), the leader with the lock
   2024-06-26 08:01:01,726 INFO: Lock owner: mypg-postgresql-0; I am mypg-postgresql-0
   2024-06-26 08:01:01,802 INFO: Leader key released
   2024-06-26 08:01:01,824 INFO: released leader key voluntarily as data dir empty and currently leader
   2024-06-26 08:01:01,825 INFO: Lock owner: mypg-postgresql-1; I am mypg-postgresql-0
   ...
   2024-06-26 08:01:04,475 INFO: replica has been created using basebackup_fast_xlog
   2024-06-26 08:01:04,475 INFO: bootstrapped from leader 'mypg-postgresql-1'
   2024-06-26 08:01:04,476 INFO: closed patroni connection to the postgresql cluster
   ```





```bash
   # View secondary pod logs
   kubectl logs mypg-postgresql-1 -n demo
   ```

原从节点 Pod `mypg-postgresql-1` 已获取领导者锁并升级为主节点 Pod。

```bash
   2024-06-26 08:02:13,638 INFO: no action. I am (mypg-postgresql-1), the leader with the lock
   ```

6. 查看 PostgreSQL 集群和 Pod 的状态。故障转移后，`mypg-posgresql-0` 成为从节点 Pod，`mypg-postgresql-1` 成为主节点 Pod。

```bash
   kubectl -n demo get pod -L kubeblocks.io/role
   >
   NAME                                   READY   STATUS    RESTARTS   AGE   ROLE
   ...
   mypg-postgresql-0                      4/4     Running   0          89m   secondary
   mypg-postgresql-1                      4/4     Running   0          26m   primary
   ...
   ```

7. 连接到 PostgreSQL 集群以查看主节点 Pod 中的复制信息。

```bash
   postgres=# select * from pg_stat_replication;
   ```

![Figure 3](/img/blogs/blog-harbor-3.png)

   结果显示 `mypg-postgresql-0` 已被分配为从节点的 Pod。

8. 验证 Harbor 集群的服务。此处我们拉取先前推送的 `busybox` 镜像。该镜像已成功从 Harbor 镜像仓库中拉取。我们还推送了一个新镜像 `hello-world`，该镜像也成功推送至 Harbor 镜像仓库。故障转移后，Harbor 集群的读写功能均已恢复，这证明了 KubeBlocks 提供的高可用性功能的有效性。

   ![Figure 4](/img/blogs/blog-harbor-4.png)

## 扩缩容集群

KubeBlocks 提供垂直扩展和水平扩展两种能力。您可以通过执行以下命令轻松实现集群扩缩容。

- 垂直扩展

```bash
   kbcli cluster vscale mypg \
   --components="postgresql" \
   --memory="4Gi" --cpu="2" \
   --namespace demo
   ```

- 水平扩展

```bash
   kbcli cluster hscale mypg
   --replicas 3 \
   --namespace demo \
   --components postgresql
   ```




## 结论

通过集成 KubeBlocks，您可以在短短 5 分钟内搭建一个高可用性的 Harbor 集群，确保您的 Harbor 集群提供持续可靠的服务。KubeBlocks 简化了整个搭建流程，让您可以专注于更重要的任务，而无需担心底层基础设施的配置和管理。

## 参考

- [KubeBlocks](https://github.com/apecloud/kubeblocks)
- [KubeBlocks.io](https://kubeblocks.io/)
- [KubeBlocks 插件](https://github.com/apecloud/kubeblocks-addons)
- [Harbor](https://github.com/goharbor/harbor/wiki/Architecture-Overview-of-Harbor)