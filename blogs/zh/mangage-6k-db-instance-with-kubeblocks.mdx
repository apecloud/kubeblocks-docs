---
authors:
  name: Jinhu Xie
date: 2024-12-20
description: 本博客分享我们如何利用基于KubeBlocks构建的Sealos，成功管理跨四个可用区的6000多个数据库实例。
image: /img/blogs/thumbnails/blog-manage-6k-db-instance-with-kb.png
slug: manage-6k-db-instance-with-kubeblocks
tags:
- Kubernetes
- KubeBlocks
- database
- large scale
- database instance
title: '管理6000+自托管数据库无需DBA——看单名工程师如何借助KubeBlocks实现这一壮举'
---
# 无专职DBA管理6000+自托管数据库：单工程师如何借助KubeBlocks实现这一壮举

> 关于Sealos
>
> [Sealos](https://sealos.io/) 是一家为中文应用开发者提供基于Kubernetes的PaaS（平台即服务）解决方案的初创企业。Sealos通过提供开箱即用、按量付费的Kubernetes服务，赋能开发者快速构建和部署应用。此外，Sealos还提供包括函数计算、网关、DBaaS（数据库即服务）、MinIO存储以及应用商店等多样化服务。

> 作者：谢金虎，Sealos工程师

让我们从一个问题开始：在没有专业DBA的情况下，单名工程师能否管理超过6000个自托管的数据库集群？

在当今云计算和大规模分布式系统的时代，数据库仍然是众多应用的基石。随着规模的增长，数据库管理的复杂性也随之提升。因此，当面对独自管理数千个数据库实例的任务时，大多数人会说："这不可能！"

然而，这个看似不可能的任务已经在Sealos内部成为现实。Sealos为开发者用户提供基于Kubernetes的PaaS服务，以及包括**MySQL**、**PostgreSQL**、**Redis**、**MongoDB**、**Kafka**和**Milvus**在内的核心DBaaS产品，管理着**横跨四个区域的6000多个数据库实例**。

在本篇博客中，我将分享作为没有DBA背景的K8s工程师，如何通过KubeBlocks在Sealos中成功管理如此庞大数量的数据库，将不可能变为日常运维的现实。

## 大规模管理数据库的挑战

传统上，管理如此庞大的数据库集群需要一支庞大的运维团队和一系列复杂的工具。即使是最小的错误也可能导致服务中断、性能下降，或在最坏情况下造成数据丢失。资源管理、扩缩容、备份、监控、告警和访问控制等任务变得越来越复杂，尤其是在托管多种数据库类型（如 MySQL、PostgreSQL、Redis、MongoDB 等）的多租户环境中。

随着需要管理的数据库实例数量从几十个增长到数千个，复杂性呈指数级上升——不仅在技术挑战方面，还包括运维和组织需求。

大规模管理数据库的挑战包括：

- **日常部署和维护**：诸如次版本升级、配置调整以及扩缩容等任务会变得越来越频繁且耗时。
- **及时处理异常**：备份失败或复制延迟等问题需要立即关注。
- **确保高可用性和灾难恢复**：高可用性依赖于副本、故障转移和备份的协调。然而，当实例数量扩展到数千个时，即使是单个组件故障也可能级联影响整个系统。
- **配置随时间漂移**：手动操作经常导致主机和实例的实际配置与中央存储库中存储的期望配置之间存在差异。
- **成本考量**：管理大规模数据库通常需要一支庞大的运维团队，使得人力资源成本成为重要瓶颈。

传统的运维方法已不足以应对这些挑战。必须借助新技术和基于平台的工具来重新设计和简化数据库管理流程。

## Sealos 如何简化数据库管理？

Sealos 提供了一个强大且灵活的 DBaaS 平台，供用户可视化地管理和使用各类数据库。它支持统一管理 **MySQL**、**PostgreSQL**、**Redis**、**MongoDB**、**Kafka** 和 **Milvus**。该平台通过资源管理、扩缩容、集成监控和告警系统等工具简化数据库操作，确保高可用性、自动化故障转移以及灵活的备份与恢复功能。适用于开发和生产环境。

下表总结了截至 2024 年 12 月，Sealos 在各区域为客户提供的数据库实例分布情况。

| 可用区         | 实例数量 |
| :------------: | :------: |
| 新加坡可用区    | 1137     |
| 杭州可用区      | 3387     |
| 广州可用区      | 405      |
| 北京可用区      | 1014     |

Sealos 以 **K8s 和 KubeBlocks** 为基础，实现自动化数据库管理的核心功能。熟悉 Kubernetes 的工程师可以使用 **KubeBlocks Operator** 高效管理数据库。通过 **KubeBlocks** 管理大规模数据库实例，解决了日常维护、异常处理、高可用性、配置一致性和成本优化等挑战。以下是 KubeBlocks 如何有效解决这些问题：

### 日常部署与维护

**挑战：**

随着实例数量增长，版本升级、配置变更和扩缩容等日常任务变得繁重。

**KubeBlocks 解决方案：**

- **声明式管理**：使用 Kubernetes 原生的 CRD（自定义资源定义），用户可以定义数据库的期望状态（如版本、副本数、配置）。KubeBlocks 确保实际状态始终与期望状态一致。
- **自动化工作流**：KubeBlocks 为滚动升级、扩缩容和配置更新等常见任务提供内置自动化。这些工作流确保在数千个实例中执行时，停机时间最短且操作一致。

### 及时处理异常

**挑战：**

备份失败、复制延迟或意外崩溃等问题需要立即检测和响应，以防止级联故障。

**KubeBlocks 解决方案：**

- **自愈能力**：KubeBlocks 自动化故障转移和恢复流程，减少人工干预。例如，如果副本节点不健康，KubeBlocks 可以自动从健康节点重新创建。
- **实时监控与告警**：KubeBlocks 与 Prometheus 和 Grafana 等监控工具集成，提供数据库状态、复制健康和备份流程的实时指标与告警。
- **集中式异常管理**：所有数据库活动日志和告警集中管理，便于运维人员快速分析和解决问题。

### 确保高可用性与灾难恢复

**挑战：**

在大规模系统中协调复制、故障转移和备份非常复杂，单个故障可能引发连锁反应。

**KubeBlocks 解决方案：**

- **内置高可用性**：KubeBlocks 通过自动化副本管理、领导者选举和故障转移机制（适用于 MySQL、PostgreSQL 和 MongoDB 等数据库），简化高可用性（HA）环境搭建。
- **备份与恢复自动化**：KubeBlocks 与外部存储（如对象存储或 NFS）集成，自动化备份并确保故障时快速恢复。定时备份和按时间点恢复选项优化了灾难恢复流程。

### 解决配置漂移问题

**挑战：**

人工操作常导致实际配置与期望配置不一致，可能引发意外行为或停机。

**KubeBlocks 解决方案：**

- **统一配置管理**：KubeBlocks 使用存储在中央仓库的声明式配置文件。这些配置在所有实例间保持一致应用，消除了人为错误。
- **漂移检测与调和**：KubeBlocks 持续监控数据库实例的实际配置，并与期望状态进行比对。若检测到配置漂移，系统会自动调和差异，确保一致性。
- **版本控制**：配置文件和变更均受版本控制，运维人员可追踪变更记录，必要时回滚至先前配置。

### 成本优化

**挑战：**

管理数千个数据库实例通常需要庞大的运维团队，人力资源成为主要成本驱动因素。

**KubeBlocks 解决方案：**

- **运维效率**：通过自动化日常维护、异常处理和扩缩容操作，KubeBlocks 显著减少人工干预需求，使小型团队即可管理数千个实例。

## 工作原理：核心架构与设计

至此，您可能想知道：**KubeBlocks 如何使 Sealos 能够提供如此广泛的 DBaaS 服务**？让我们探讨其支持多种数据库的**核心设计原则**，重点关注其灵活的**高可用性架构**和**全面的备份恢复机制**。

## KubeBlocks 架构

![KubeBlocks 架构](/img/blogs/manage-6k-db-instances-1.png)

KubeBlocks 的架构围绕模块化组件设计，旨在简化在 Sealos 等 PaaS 平台上提供数据库托管服务的复杂性。它提供用户友好的接口（如 `kbcli`、`kubectl` 和 Argo CD），这些接口与强大的核心 API 相连。该平台支持超过 30 种数据库和中间件插件，具有高度的灵活性。通过内置的 **Cluster**、**Component** 和 **InstanceSet** 等控制器，用户只需管理高层 API，而 Operator 会自动处理底层复杂性。这显著降低了技术门槛，使平台即使对非数据库专家也易于使用。

### 高可用机制

不同的数据库对高可用性的内置支持程度各不相同。为此，KubeBlocks 支持两种常见的高可用模型：**基于仲裁**和**主从复制**，能够灵活适应不同数据库的特性和需求。

1. **基于仲裁的高可用模型**：

    对于支持分布式一致性的数据库（如 Kafka 和 MongoDB），这些数据库通过仲裁机制确保高可用性和一致性。在仲裁模型中，数据库节点通过选举过程实现分布式一致性，通常需要多数节点（即仲裁）达成共识才能进行写入或选举新的主节点。即使部分节点发生故障，只要维持仲裁，集群仍可正常运行。

    KubeBlocks 通过健康检查持续监控数据库节点状态（如领导者、跟随者或副本），管理角色检测、角色转换和副本重建。如果节点变得不健康，KubeBlocks 会启动角色转换或副本恢复以维持仲裁和一致性。当故障节点恢复或被替换时，KubeBlocks 会从健康节点同步数据并确保节点完全更新后重新加入集群，自动完成副本重建。

2. **主从复制高可用模型**：

    **主从高可用模型**常见于传统数据库，如 **MySQL**、**PostgreSQL** 和 **Redis**。这些数据库依赖主节点处理写请求，同时一个或多个副本节点同步数据以提供读取扩展性并确保高可用性。

    KubeBlocks 通过自动化关键流程（如角色检测、高可用决策、故障转移、副本重建和角色转换）简化和增强了主从设置。它通过健康检查持续监控数据库节点（如主节点和副本）。在节点故障期间，它会通过将最新的副本提升为新主节点来自动执行故障转移，确保数据一致性（使用 MySQL 二进制日志或 PostgreSQL 流复制等机制）。它会更新集群连接端点（如 Kubernetes 服务或 DNS）以实现无缝应用连接。KubeBlocks 还会在故障后自动重建副本。

![高可用机制 1](/img/blogs/manage-6k-db-instances-2.png)
![高可用机制 2](/img/blogs/manage-6k-db-instances-3.png)

KubeBlocks 还支持第三方高可用解决方案。例如：

1. **MySQL**：KubeBlocks 支持通过 **Orchestrator** 管理 MySQL 高可用性。
2. **PostgreSQL**：KubeBlocks 支持通过 **Patroni** 管理 PostgreSQL 高可用性，使用 **Noop** 作为故障转移策略。
3. **Redis**：除了 Redis Cluster，KubeBlocks 还集成了 Redis Sentinel 作为复制集群的高可用解决方案，将 Sentinel 作为独立组件部署在 Redis 复制拓扑中。

KubeBlocks 支持可变数量的副本。对于关键业务数据库，增加副本数量可以提升可靠性和可用性，显著降低数据丢失风险。

### 备份与恢复机制

KubeBlocks 通过将备份文件存储在外部 BackupRepo（如对象存储或 NFS）中，提供强大的备份与恢复能力，确保数据安全可靠。它支持按需备份和定时备份，提供磁盘快照备份以及 MySQL XtraBackup、PostgreSQL pg_basebackup 等数据库专用工具选项。通过支持全量备份和增量备份，KubeBlocks 能够从 BackupRepo 实现时间点恢复（PITR），在灾难发生时将数据恢复到特定时间点。

备份流程如下图所示：

![Backup Process](/img/blogs/manage-6k-db-instances-4.png)

与 KubeBlocks 集成的 Sealos 平台，通过提供高效的备份与恢复能力，增强了生产环境中的数据保护。它有效支持数据防丢失、灾难恢复和历史数据检索等场景。

### 迁移设计

开发者经常需要将外部数据库迁移至 Sealos，或在多个 Sealos 区域间转移数据库。KubeBlocks 企业版使用开源数据迁移工具 [Ape-DTS](https://github.com/apecloud/ape-dts) 实现无缝的数据库迁移流程。Ape-DTS 支持跨多种开源数据库的数据同步，非常适合在线实时数据迁移。

![Ape-DTS Architecture](/img/blogs/manage-6k-db-instances-5.png)

迁移工作流：

1. **源数据库（Source DB）**：提供待迁移的数据。
2. **提取器（Extractor）**：通过 CDC（变更数据捕获）从源数据库提取全量和增量数据。
3. **数据管道（Data Pipeline）**：
    - **队列（Queue）**：临时存储提取的数据，支持断点续传。
    - **并行处理器（Parallelizer）**：并行处理任务以提高效率。
    - **写入器（Sinker）**：将数据写入目标数据库。
4. **目标数据库（Target DB）**：作为迁移数据的最终目的地。

## 总结

KubeBlocks 将数据库管理转变为一种高效、全自动化的流程。它不仅降低了时间和成本，还大幅简化了运维操作。无论您是开发人员、平台工程师还是系统管理员，都能轻松高效地管理大规模数据库集群。